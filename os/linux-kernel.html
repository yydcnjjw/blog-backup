<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-04-07 日 22:31 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="yydcnjjw" />
<link rel="stylesheet" href="https://yydcnjjw.github.io/style/style.css" type="text/css">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd7dc818">1. Booting</a>
<ul>
<li><a href="#orged3012d">1.1. BIOS 阶段</a></li>
<li><a href="#org3230639">1.2. 引导程序</a>
<ul>
<li><a href="#org024c98b">1.2.1. GRUB</a></li>
<li><a href="#orgb349055">1.2.2. GRUB 映像的构成</a></li>
<li><a href="#org17b43d5">1.2.3. 加载内核和 initramfs</a></li>
</ul>
</li>
<li><a href="#org4b49238">1.3. 引导协议</a>
<ul>
<li><a href="#org3ef9f74">1.3.1. 内存布局</a></li>
<li><a href="#orgf364b5d">1.3.2. 16 位引导协议</a></li>
<li><a href="#org6309621">1.3.3. 32 位引导协议</a></li>
<li><a href="#org63ba7f9">1.3.4. 64 位引导协议</a></li>
</ul>
</li>
<li><a href="#org5ff7591">1.4. 内核代码的入口</a>
<ul>
<li><a href="#org8812f30">1.4.1. startup_32</a></li>
<li><a href="#orgf1acd06">1.4.2. startup_64</a></li>
<li><a href="#orgd6712ca">1.4.3. init_size 的计算</a></li>
<li><a href="#orgfcba340">1.4.4. 解压缩内核</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org347bd8a">2. Initialization</a>
<ul>
<li><a href="#orga2c47f5">2.1. arch/x86/kernel/head_64.S:startup_64</a></li>
<li><a href="#org4c7017f">2.2. arch/x86/kernel/head64.c:x86_64_start_kernel</a>
<ul>
<li><a href="#orgdd33fcd">2.2.1. 早期的中断处理</a></li>
</ul>
</li>
<li><a href="#org7088c6d">2.3. init/main.c:start_kernel</a></li>
<li><a href="#org90c37bf">2.4. x86_init_ops</a></li>
</ul>
</li>
<li><a href="#org236066b">3. Memory management</a>
<ul>
<li><a href="#org184e72f">3.1. Paging</a>
<ul>
<li><a href="#orgb56b3af">3.1.1. arch x86</a></li>
</ul>
</li>
<li><a href="#org5c5a8e0">3.2. Memblock</a></li>
<li><a href="#orgf22d65f">3.3. ioremap</a></li>
<li><a href="#org1c4d231">3.4. mm_struct</a></li>
<li><a href="#orgbd5663f">3.5. DMA</a></li>
<li><a href="#org6cf171a">3.6. SLAB</a>
<ul>
<li><a href="#org0a8c7fc">3.6.1. <code>kmem_cache</code></a></li>
</ul>
</li>
<li><a href="#org6b0c32e">3.7. SLUB</a></li>
</ul>
</li>
<li><a href="#org98ba58e">4. Interrupts</a>
<ul>
<li><a href="#org6b155a3">4.1. exception-tables</a>
<ul>
<li><a href="#orgdc35f59">4.1.1. <code>__ex_table</code> 结构</a></li>
</ul>
</li>
<li><a href="#org0aa9f62">4.2. early interrupt handler</a></li>
<li><a href="#orgfbb1be9">4.3. interrupt handler function</a>
<ul>
<li><a href="#org937c057">4.3.1. interrelated macro</a></li>
<li><a href="#org421af98">4.3.2. <code>early_idt_handler_array</code></a></li>
<li><a href="#orgd0c1598">4.3.3. <code>early_ignore_irq</code></a></li>
<li><a href="#orgf9e5170">4.3.4. <code>debug</code></a></li>
<li><a href="#org9e7e9bd">4.3.5. <code>int3</code></a></li>
<li><a href="#org08449b3">4.3.6. <code>page_fault</code></a></li>
</ul>
</li>
<li><a href="#orgf0f5ba5">4.4. external interrupts</a></li>
</ul>
</li>
<li><a href="#org56dff23">5. Syscall</a>
<ul>
<li><a href="#orge349abb">5.1. implement</a>
<ul>
<li><a href="#org78882a6">5.1.1. entry_SYSCALL_64</a></li>
</ul>
</li>
<li><a href="#org8101cab">5.2. initialization</a></li>
<li><a href="#org5edf0ae">5.3. vsyscall and vDSO</a>
<ul>
<li><a href="#org1d900f1">5.3.1. vsyscall</a></li>
<li><a href="#org868f692">5.3.2. vDSO</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org7f69fc5">6. Synchronization primitives</a>
<ul>
<li><a href="#orga267532">6.1. Spinlock</a>
<ul>
<li><a href="#org8cc3bf8">6.1.1. normal spinlock</a></li>
<li><a href="#orgc78eca0">6.1.2. ticket spinlock</a></li>
<li><a href="#orgb800b31">6.1.3. queue spinlock(MCS lock)</a></li>
<li><a href="#orgc95fd91">6.1.4. related operations</a></li>
</ul>
</li>
<li><a href="#org390ae0d">6.2. Semaphores</a></li>
<li><a href="#orgbd91d03">6.3. Mutex</a></li>
<li><a href="#org6e4148a">6.4. Reader/Writer semaphore</a></li>
<li><a href="#org112d9bc">6.5. SeqLock</a></li>
<li><a href="#orgab7631d">6.6. RCU</a></li>
<li><a href="#orga34369a">6.7. Completions</a></li>
<li><a href="#org9a571f7">6.8. Locking Traps</a></li>
<li><a href="#orgf3f961b">6.9. Sleep</a>
<ul>
<li><a href="#orged98472">6.9.1. How a process sleeps</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org43189ee">7. SMP</a>
<ul>
<li><a href="#org4c329b5">7.1. cpu_dev</a></li>
<li><a href="#org30ab669">7.2. Per-CPU</a>
<ul>
<li><a href="#orgbb2488a">7.2.1. Create per-cpu variables</a></li>
<li><a href="#org1cc136e">7.2.2. per-cpu operate</a></li>
<li><a href="#orgb67039d">7.2.3. per-cpu areas initialization process</a></li>
</ul>
</li>
<li><a href="#orgf80e759">7.3. Cpumasks</a></li>
</ul>
</li>
<li><a href="#org2b6b479">8. Drive</a></li>
<li><a href="#org25a4dbf">9. Networking</a>
<ul>
<li><a href="#org7c6294b">9.1. Netlink Sockets</a>
<ul>
<li><a href="#org04c32ef">9.1.1. Netlink advantages</a></li>
<li><a href="#orgb59998f">9.1.2. Kernel Netlink Sockets</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga0b7511">10. Timers and time management</a>
<ul>
<li><a href="#org1a20f0d">10.1. jiffy</a></li>
<li><a href="#orgd12a65e">10.2. clocksource</a>
<ul>
<li><a href="#orgad18322">10.2.1. clocksource register</a></li>
<li><a href="#org3ad7ec6">10.2.2. x86 clocksource</a></li>
<li><a href="#org7f48bd4">10.2.3. clocksource_sysfs</a></li>
</ul>
</li>
<li><a href="#org63c3778">10.3. Reducing Scheduling-Clock Ticks</a>
<ul>
<li><a href="#org5f6a20a">10.3.1. dyntick</a></li>
</ul>
</li>
<li><a href="#orgae91c18">10.4. clock events device</a></li>
<li><a href="#org8f4f8bb">10.5. tick broadcast</a></li>
<li><a href="#orgb6f813b">10.6. Timers</a></li>
</ul>
</li>
<li><a href="#org5763fc2">11. Misc</a>
<ul>
<li><a href="#orgb757cca">11.1. linux 构建过程</a>
<ul>
<li><a href="#orgd7e3348">11.1.1. linux kernel Makefile 文件组成</a></li>
<li><a href="#orgb096d82">11.1.2. Kbuild</a></li>
<li><a href="#org1246178">11.1.3. 根目录 Makefile 分析</a></li>
</ul>
</li>
<li><a href="#orga2ad718">11.2. linux kernel rootfs</a>
<ul>
<li><a href="#org64c102e">11.2.1. grub</a></li>
<li><a href="#orga23027c">11.2.2. busybox + qemu</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgd7dc818" class="outline-2">
<h2 id="orgd7dc818"><span class="section-number-2">1</span> Booting</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orged3012d" class="outline-3">
<h3 id="orged3012d"><span class="section-number-3">1.1</span> BIOS 阶段</h3>
<div class="outline-text-3" id="text-1-1">
<ol class="org-ol">
<li>加电启动时： CPU RESET，初始化寄存器，执行物理地址 <code>0xfffffff0</code> 处代码(BIOS，实地址模式)。(<b><b>硬件把这个地址映射到 ROM BIOS 里</b></b>)。</li>
<li>POST(Power-On Self-Test，上电自检)：对计算机硬件执行一系列的测试，用来检测现在都有什么设备以及这些设备是否正常工作。在这个阶段中，会显示一些信息，例如 BIOS 版本号。</li>
</ol>

<blockquote>
<p>
注：如今的 80x86、AMD64 和 Itanium 计算机使用高级配置与开机界面(Advanced Configuration and Power Interface，ACPI)标准。在 ACPI 兼容的 BIOS 中，启动代码会建立几个表来描述当前系统中的硬件设备。这些表的格式独立于设备生产商，而且可由操作系统读取以获得如何调用这些设备的信息。
</p>
</blockquote>

<ol class="org-ol">
<li>初始化硬件设备：这个阶段在现代基于 PCI 的体系结构中相当重要，因为它可以保证所有的硬件设备操作不会引起 IRQ 线与 I/O 端口的冲突。在本阶段的最后，会显示系统中所安装的所有 PCI 设备的一个列表。</li>
<li>搜索一个操作系统来启动：实际上，根据 BIOS 的设置，这个过程可能要试图访问（按照用户预定义的次序）系统中软盘、硬盘和 CD-ROM 的第一个扇区(<b>*引导扇区，MBR *</b>)。</li>
<li>载入代码：只要找到一个有效的设备，就把第一个扇区的内容拷贝到 RAM 中从物理地址 <code>0x00007c00</code> 开始的位置，然后跳转到这个地址处，开始执行刚才装载进来的代码。</li>
</ol>
</div>
</div>

<div id="outline-container-org3230639" class="outline-3">
<h3 id="org3230639"><span class="section-number-3">1.2</span> 引导程序</h3>
<div class="outline-text-3" id="text-1-2">
<p>
引导装入程序(boot loader)是由 BIOS 用来把操作系统的内核映像装载到 RAM 中所调用的一个程序。
</p>
</div>

<div id="outline-container-org024c98b" class="outline-4">
<h4 id="org024c98b"><span class="section-number-4">1.2.1</span> GRUB</h4>
<div class="outline-text-4" id="text-1-2-1">

<div class="figure">
<p><img src="image/引导/1528762437_356548471_2018-07-29_20-40-23-.png" alt="1528762437_356548471_2018-07-29_20-40-23-.png" />
</p>
<p><span class="figure-number">Figure 1: </span>GRUB 启动过程</p>
</div>

<p>
当跳转到 0x7c00 后，GRUB 开始执行：
</p>
<ol class="org-ol">
<li>boot.img 加载 diskboot.img
<ol class="org-ol">
<li>boot.img 使用 BIOS 中断 <code>0x13</code> 加载 diskboot.img。</li>
<li>BIOS 首先将 diskboot.img 读到 <code>0x7000</code> (BIOS 读缓存， <code>GRUB_BOOT_MACHINE_BUFFER_SEG</code> )处。</li>
<li>boot.img 将其移动内存 <code>0x8000</code> ( <code>GRUB_BOOT_MACHINE_KERNEL_ADDR</code> ) 处。</li>
</ol></li>
<li>diskboot.img 加载 core.img。
<ol class="org-ol">
<li>diskboot.img 使用 BIOS 中断 <code>0x13</code> 加载 core.img。</li>
<li>BIOS 将 core.img 读到 <code>0x70000</code> (BIOS 读缓存) 处。</li>
<li>diskboot.img 将其移动内存 <code>0x8200</code> 处。</li>
<li>执行 lzma_decompress.img。</li>
</ol></li>
<li>core.img 自解压：lzma_decompress.img 将 core.img 解压到内存 <code>GRUB_MEMORT_MACHINE_DECOMPRESSION_ADDR(0x100000)</code> 处。解压函数 <code>_LzmaDecodeA</code> 定义在 <code>lzma_decode.S</code> 中。</li>
<li><p>
kernel.img 将自己复制回 <code>0x9000</code> ：因为 Linux 内核和 initramfs 可能被加载到内存从 1MB 开始的任何地方，所以 GRUB 要给他们指路，所以 GRUB 虽然使用了 1MB 以上的区域作为解压使用的缓冲区，但是解压后要移动回 1MB 以下的部分。
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">/* </span><span class="org-comment">grub/grub-core/kern/i386/pc/startup.S */</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#31227;&#21160; kernel.img &#30340;&#20195;&#30721;&#22312; kernel.img &#30340;&#24320;&#22836;&#25991;&#20214; startup.S</span>
<span class="org-function-name">_start</span>:
<span class="org-function-name">__start</span>:
<span class="org-keyword">.code32</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">...</span>
        <span class="org-keyword">movl</span>    <span class="org-variable-name">%ecx</span>, (LOCAL(real_to_prot_addr) - _start) (<span class="org-variable-name">%esi</span>)
        <span class="org-keyword">movl</span>    <span class="org-variable-name">%edi</span>, (LOCAL(prot_to_real_addr) - _start) (<span class="org-variable-name">%esi</span>)
        <span class="org-keyword">movl</span>    <span class="org-variable-name">%eax</span>, (EXT_C(grub_realidt) - _start) (<span class="org-variable-name">%esi</span>)
        <span class="org-keyword">movl</span>    $(_start), <span class="org-variable-name">%edi</span>
        <span class="org-keyword">rep</span>
<span class="org-function-name">movsb</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">...</span>
        <span class="org-keyword">movl</span>    $LOCAL (cont), <span class="org-variable-name">%esi</span>
        <span class="org-keyword">jmp</span>     *<span class="org-variable-name">%esi</span>
        <span class="org-keyword">LOCAL</span>(cont):
        <span class="org-keyword">subl</span>    <span class="org-variable-name">%edi</span>, <span class="org-variable-name">%ecx</span>

        <span class="org-comment-delimiter">/* </span><span class="org-comment">clean out */</span>
        <span class="org-keyword">xorl</span>    <span class="org-variable-name">%eax</span>, <span class="org-variable-name">%eax</span>
        <span class="org-keyword">cld</span>
        <span class="org-keyword">rep</span>
        <span class="org-keyword">stosb</span>
        <span class="org-keyword">movl</span>    <span class="org-variable-name">%edx</span>, EXT_C(grub_boot_device)

        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">        *  Call the start of main body of C code.</span>
<span class="org-comment">        */</span>
        <span class="org-keyword">call</span> EXT_C(grub_main)
</pre>
</div>

<ol class="org-ol">
<li>startup.S 调用 x86 的指令 <code>movsb</code> 移动映像。</li>
<li><code>esi</code> 是移动的源地址 <code>(0x100000)</code>, <code>edi</code> 是移动的目的地址(被设置为 <code>_start</code> 的地址 <code>0x9000</code> )</li>
<li><code>ecx</code> 是移动的字节数，startup.S 只移动从 <code>_edata</code> (表示 kernel.img 的数据段结束) 到 <code>_start</code> 的指令和数据，表示 startup.S 只是将 kernel.img 移动到 <code>0x9000</code> 并没有移动模块(模块需要重定向)。</li>
<li>移动完 kernel.img 后，startup.S 使用跳转指令 <code>jmp</code> 到移动后的位置继续执行，然后调用 <code>grub_main</code> 进入 c 语言写的核心部分。</li>
<li><p>
<code>grub_main</code> 调用函数 <code>grub_load_modules</code> 装配模块，然后调用 <code>grub_load_normal_mode</code> 加载 normal 模块
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">Grub/grub-core/kern/main.c</span>
<span class="org-type">void</span> <span class="org-keyword">__attribute__</span> ((noreturn))
<span class="org-function-name">grub_main</span> (<span class="org-type">void</span>)
{
    <span class="org-comment-delimiter">//</span><span class="org-comment">...</span>
    grub_load_modules ();
    <span class="org-comment-delimiter">//</span><span class="org-comment">...</span>
    grub_load_normal_mode ();
}
</pre>
</div></li>
</ol></li>
</ol>
</div>
</div>

<div id="outline-container-orgb349055" class="outline-4">
<h4 id="orgb349055"><span class="section-number-4">1.2.2</span> GRUB 映像的构成</h4>
<div class="outline-text-4" id="text-1-2-2">
<ul class="org-ul">
<li>由于现代操作系统的复杂性，Bootloader 仅仅一个扇区已经不够了，GRUB 将除 MBR 里的部分代码"嵌入"到 MBR 和第一个分区之间的 <b>空闲区域</b> ，这相对比较安全。</li>
<li>空闲区域的大小是有限的，GRUB 采用了模块化的设计方案，来控制嵌入到空闲区域的大小。</li>
<li><p>
MBR 将映像分为三个部分：MBR 中的 boot.img、嵌入空闲扇区的 core.img 和 存储在文件系统的模块。
</p>


<div class="figure">
<p><img src="image/引导/1528763697_1065589286_2018-07-30_19-40-01-.png" alt="1528763697_1065589286_2018-07-30_19-40-01-.png" />
</p>
<p><span class="figure-number">Figure 2: </span>在MBR分区模式下以嵌人方式安装的GRUB</p>
</div>

<ul class="org-ul">
<li>boot.img 和 core.img：使用读写磁盘扇区的方式访问</li>
<li>模块：使用文件系统访问</li>
</ul></li>
</ul>
</div>

<ol class="org-ol">
<li><a id="orgcd1f9b0"></a>MBR 映像 (boot.img)<br />
<div class="outline-text-5" id="text-1-2-2-1">
<p>
boot.img 主要功能将 core.img 中的第一个扇区载入内存。
</p>
<ul class="org-ul">
<li>保存 core.img 的第一个扇区的位置，kernel_sector 处，即 <code>GRUB_BOOT_MACHINE_KERNEL_SECTOR(0x5c)</code> 处。</li>
<li>boot.img 使用 BIOS 提供的中断向量 <code>0x13(基于扇区的磁盘读写服务)</code> ，以支持 LBA 模式的磁盘为例：
BIOS 将地址 <code>kernel_sector</code> 处指示的扇区号所在的扇区(一个扇区)的内容载入内存，boot.img 把读入的扇区内容移动到符号 <code>kernel_address</code> 处指示的地址，并跳转到 <code>kernel_address</code> 执行。</li>
<li><code>kernel_address</code> 的值为宏 <code>GRUB_BOOT_MACHINE_KERNEL_ADDR(0x8000)</code></li>
</ul>
</div>
</li>

<li><a id="orgb6d2643"></a>GRUB 核心映像(core.img)<br />
<div class="outline-text-5" id="text-1-2-2-2">
<p>
core.img 包括多个映像和模块，以从硬盘启动为例：
</p>


<div class="figure">
<p><img src="image/引导/1528763923_92428418_2018-07-30_19-48-12-.png" alt="1528763923_92428418_2018-07-30_19-48-12-.png" />
</p>
<p><span class="figure-number">Figure 3: </span>core.img 构成示意图</p>
</div>

<ul class="org-ul">
<li><p>
diskboot.img：diskboot.img 用来加载 core.img 中除 diskboot.img 外的其余部分。占据 core.img 中的第一个扇区(boot.img 加载的 core.img 的第一个扇区)。
在 GRUB 安装时，会将 core.img 占据的扇区号写入 diskboot.img 中。
</p>


<div class="figure">
<p><img src="image/引导/image18_2018-07-30_19-52-46.png" alt="image18_2018-07-30_19-52-46.png" />
</p>
</div>

<ul class="org-ul">
<li>GRUB_BOOT_MACHINE_KERNEL_SEG(0x800)：类似带参数的宏，对于使用 x86 架构的PC，MACHINE 会被替换为 I386_PC，表示将 core.img 其余部分载入到 0x8200 处。</li>
<li>diskboot.img 的最后 12 字节记录的是一个 <code>blocklist</code> (代表一个连续的扇区)
<ul class="org-ul">
<li><code>start</code> ：起始扇区</li>
<li><code>len</code> ：扇区的数量</li>
<li><p>
<code>segment</code> ：扇区加载到内存的段地址
</p>


<div class="figure">
<p><img src="image/引导/image20_2018-07-30_19-54-36.png" alt="image20_2018-07-30_19-54-36.png" />
</p>
</div></li>
</ul></li>
</ul></li>

<li>为了控制 core.img 的体积，GRUB 将 core.img 进行了压缩(kernel.img 和模块)
<ul class="org-ul">
<li>对于基于 x86 架构的 PC，GRUB 默认使用的是 lzma 压缩算法。</li>
<li>GRUB 将 lzma 算法的解压缩代码编译为 lzma_decompress.img，连接在 diskboot.img 的后面，diskboot.img 将 core.img 加载进内存后，将跳转到 lzma_decompress.img：</li>
</ul></li>
<li>kernel.img 的主入口函数是 <code>grub_main</code></li>
<li>鉴于嵌入区域的尺寸有限，因此只有关键的模块才能包含到 core.img 中，即文件系统模块(只有支持文件系统，才可以读入其他模块)。</li>
</ul>

<blockquote>
<p>
注：文件系统模块载入内存还需要重定向(grub_load_modules 函数)。
</p>
</blockquote>
</div>
</li>
</ol>
</div>

<div id="outline-container-org17b43d5" class="outline-4">
<h4 id="org17b43d5"><span class="section-number-4">1.2.3</span> 加载内核和 initramfs</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
grub 根据下列参数确定加载位置
</p>

<ul class="org-ul">
<li><code>pref_address(引导参数，默认0x1000000)</code> ：支持重定向。</li>
<li><code>GRUB_LINUX_BZIMAGE_ADDR(0x100000)</code> ：不支持重定向。</li>
</ul>
<p>
然后计算保护模式的内核尺寸将其加载到加载位置。
</p>

<ol class="org-ol">
<li>normal 模块读取并解析 GRUB 配置文件 grub.cfg(一般在 <code>/boot/grub/grub.cfg</code>)</li>
<li>grub.cfg 根据里面的具体命令，加载相应的模块(命令和模块的关系记录在 command.lst 中，一般在 <code>/boot/grub/i386-pc</code>)</li>
</ol>

<blockquote>
<p>
加载内核及 initramfs
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">grub/grub-core/loader/i386/linux.c 1140&#34892;</span>
<span class="org-function-name">GRUB_MOD_INIT</span>(linux)
{
  cmd_linux = grub_register_command (<span class="org-string">"linux"</span>, grub_cmd_linux,
                                     <span class="org-highlight-numbers-number">0</span>, N_(<span class="org-string">"Load Linux."</span>));
  cmd_initrd = grub_register_command (<span class="org-string">"initrd"</span>, grub_cmd_initrd,
                                      <span class="org-highlight-numbers-number">0</span>, N_(<span class="org-string">"Load initrd."</span>));
  my_mod = mod;
}
</pre>
</div>

<ul class="org-ul">
<li>命令 <code>linux</code> 负责加载内核，回调函数是 <code>grub_cmd_linux</code> ，执行操作如下:
<ol class="org-ol">
<li>确认内核希望加载的地址，如果支持重定位，读取 <code>pref_address</code> (默认 <code>0x1000000</code>) 作为内核加载位置。否则加载到位置 <code>GRUB_LINUX_BZIMAGE_ADDR(0x100000)</code></li>
<li>调用 <code>allocate_pages</code> 为内核映像分配内存，同时设置指针 <code>prot_mode_mem</code> 指向内核分配的内存，变量 <code>prot_mode_target</code> 设为该内存的地址</li>
<li>修改引导参数成员 <code>code32_start(0x100000)</code> 为 <code>prot_mode_target</code> (考虑特殊情况)。</li>
<li><p>
计算实模式部分的尺寸(由于不需要加载实模式部分)，定位保护模式开始的地方，确定保护模式的尺寸。
</p>

<div class="org-src-container">
<pre class="src src-C">real_size = setup_sects &lt;&lt; GRUB_DISK_SECTOR_BITS;
prot_file_size = grub_file_size (file) - real_size - GRUB_DISK_SECTOR_SIZE;
</pre>
</div></li>

<li>加载内核(不包含实模式部分的内核)，使用文件系统驱动提供的接口 <code>grub_file_read</code> 。</li>
</ol></li>
<li>命令 <code>initrd</code> 负责加载 initramfs，回调函数是 <code>grub_cmd_initrd</code>
<ol class="org-ol">
<li>确定加载的位置。</li>
<li>调用 <code>grub_relocator_alloc_chunk_align</code> 指定范围内找一个合适位置(GRUB 采用的策略是尽可能将 initramfs 加载到高地址处)</li>
<li>将指针 <code>initrd_mem</code> 指向加载 initramfs 分配的内存，并将这块内存的物理地址记录到变量 <code>initrd_mem_tartget</code> 中。</li>
<li>加载内核到内存 <code>initrd_mem</code> 处，考虑存在多个 initrd 使用 for 循环。</li>
<li><p>
将 initramfs 的尺寸、加载的位置记录到引导参数中。
</p>

<blockquote>
<p>
将控制权交给内核: GRUB 将记录引导参数的全局变量放置到传统的实模式占据的位置。然后通过一个长跳转(<code>code32_start</code>)，GRUB 将控制全交给了内核(<code>arch/x86/boot/compressed/head_64.S ENTRY(startup_32)</code>)。
</p>
</blockquote></li>
</ol></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org4b49238" class="outline-3">
<h3 id="org4b49238"><span class="section-number-3">1.3</span> 引导协议</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-org3ef9f74" class="outline-4">
<h4 id="org3ef9f74"><span class="section-number-4">1.3.1</span> 内存布局</h4>
<div class="outline-text-4" id="text-1-3-1">
<pre class="example">
        ~                        ~
        |  Protected-mode kernel |
100000  +------------------------+
        |  I/O memory hole       |
0A0000  +------------------------+
        |  Reserved for BIOS     |        Leave as much as possible unused
        ~                        ~
        |  Command line          |        (Can also be below the X+10000 mark)
X+10000 +------------------------+
        |  Stack/heap            |        For use by the kernel real-mode code.
X+08000 +------------------------+
        |  Kernel setup          |        The kernel real-mode code.
        |  Kernel boot sector    |        The kernel legacy boot sector.
X       +------------------------+
        |  Boot loader           |        &lt;- Boot sector entry point 0000:7C00
001000  +------------------------+
        |  Reserved for MBR/BIOS |
000800	+------------------------+
        |  Typically used by MBR |
000600  +------------------------+
        |  BIOS use only         |
000000  +------------------------+
</pre>
</div>
</div>

<div id="outline-container-orgf364b5d" class="outline-4">
<h4 id="orgf364b5d"><span class="section-number-4">1.3.2</span> 16 位引导协议</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
该协议约定 Bootloader 和内核之间分享的数据存储的位置、大小以及哪些由内核提供给 Bootloader，哪些由 Bootloader 提供给内核(引导参数 <code>boot_params</code> )。
</p>

<p>
引导参数在内核 <code>1F1</code> 偏移处，该部分代码位于 <code>arch/x86/boot/header.S 292行</code>
</p>

<div class="org-src-container">
<pre class="src src-asm">        <span class="org-keyword">.section</span> <span class="org-string">".header"</span>, <span class="org-string">"a"</span>
        <span class="org-keyword">.globl</span>  sentinel
<span class="org-function-name">sentinel</span>:       .byte <span class="org-highlight-numbers-number">0xff</span>, <span class="org-highlight-numbers-number">0xff</span>        <span class="org-comment-delimiter">/* </span><span class="org-comment">Used to detect broken loaders */</span>

        <span class="org-keyword">.globl</span>  hdr
<span class="org-function-name">hdr</span>:
<span class="org-function-name">setup_sects</span>:    .byte <span class="org-highlight-numbers-number">0</span>                 <span class="org-comment-delimiter">/* </span><span class="org-comment">Filled in by build.c */</span>
<span class="org-function-name">root_flags</span>:     .word ROOT_RDONLY
<span class="org-function-name">syssize</span>:        .long <span class="org-highlight-numbers-number">0</span>                 <span class="org-comment-delimiter">/* </span><span class="org-comment">Filled in by build.c */</span>
<span class="org-function-name">ram_size</span>:       .word <span class="org-highlight-numbers-number">0</span>                 <span class="org-comment-delimiter">/* </span><span class="org-comment">Obsolete */</span>
<span class="org-function-name">vid_mode</span>:       .word SVGA_MODE
<span class="org-function-name">root_dev</span>:       .word <span class="org-highlight-numbers-number">0</span>                 <span class="org-comment-delimiter">/* </span><span class="org-comment">Filled in by build.c */</span>
<span class="org-function-name">boot_flag</span>:      .word <span class="org-highlight-numbers-number">0xAA55</span>

        # offset <span class="org-highlight-numbers-number">512</span>, entry point

            <span class="org-keyword">.globl</span>      _start
<span class="org-function-name">_start</span>:
                <span class="org-keyword">.byte</span>   <span class="org-highlight-numbers-number">0xeb</span>            # short (<span class="org-highlight-numbers-number">2-byte</span>) jump
                <span class="org-keyword">.byte</span>   start_of_setup-1f
<span class="org-highlight-numbers-number">1</span>:
</pre>
</div>

<p>
查看链接脚本 <code>arch/x86/boot/setup.ld</code>
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">.header &#27573;&#22312; 495 &#22788;&#65292;.header &#21644; _start &#24688;&#22909;&#26159; 512(0x200) &#30340;&#20559;&#31227;&#12290;</span>
<span class="org-function-name">ENTRY</span>(_start)
SECTIONS {
        . = <span class="org-highlight-numbers-number">0</span>;
        .bstext         : { *(.bstext) }
        .bsdata         : { *(.bsdata) }
        . = <span class="org-highlight-numbers-number">495</span>;
        .header         : { *(.header) }
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> 引导参数</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Offset/Size</th>
<th scope="col" class="org-right">Proto</th>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">01F1/1</td>
<td class="org-right">ALL(1</td>
<td class="org-left">setup_sects</td>
<td class="org-left">The size of the setup in sectors</td>
</tr>

<tr>
<td class="org-left">01F2/2</td>
<td class="org-right">ALL</td>
<td class="org-left">root_flags</td>
<td class="org-left">If set, the root is mounted readonly</td>
</tr>

<tr>
<td class="org-left">01F4/4</td>
<td class="org-right">2.04+(2</td>
<td class="org-left">syssize</td>
<td class="org-left">The size of the 32-bit code in 16-byte paras</td>
</tr>

<tr>
<td class="org-left">01F8/2</td>
<td class="org-right">ALL</td>
<td class="org-left">ram_size</td>
<td class="org-left">DO NOT USE - for bootsect.S use only</td>
</tr>

<tr>
<td class="org-left">01FA/2</td>
<td class="org-right">ALL</td>
<td class="org-left">vid_mode</td>
<td class="org-left">Video mode control</td>
</tr>

<tr>
<td class="org-left">01FC/2</td>
<td class="org-right">ALL</td>
<td class="org-left">root_dev</td>
<td class="org-left">Default root device number</td>
</tr>

<tr>
<td class="org-left">01FE/2</td>
<td class="org-right">ALL</td>
<td class="org-left">boot_flag</td>
<td class="org-left">0xAA55 magic number</td>
</tr>

<tr>
<td class="org-left">0200/2</td>
<td class="org-right">2.00+</td>
<td class="org-left">jump</td>
<td class="org-left">Jump instruction</td>
</tr>

<tr>
<td class="org-left">0202/4</td>
<td class="org-right">2.00+</td>
<td class="org-left">header</td>
<td class="org-left">Magic signature "HdrS"</td>
</tr>

<tr>
<td class="org-left">0206/2</td>
<td class="org-right">2.00+</td>
<td class="org-left">version</td>
<td class="org-left">Boot protocol version supported</td>
</tr>

<tr>
<td class="org-left">0208/4</td>
<td class="org-right">2.00+</td>
<td class="org-left">realmode_swtch</td>
<td class="org-left">Boot loader hook (see below)</td>
</tr>

<tr>
<td class="org-left">020C/2</td>
<td class="org-right">2.00+</td>
<td class="org-left">start_sys_seg</td>
<td class="org-left">The load-low segment (0x1000) (obsolete)</td>
</tr>

<tr>
<td class="org-left">020E/2</td>
<td class="org-right">2.00+</td>
<td class="org-left">kernel_version</td>
<td class="org-left">Pointer to kernel version string</td>
</tr>

<tr>
<td class="org-left">0210/1</td>
<td class="org-right">2.00+</td>
<td class="org-left">type_of_loader</td>
<td class="org-left">Boot loader identifier</td>
</tr>

<tr>
<td class="org-left">0211/1</td>
<td class="org-right">2.00+</td>
<td class="org-left">loadflags</td>
<td class="org-left">Boot protocol option flags</td>
</tr>

<tr>
<td class="org-left">0212/2</td>
<td class="org-right">2.00+</td>
<td class="org-left">setup_move_size</td>
<td class="org-left">Move to high memory size (used with hooks)</td>
</tr>

<tr>
<td class="org-left">0214/4</td>
<td class="org-right">2.00+</td>
<td class="org-left">code32_start</td>
<td class="org-left">Boot loader hook (see below)</td>
</tr>

<tr>
<td class="org-left">0218/4</td>
<td class="org-right">2.00+</td>
<td class="org-left">ramdisk_image</td>
<td class="org-left">initrd load address (set by boot loader)</td>
</tr>

<tr>
<td class="org-left">021C/4</td>
<td class="org-right">2.00+</td>
<td class="org-left">ramdisk_size</td>
<td class="org-left">initrd size (set by boot loader)</td>
</tr>

<tr>
<td class="org-left">0220/4</td>
<td class="org-right">2.00+</td>
<td class="org-left">bootsect_kludge</td>
<td class="org-left">DO NOT USE - for bootsect.S use only</td>
</tr>

<tr>
<td class="org-left">0224/2</td>
<td class="org-right">2.01+</td>
<td class="org-left">heap_end_ptr</td>
<td class="org-left">Free memory after setup end</td>
</tr>

<tr>
<td class="org-left">0226/1</td>
<td class="org-right">2.02+(3</td>
<td class="org-left">ext_loader_ver</td>
<td class="org-left">Extended boot loader version</td>
</tr>

<tr>
<td class="org-left">0227/1</td>
<td class="org-right">2.02+(3</td>
<td class="org-left">ext_loader_type</td>
<td class="org-left">Extended boot loader ID</td>
</tr>

<tr>
<td class="org-left">0228/4</td>
<td class="org-right">2.02+</td>
<td class="org-left">cmd_line_ptr</td>
<td class="org-left">32-bit pointer to the kernel command line</td>
</tr>

<tr>
<td class="org-left">022C/4</td>
<td class="org-right">2.03+</td>
<td class="org-left">initrd_addr_max</td>
<td class="org-left">Highest legal initrd address</td>
</tr>

<tr>
<td class="org-left">0230/4</td>
<td class="org-right">2.05+</td>
<td class="org-left">kernel_alignment</td>
<td class="org-left">Physical addr alignment required for kernel</td>
</tr>

<tr>
<td class="org-left">0234/1</td>
<td class="org-right">2.05+</td>
<td class="org-left">relocatable_kernel</td>
<td class="org-left">Whether kernel is relocatable or not</td>
</tr>

<tr>
<td class="org-left">0235/1</td>
<td class="org-right">2.10+</td>
<td class="org-left">min_alignment</td>
<td class="org-left">Minimum alignment, as a power of two</td>
</tr>

<tr>
<td class="org-left">0236/2</td>
<td class="org-right">2.12+</td>
<td class="org-left">xloadflags</td>
<td class="org-left">Boot protocol option flags</td>
</tr>

<tr>
<td class="org-left">0238/4</td>
<td class="org-right">2.06+</td>
<td class="org-left">cmdline_size</td>
<td class="org-left">Maximum size of the kernel command line</td>
</tr>

<tr>
<td class="org-left">023C/4</td>
<td class="org-right">2.07+</td>
<td class="org-left">hardware_subarch</td>
<td class="org-left">Hardware subarchitecture</td>
</tr>

<tr>
<td class="org-left">0240/8</td>
<td class="org-right">2.07+</td>
<td class="org-left">hardware_subarch_data</td>
<td class="org-left">Subarchitecture-specific data</td>
</tr>

<tr>
<td class="org-left">0248/4</td>
<td class="org-right">2.08+</td>
<td class="org-left">payload_offset</td>
<td class="org-left">Offset of kernel payload</td>
</tr>

<tr>
<td class="org-left">024C/4</td>
<td class="org-right">2.08+</td>
<td class="org-left">payload_length</td>
<td class="org-left">Length of kernel payload</td>
</tr>

<tr>
<td class="org-left">0250/8</td>
<td class="org-right">2.09+</td>
<td class="org-left">setup_data</td>
<td class="org-left">64-bit physical pointer to linked list of struct setup_data</td>
</tr>

<tr>
<td class="org-left">0258/8</td>
<td class="org-right">2.10+</td>
<td class="org-left">pref_address</td>
<td class="org-left">Preferred loading address</td>
</tr>

<tr>
<td class="org-left">0260/4</td>
<td class="org-right">2.10+</td>
<td class="org-left">init_size</td>
<td class="org-left">Linear memory required during initialization</td>
</tr>

<tr>
<td class="org-left">0264/4</td>
<td class="org-right">2.11+</td>
<td class="org-left">handover_offset</td>
<td class="org-left">Offset of handover entry point</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org6309621" class="outline-4">
<h4 id="org6309621"><span class="section-number-4">1.3.3</span> 32 位引导协议</h4>
<div class="outline-text-4" id="text-1-3-3">
<ol class="org-ol">
<li>除了传统的引导参数(<code>struct boot_params</code>)，Bootloader 取代内核实模式部分负责收集硬件信息(<a href="https://elixir.bootlin.com/linux/v4.17.1/source/Documentation/x86/zero-page.txt">zero-page.txt</a>)</li>
<li>然后，Bootloader 跳转到 <code>code32_start</code> 处，即内核被加载的起始位置。</li>
</ol>

<blockquote>
<p>
在进入时，CPU 的初始化状态
</p>
<ul class="org-ul">
<li>CPU 必须处于启动分页的 64 位模式</li>
<li>setup_header.init_size 的范围为从内核被加载的起始地址和零页面以及命令行缓冲区获得的 <code>ident</code> 映射。</li>
<li>加载 GDT 描述符(4G 平坦模式)，选择子为 <code>__BOOT_CS(0x10, 执行/读取)</code> 和 <code>__BOOT_DS(0x18, 读/写)</code></li>
<li><code>cs</code> 为 <code>__BOOT_CS</code> ， <code>ds、es、ss</code> 为 <code>__BOOT_DS</code> 。</li>
<li>禁用中断。</li>
<li><code>esi</code> 保存 <code>struct boot_params</code> 的基地址。</li>
<li><code>ebp、edi、ebx</code> 必须为 0。</li>
</ul>
</blockquote>
</div>
</div>

<div id="outline-container-org63ba7f9" class="outline-4">
<h4 id="org63ba7f9"><span class="section-number-4">1.3.4</span> 64 位引导协议</h4>
<div class="outline-text-4" id="text-1-3-4">
<ol class="org-ol">
<li>除了传统的引导参数(<code>struct boot_params</code>)，Bootloader 取代内核实模式部分负责收集硬件信息(<a href="https://elixir.bootlin.com/linux/v4.17.1/source/Documentation/x86/zero-page.txt">zero-page.txt</a>)</li>
<li>然后，Bootloader 跳转到 <code>code32_start</code> 处，即内核被加载的起始位置 + 0x200。</li>
</ol>

<blockquote>
<p>
在进入时，CPU 的初始化状态
</p>
<ul class="org-ul">
<li>CPU 必须处于启动分页的 64 位模式</li>
<li>setup_header.init_size 的范围为从内核被加载的起始地址和零页面以及命令行缓冲区获得的 <code>ident</code> 映射。</li>
<li>加载 GDT 描述符(4G 平坦模式)，选择子为 <code>__BOOT_CS(0x10, 执行/读取)</code> 和 <code>__BOOT_DS(0x18, 读/写)</code></li>
<li><code>cs</code> 为 <code>__BOOT_CS</code> ， <code>ds、es、ss</code> 为 <code>__BOOT_DS</code> 。</li>
<li>禁用中断。</li>
<li><code>esi</code> 保存 <code>struct boot_params</code> 的基地址。</li>
<li><code>ebp、edi、ebx</code> 必须为 0。</li>
</ul>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org5ff7591" class="outline-3">
<h3 id="org5ff7591"><span class="section-number-3">1.4</span> 内核代码的入口</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-org8812f30" class="outline-4">
<h4 id="org8812f30"><span class="section-number-4">1.4.1</span> startup_32</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
该部分代码位于 <code>arch/x86/boot/compressed/head_64.S 48</code> 。
</p>
<ol class="org-ol">
<li>检查 <code>boot_params</code> 的 <code>loadflags</code> 的 <code>KEEP_SEGMENTS</code> 位：确保段寄存器都设置为基地址都为 0 的平坦段。
<ul class="org-ul">
<li>如果为 0：重新加载段寄存器， <code>ds、es、ss</code> 设为(<code>__BOOT_DS,0x18</code>)。</li>
<li>如果为 1：不重新加载段寄存器。</li>
</ul></li>
<li><p>
计算实际被加载的内存地址, 保存到 <code>ebp</code>
</p>

<div class="org-src-container">
<pre class="src src-asm">        <span class="org-keyword">leal</span>    (BP_scratch+4)(<span class="org-variable-name">%esi</span>), <span class="org-variable-name">%esp</span>
        <span class="org-keyword">call</span>    <span class="org-highlight-numbers-number">1f</span>
<span class="org-highlight-numbers-number">1</span>:      <span class="org-keyword">popl</span>    <span class="org-variable-name">%ebp</span>
        <span class="org-keyword">subl</span>    $1b, <span class="org-variable-name">%ebp</span>
</pre>
</div></li>
<li>建立栈和检查 CPU 是否支持 <code>long mode</code> 和 <code>sse</code> ，不支持则 <code>hlt</code> 。</li>
<li><p>
设置 <code>ebp</code> 为内核被加载的地址， <code>ebx</code> 为临时移动内核映像的地址，确保安全的就地解压缩(<code>LOAD_PHYSICAL_ADDR + init_size(内核映像解压缩后需要的大小) - 压缩内核的结束位置</code>)。
</p>

<blockquote>
<p>
注：如果配置了可重定向，检查被加载的内核是否对齐(可能存在boot loader 未将内核加载到指定位置)，若没有对齐使之对齐，设为 <code>LOAD_PHYSICAL_ADDR</code> 。
</p>
</blockquote></li>
<li>准备进入 64 位模式：
<ol class="org-ol">
<li><p>
重新加载 <code>GDT</code> ：一个 32 位内核代码段，一个 64 位内核段，内核数据段，两个任务描述符。
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">gdt</span>:
        <span class="org-keyword">.word</span>   gdt_end - gdt
        <span class="org-keyword">.long</span>   gdt
        <span class="org-keyword">.word</span>   <span class="org-highlight-numbers-number">0</span>
        <span class="org-keyword">.quad</span>   <span class="org-highlight-numbers-number">0x00cf9a000000ffff</span>      <span class="org-comment-delimiter">/* </span><span class="org-comment">__KERNEL32_CS */</span>
        <span class="org-keyword">.quad</span>   <span class="org-highlight-numbers-number">0x00af9a000000ffff</span>      <span class="org-comment-delimiter">/* </span><span class="org-comment">__KERNEL_CS */</span>
        <span class="org-keyword">.quad</span>   <span class="org-highlight-numbers-number">0x00cf92000000ffff</span>      <span class="org-comment-delimiter">/* </span><span class="org-comment">__KERNEL_DS */</span>
        <span class="org-keyword">.quad</span>   <span class="org-highlight-numbers-number">0x0080890000000000</span>      <span class="org-comment-delimiter">/* </span><span class="org-comment">TS descriptor */</span>
        <span class="org-keyword">.quad</span>   <span class="org-highlight-numbers-number">0x0000000000000000</span>      <span class="org-comment-delimiter">/* </span><span class="org-comment">TS continued */</span>
<span class="org-function-name">gdt_end</span>:
</pre>
</div></li>

<li>启动页表模式 <code>4-level mode</code> ：x86_64(48 位地址总线，256 TB)。</li>
</ol></li>
<li>检查 SEV，并构建页表(4 G大小)：初始化 24 kb内存(置 0)，分配 6 个页表(每个页表分配了 4kb)。
<ul class="org-ul">
<li>一个 Page Map Level 4(PML4)，包含一个表项指向</li>
<li>一个 Page Directory Pointer(PDP)，包含 4 个表项</li>
<li>4 个 Page Directory tables，共 2048 个表项</li>
</ul></li>
<li>在 EFER(Extended Feature Enable Register) 启动 long mode。</li>
<li><code>ldtr</code> 标记为无效, <code>tr</code> 设为 <code>__BOOT_TSS</code> (指向 4*8 段描述符)。</li>
<li>设置 <code>CR0</code> 的 <code>PG</code> 、 <code>PE</code> 位，执行 <code>lret(__KERNEL_CS:startup_64 + LOAD_PHYSICAL_ADDR，如：0X0010:0X1000200</code>)，即跳转到 <code>startup_64</code></li>
</ol>
</div>
</div>

<div id="outline-container-orgf1acd06" class="outline-4">
<h4 id="orgf1acd06"><span class="section-number-4">1.4.2</span> startup_64</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
该部分代码位于 <code>arch/x86/boot/compressed/head_64.S 253</code> 。
</p>
<ol class="org-ol">
<li>初始化除 <code>cs</code> 以外的段寄存器(置零)</li>
<li><p>
设置 <code>rbp</code> 为内核被加载的地址， <code>rbx</code> 为临时移动内核映像的地址，确保安全的就地解压缩(<code>LOAD_PHYSICAL_ADDR + (init_size(内核解压缩后需要的大小) - 压缩内核的结束位置)</code>)。
</p>

<blockquote>
<p>
注：如果配置了可重定向，检查被加载的内核是否对齐(可能存在boot loader 未将内核加载到指定位置)，若没有对齐使之对齐，设为 <code>LOAD_PHYSICAL_ADDR</code>
#+END_QUOTE。
</p>
<ol class="org-ol">
<li><p>
设置栈，计算实际被加载的内存地址的起始位置保存到 <code>rdi</code> ，调用 <code>adjust_got</code>
</p>

<p>
#+BEGIN_QUOTE
<code>adjust_got</code> ：调整 got(global offset table，全局变量运行时地址)。
</p>
<ul class="org-ul">
<li><code>rax</code> ：撤销上一次调整(第一次为 0)</li>
<li><code>rdi</code> ：新的调整</li>
</ul></li>
</ol>
</blockquote></li>
<li>重新加载 <code>GDT</code> (确保有 32 code segment)：一个 32 位内核代码段，一个 64 位内核段，内核数据段，两个任务描述符。</li>
<li>切换页表模式: 若想在 long mode 下的 4-level 启动 5-level 设置 CR4.LA57 将触发 #GP(反之亦然), 所以需要先取消 long mode, 然后在低内存(针对内核处在 4G 以上的情况)从 4-level 切换到 5-level, 同时还需要将 <code>top_table</code> 驻留在较低内存中(32-bit mode 无法加载 64-bit 的值)。
<ol class="org-ol">
<li>调用 <code>paging_prepare</code>:
<ol class="org-ol">
<li>首先寻找 trampoline 的位置保存在 <code>paging_config.trampoline_start</code></li>
<li>将 <code>paging_config.trampoline_start</code> 原本的内存暂存在 <code>trampoline_save</code></li>
<li>将 top_table(当前 cr3 的页表, 仅一个页表) 和 <code>trampoline_32bit_src</code> 代码移动到 <code>paging_config.trampoline_start</code> 的位置</li>
<li><p>
返回 rax, 即 <code>paging_config</code>
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/boot/compressed/pgtable_64.c</span>
<span class="org-keyword">struct</span> <span class="org-type">paging_config</span> {
  <span class="org-comment-delimiter">// </span><span class="org-comment">trampoline_32bit_src</span>
  <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">trampoline_start</span>;
  <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">l5_required</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">&#38656;&#35201; l5 &#35774;&#20026; 1</span>
};
</pre>
</div></li>
</ol></li>
<li>执行 <code>trampoline_32bit_src</code> 代码: 切换页表模式</li>
<li>使用 <code>trampoline_save</code> 恢复 <code>paging_config.trampoline_start</code> 所在保存地址的内存, 并填充 <code>top_pgtable</code> 设置 cr3 为 <code>top_pgtable</code> 。</li>
</ol></li>
</ol>

<pre class="example">
为解压缩内核做准备
</pre>

<ol class="org-ol">
<li>设置 stack 为 <code>rbx(临时移动内核的起始地址) + boot_stack_end=，=EFLAGS</code> 置零。</li>
<li>调用 <code>adjust_got</code> : <code>rdi</code> 为 <code>rbx</code> (临时移动内核的地址)。</li>
<li><p>
计算到 <code>_bss</code> 为止的内核大小,并将该部分的内核复制到 <code>rbx</code> 位置。
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">pushq</span>   <span class="org-keyword">%rsi</span>
<span class="org-function-name">leaq</span>    (_bss-8)(<span class="org-variable-name">%rip</span>), <span class="org-variable-name">%rsi</span>
<span class="org-function-name">leaq</span>    (_bss-8)(<span class="org-variable-name">%rbx</span>), <span class="org-variable-name">%rdi</span>
<span class="org-function-name">movq</span>    <span class="org-keyword">$</span>_bss <span class="org-comment-delimiter">/* </span><span class="org-comment">- $startup_32 */</span>, <span class="org-variable-name">%rcx</span>
<span class="org-function-name">shrq</span>    <span class="org-keyword">$3</span>, <span class="org-variable-name">%rcx</span>
<span class="org-function-name">std</span>
<span class="org-function-name">rep</span>     <span class="org-keyword">movsq</span>
<span class="org-function-name">cld</span>
<span class="org-function-name">popq</span>    <span class="org-keyword">%rsi</span>
</pre>
</div></li>
<li><p>
跳转到 <code>relocated + rbx</code> 位置
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">leaq</span>    <span class="org-keyword">relocated</span>(<span class="org-variable-name">%rbx</span>), <span class="org-variable-name">%rax</span>
<span class="org-function-name">jmp</span>     *<span class="org-variable-name">%rax</span>
</pre>
</div></li>
<li>清理 BSS(置零)</li>
<li>调用 <code>extract_kernel(arch/x86/boot/compressed/misc.c 339行)</code> 函数：解压缩内核。</li>
<li>跳转到 <code>rax</code> 即 <b>解压后内核</b> 的起始位置 (<code>arch/x86/kernel/head_64.S</code>)</li>
</ol>
</div>
</div>

<div id="outline-container-orgd6712ca" class="outline-4">
<h4 id="orgd6712ca"><span class="section-number-4">1.4.3</span> init_size 的计算</h4>
<div class="outline-text-4" id="text-1-4-3">
<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">/* </span><span class="org-comment">&#20445;&#35777;&#23433;&#20840;&#30340;&#23601;&#22320;&#35299;&#21387; */</span>
<span class="org-comment-delimiter">/* </span><span class="org-comment">For more information, please refer to RFC 1951 and RFC 1952. */</span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">ZO_z_extra_bytes</span>        ((ZO_z_output_len &gt;&gt; <span class="org-highlight-numbers-number">8</span>) + <span class="org-highlight-numbers-number">65536</span>)
<span class="org-preprocessor">#if</span> <span class="org-variable-name">ZO_z_output_len</span> &gt; ZO_z_input_len
<span class="org-preprocessor"># define</span> <span class="org-variable-name">ZO_z_extract_offset</span>    (ZO_z_output_len + ZO_z_extra_bytes -
                   <span class="org-keyword">ZO_z_input_len</span>)
<span class="org-preprocessor">#else</span>
<span class="org-preprocessor"># define</span> <span class="org-variable-name">ZO_z_extract_offset</span>    ZO_z_extra_bytes
<span class="org-preprocessor">#endif</span>

<span class="org-comment-delimiter">/* </span><span class="org-comment">&#20445;&#35777;&#20559;&#31227;&#23545;&#40784; */</span>
<span class="org-preprocessor">#if</span> (ZO__ehead - ZO_startup_32) &gt; ZO_z_extract_offset
<span class="org-preprocessor"># define</span> <span class="org-variable-name">ZO_z_min_extract_offset</span> ((ZO__ehead - ZO_startup_32 + <span class="org-highlight-numbers-number">4095</span>) &amp; ~<span class="org-highlight-numbers-number">4095</span>)
<span class="org-preprocessor">#else</span>
<span class="org-preprocessor"># define</span> <span class="org-variable-name">ZO_z_min_extract_offset</span> ((ZO_z_extract_offset + <span class="org-highlight-numbers-number">4095</span>) &amp; ~<span class="org-highlight-numbers-number">4095</span>)
<span class="org-preprocessor">#endif</span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">ZO_INIT_SIZE</span>    (ZO__end - ZO_startup_32 + ZO_z_min_extract_offset)

<span class="org-preprocessor">#define</span> <span class="org-variable-name">VO_INIT_SIZE</span>    (VO__end - VO__text)
<span class="org-preprocessor">#if</span> <span class="org-variable-name">ZO_INIT_SIZE</span> &gt; VO_INIT_SIZE
<span class="org-preprocessor"># define</span> <span class="org-variable-name">INIT_SIZE</span> ZO_INIT_SIZE
<span class="org-preprocessor">#else</span>
<span class="org-preprocessor"># define</span> <span class="org-variable-name">INIT_SIZE</span> VO_INIT_SIZE
<span class="org-preprocessor">#endif</span>

<span class="org-function-name">init_size</span>:              .long INIT_SIZE         # kernel initialization size

</pre>
</div>
</div>
</div>

<div id="outline-container-orgfcba340" class="outline-4">
<h4 id="orgfcba340"><span class="section-number-4">1.4.4</span> 解压缩内核</h4>
<div class="outline-text-4" id="text-1-4-4">
<pre class="example">
                            |-----compressed kernel image------|
                            V                                  V
0                       extract_offset                      +INIT_SIZE
|-----------|---------------|-------------------------|--------|
            |               |                         |        |
          VO__text      startup_32 of ZO          VO__end    ZO__end
            ^                                         ^
            |-------uncompressed kernel image---------|
</pre>

<blockquote>
<p>
<code>extract_kernel</code> 函数负责解压缩内核，参数有：
</p>
<ul class="org-ul">
<li><code>rmode</code> ：指向 <code>boot_params</code> 的指针。</li>
<li><code>heap</code> ：指向 <code>boot_heap</code> 的指针，为解压缩分配堆的内存。</li>
<li><code>input_data</code> ：指向压缩内核的起始地址</li>
<li><code>input_len</code> ：压缩内核的长度</li>
<li><code>output</code> ：解压缩内核后的起始地址</li>
<li><code>output_len</code> ：解压缩内核的长度</li>
</ul>
</blockquote>

<ol class="org-ol">
<li>首先打印关于解压缩的一些信息</li>
<li>调用 <code>choose_random_location</code> ：选择内核映像将被解压缩的内存位置(kASLR，Address space layout randomization)，允许内核解压到一个随机的地址，为了安全考虑。
<ul class="org-ul">
<li>其中设置 5-level mode 相关变量的值</li>
</ul></li>
<li>校验随机地址的选择正确对齐且地址没有错误。</li>
<li><p>
打印 Decompressing Linux&#x2026;，并调用 <code>__decompress</code> ，该函数取决于在内核编译期间选择的解压缩算法。
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#ifdef</span> CONFIG_KERNEL_GZIP
<span class="org-preprocessor">#include</span> <span class="org-string">"../../../../lib/decompress_inflate.c"</span>
<span class="org-preprocessor">#endif</span>

<span class="org-preprocessor">#ifdef</span> CONFIG_KERNEL_BZIP2
<span class="org-preprocessor">#include</span> <span class="org-string">"../../../../lib/decompress_bunzip2.c"</span>
<span class="org-preprocessor">#endif</span>

<span class="org-preprocessor">#ifdef</span> CONFIG_KERNEL_LZMA
<span class="org-preprocessor">#include</span> <span class="org-string">"../../../../lib/decompress_unlzma.c"</span>
<span class="org-preprocessor">#endif</span>

<span class="org-preprocessor">#ifdef</span> CONFIG_KERNEL_XZ
<span class="org-preprocessor">#include</span> <span class="org-string">"../../../../lib/decompress_unxz.c"</span>
<span class="org-preprocessor">#endif</span>

<span class="org-preprocessor">#ifdef</span> CONFIG_KERNEL_LZO
<span class="org-preprocessor">#include</span> <span class="org-string">"../../../../lib/decompress_unlzo.c"</span>
<span class="org-preprocessor">#endif</span>
</pre>
</div></li>

<li>解析 elf：将内核的各个段进行 2M 对齐</li>
<li>处理重定向</li>
<li>返回</li>
</ol>
</div>
</div>
</div>
</div>

<div id="outline-container-org347bd8a" class="outline-2">
<h2 id="org347bd8a"><span class="section-number-2">2</span> Initialization</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orga2c47f5" class="outline-3">
<h3 id="orga2c47f5"><span class="section-number-3">2.1</span> arch/x86/kernel/head_64.S:startup_64</h3>
<div class="outline-text-3" id="text-2-1">
<ol class="org-ol">
<li>内核可能加载到与编译时不同的地址，需要修复在页表的物理地址并重新加载。
<ol class="org-ol">
<li>调用 <code>verify_cpu</code> ，检查 SSE 和 longmode，在 intel 将 xd 位清零(若 bootloader 进入 startup_64 则需要重新检查 cpu，防止一些 bootloader 没有进行 cpu 检查)。</li>
<li><p>
<code>__startup_64</code>  fixup early page table
</p>
<ul class="org-ul">
<li>provide <code>early_dynamic_pgts</code> (64 page tables) for page table management</li>
<li>three kernel physical address mapping(use <code>__PAGE_KERNEL_LARGE_EXEC</code>)
<ul class="org-ul">
<li><code>0x0000000000000000 - kernel size offset</code></li>
<li><code>0x0000000040000000 - kernel size offset</code></li>
<li><code>0xffffffff80000000 - kernel size offset</code></li>
</ul></li>
<li><code>0xffffffffff900000-0xfffffffffffaffff</code>: 4MB fixmap range</li>
<li><code>0xffffffffffb00000-0xffffffffffffffff</code>: 6MB reserved spaces</li>
<li><code>0xffffffffffe00000-0xffffffffffffffff</code>: 2MB unused hole</li>
</ul>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">/* </span><span class="org-comment">arch/x86/kernel/head_64.S 370 */</span>
<span class="org-comment-delimiter">/* </span><span class="org-comment">Automate the creation of 1 to 1 mapping pmd entries */</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">PMDS</span>(<span class="org-variable-name">START</span>, <span class="org-variable-name">PERM</span>, <span class="org-variable-name">COUNT</span>)                        \
        <span class="org-keyword">i</span> = <span class="org-highlight-numbers-number">0</span> <span class="org-comment-delimiter">;                                         </span><span class="org-comment">\</span>
        <span class="org-keyword">.rept</span> (COUNT) <span class="org-comment-delimiter">;                                 </span><span class="org-comment">\</span>
        <span class="org-keyword">.quad</span>   (START) + (i &lt;&lt; PMD_SHIFT) + (PERM) <span class="org-comment-delimiter">;   </span><span class="org-comment">\</span>
        <span class="org-keyword">i</span> = i + <span class="org-highlight-numbers-number">1</span> <span class="org-comment-delimiter">;                                     </span><span class="org-comment">\</span>
        <span class="org-keyword">.endr</span>

        <span class="org-keyword">__INITDATA</span>
<span class="org-function-name">NEXT_PGD_PAGE</span>(early_top_pgt)
        <span class="org-keyword">.fill</span>   <span class="org-highlight-numbers-number">512</span>,<span class="org-highlight-numbers-number">8</span>,<span class="org-highlight-numbers-number">0</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">PGD&#38656;&#35201; 8k &#23545;&#40784;&#26089;&#26399;&#39029;&#34920;&#19981;&#38656;&#35201;&#36825;&#20040;&#20005;&#26684;</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#20294;&#26159;&#20026;&#20102;&#33021;&#22815;&#20351;&#29992;&#20687; set_pgd() &#30340;&#23454;&#29616;&#32780;&#19981;&#25285;&#24515; 4k &#21644; 8k</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#37197;&#32622; CONFIG_PAGE_TABLE_ISOLATION</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">PTI_USER_PGD_FILL 512/0</span>
        <span class="org-keyword">.fill</span>   PTI_USER_PGD_FILL,<span class="org-highlight-numbers-number">8</span>,<span class="org-highlight-numbers-number">0</span>
<span class="org-function-name">NEXT_PAGE</span>(early_dynamic_pgts) <span class="org-comment-delimiter">// </span><span class="org-comment">EARLY_DYNAMIC_PAGE_TABLES 64</span>
        <span class="org-keyword">.fill</span>   <span class="org-highlight-numbers-number">512</span>*EARLY_DYNAMIC_PAGE_TABLES,<span class="org-highlight-numbers-number">8</span>,<span class="org-highlight-numbers-number">0</span>
        <span class="org-keyword">.data</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">...</span>
<span class="org-function-name">NEXT_PAGE</span>(level3_kernel_pgt)
        <span class="org-keyword">.fill</span>   L3_START_KERNEL,<span class="org-highlight-numbers-number">8</span>,<span class="org-highlight-numbers-number">0</span>
        <span class="org-comment-delimiter">/* </span><span class="org-comment">(2^48-(2*1024*1024*1024)-((2^39)*511))/(2^30) = 510 */</span>
        <span class="org-keyword">.quad</span>   level2_kernel_pgt - __START_KERNEL_map + _KERNPG_TABLE_NOENC
        <span class="org-keyword">.quad</span>   level2_fixmap_pgt - __START_KERNEL_map + _PAGE_TABLE_NOENC

<span class="org-function-name">NEXT_PAGE</span>(level2_kernel_pgt)
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#29992;&#19968;&#39029;&#26469;&#22635;&#20805; kernel</span>
        <span class="org-keyword">PMDS</span>(<span class="org-highlight-numbers-number">0</span>, __PAGE_KERNEL_LARGE_EXEC,
                <span class="org-keyword">KERNEL_IMAGE_SIZE</span>/PMD_SIZE)

<span class="org-function-name">NEXT_PAGE</span>(level2_fixmap_pgt)
        <span class="org-keyword">.fill</span>   <span class="org-highlight-numbers-number">506</span>,<span class="org-highlight-numbers-number">8</span>,<span class="org-highlight-numbers-number">0</span>
        <span class="org-keyword">.quad</span>   level1_fixmap_pgt - __START_KERNEL_map + _PAGE_TABLE_NOENC
        <span class="org-comment-delimiter">/* </span><span class="org-comment">8MB reserved for vsyscalls + a 2MB hole = 4 + 1 entries */</span>
        <span class="org-keyword">.fill</span>   <span class="org-highlight-numbers-number">5</span>,<span class="org-highlight-numbers-number">8</span>,<span class="org-highlight-numbers-number">0</span>

<span class="org-function-name">NEXT_PAGE</span>(level1_fixmap_pgt)
        <span class="org-keyword">.fill</span>   <span class="org-highlight-numbers-number">512</span>,<span class="org-highlight-numbers-number">8</span>,<span class="org-highlight-numbers-number">0</span>

<span class="org-preprocessor">#undef</span> <span class="org-variable-name">PMDS</span>

        <span class="org-keyword">.data</span>
        <span class="org-keyword">.align</span> <span class="org-highlight-numbers-number">16</span>
        <span class="org-keyword">.globl</span> early_gdt_descr
<span class="org-function-name">early_gdt_descr</span>:
        <span class="org-keyword">.word</span>   GDT_ENTRIES*<span class="org-highlight-numbers-number">8-1</span>
<span class="org-function-name">early_gdt_descr_base</span>:
        <span class="org-keyword">.quad</span>   INIT_PER_CPU_VAR(gdt_page)
</pre>
</div>

<p>
相关的变量和函数
</p>
<ul class="org-ul">
<li><code>load_delta</code>: offset of compile address and run address</li>
<li><p>
<code>fixup_pointer</code>: 返回变量实际的物理地址
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">__head</span> *fixup_pointer(<span class="org-type">void</span> *<span class="org-variable-name">ptr</span>, <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">physaddr</span>)
{
        <span class="org-comment-delimiter">// </span><span class="org-comment">ptr &#32534;&#35793;&#26102;&#21464;&#37327;&#22320;&#22336;, _text &#32534;&#35793;&#26102;&#20869;&#26680;&#36215;&#22987;&#22320;&#22336;(0xffffffff81000000)</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#23454;&#38469;&#30340;&#20869;&#26680;&#36215;&#22987;&#30340;&#29289;&#29702;&#22320;&#22336;</span>
        <span class="org-keyword">return</span> ptr - (<span class="org-type">void</span> *)_text + (<span class="org-type">void</span> *)physaddr;
}
</pre>
</div></li>
</ul></li>
</ol></li>
<li>enable page mode
<ol class="org-ol">
<li>enable <code>PAE mode</code> and <code>PGE mode</code>, setting <code>cr3</code> with <code>early_top_pgt</code></li>
<li><p>
执行跳转操作确保在虚拟地址执行
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">movq</span>    <span class="org-keyword">$1f</span>, <span class="org-variable-name">%rax</span>
<span class="org-function-name">ANNOTATE_RETPOLINE_SAFE</span>
<span class="org-function-name">jmp</span>     *<span class="org-variable-name">%rax</span>
</pre>
</div></li>
</ol></li>
<li>检查 cpu nx 是否实现，and setup EFER(Extended Feature Enable Register)</li>
<li><p>
setup cr0:
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#define</span> <span class="org-variable-name">CR0_STATE</span>       (X86_CR0_PE | X86_CR0_MP | X86_CR0_ET | \
                         X86_CR0_NE | X86_CR0_WP | X86_CR0_AM | \
                         X86_CR0_PG)
</pre>
</div></li>
<li><p>
设置栈, 并清空标志位 (为运行任何代码 <code>c code</code>)
</p>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">MOVQ</span> <span class="org-keyword">initial</span>_stack&#65288;&#65285;RIP &#65289;&#65292;&#65285;RSP
<span class="org-function-name">pushq</span>  <span class="org-keyword">$</span> <span class="org-highlight-numbers-number">0</span>
<span class="org-function-name">popfq</span>
...
<span class="org-function-name">GLOBAL</span>(initial_stack)
<span class="org-keyword">.quad</span>  init_thread_union + THREAD_SIZE - SIZEOF_PTREGS
</pre>
</div>
<ul class="org-ul">
<li><p>
<code>THREAD_SIZE</code>: 线程大小取决于 <a href="https://github.com/torvalds/linux/tree/master/Documentation/dev-tools/kasan.rst"><code>KASAN</code></a> ，若没有配置 <code>KASAN</code> 则 <code>THREAD_SIZE</code> 为 16kb。
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#ifdef</span> CONFIG_KASAN
<span class="org-preprocessor">#define</span> <span class="org-variable-name">KASAN_STACK_ORDER</span> <span class="org-highlight-numbers-number">1</span>
<span class="org-preprocessor">#else</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">KASAN_STACK_ORDER</span> <span class="org-highlight-numbers-number">0</span>
<span class="org-preprocessor">#endif</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">THREAD_SIZE_ORDER</span>       (<span class="org-highlight-numbers-number">2</span> + KASAN_STACK_ORDER)
<span class="org-preprocessor">#define</span> <span class="org-variable-name">THREAD_SIZE</span>  (PAGE_SIZE &lt;&lt; THREAD_SIZE_ORDER)#ifdef CONFIG_KASAN
</pre>
</div></li>
<li><p>
<code>init_thread_union</code>: <code>init_task</code> 被链接到 <code>init_thread_union</code> 的内部
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">include/linux/sched.h 1560</span>
<span class="org-keyword">union</span> <span class="org-type">thread_union</span> {
<span class="org-preprocessor">#if</span><span class="org-negation-char"><span class="org-preprocessor">n</span></span><span class="org-preprocessor">def</span> CONFIG_ARCH_TASK_STRUCT_ON_STACK
        <span class="org-keyword">struct</span> <span class="org-type">task_struct</span> <span class="org-variable-name">task</span>;
<span class="org-preprocessor">#endif</span>
<span class="org-preprocessor">#if</span><span class="org-negation-char"><span class="org-preprocessor">n</span></span><span class="org-preprocessor">def</span> CONFIG_THREAD_INFO_IN_TASK
        <span class="org-keyword">struct</span> <span class="org-type">thread_info</span> <span class="org-variable-name">thread_info</span>;
<span class="org-preprocessor">#endif</span>
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">stack</span>[THREAD_SIZE/<span class="org-keyword">sizeof</span>(<span class="org-type">long</span>)];
};
<span class="org-comment-delimiter">// </span><span class="org-comment">include/asm-generic/vmlinux.lds.h</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">INIT_TASK_DATA</span>(<span class="org-variable-name">align</span>)                                           \
        . = ALIGN(align);                                               \
        __start_init_task = .;                                          \
        init_thread_union = .;                                          \
        init_stack = .;                                                 \
        KEEP(*(.data..init_task))                                       \
        KEEP(*(.data..init_thread_info))                                \
        . = __start_init_task + THREAD_SIZE;                            \
        __end_init_task = .;
<span class="org-comment-delimiter">// </span><span class="org-comment">init/init_task.h</span>
<span class="org-preprocessor">#ifdef</span> CONFIG_ARCH_TASK_STRUCT_ON_STACK
<span class="org-preprocessor">#define</span> <span class="org-variable-name">__init_task_data</span> <span class="org-keyword">__attribute__</span>((__section__(<span class="org-string">".data..init_task"</span>)))
<span class="org-preprocessor">#else</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">__init_task_data</span> <span class="org-comment-delimiter">/**/</span>
<span class="org-preprocessor">#endif</span>
</pre>
</div></li>
</ul></li>
<li><p>
加载 gdt
</p>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/kernel/head_64.S 461</span>
<span class="org-function-name">early_gdt_descr</span>:
        <span class="org-keyword">.word</span>   GDT_ENTRIES*<span class="org-highlight-numbers-number">8-1</span>
<span class="org-function-name">early_gdt_descr_base</span>:
        <span class="org-keyword">.quad</span>   INIT_PER_CPU_VAR(gdt_page)
</pre>
</div>

<ul class="org-ul">
<li><code>GDT_ENTRIES</code>: x86_64 为 16, x86_32 为 32</li>
<li><p>
<code>INIT_PER_CPU_VAR(gdt_page)</code>: gdt 的地址, 对于 x86_64 定义了以下描述符 <code>GDT_ENTRY_KERNEL32_CS</code> 、 <code>GDT_ENTRY_KERNEL_CS</code> 、 <code>GDT_ENTRY_KERNEL_DS</code> 、 <code>GDT_ENTRY_DEFAULT_USER32_CS</code> 、 <code>GDT_ENTRY_DEFAULT_USER_DS</code> 、 <code>GDT_ENTRY_DEFAULT_USER_CS</code>
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/include/asm/percpu.h</span>
<span class="org-preprocessor">#ifdef</span> CONFIG_X86_64_SMP
<span class="org-preprocessor">#define</span> <span class="org-function-name">INIT_PER_CPU_VAR</span>(<span class="org-variable-name">var</span>)  init_per_cpu__##var
<span class="org-preprocessor">#else</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">INIT_PER_CPU_VAR</span>(<span class="org-variable-name">var</span>)  var
<span class="org-preprocessor">#endif</span>
</pre>
</div>

<p>
其声明和定义使用了下面两个宏: 保证 per-cpu 变量必须对齐
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">include/linux/percpu-defs.h</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">DECLARE_PER_CPU_PAGE_ALIGNED</span>(<span class="org-variable-name">type</span>, <span class="org-variable-name">name</span>)                        \
        DECLARE_PER_CPU_SECTION(type, name, <span class="org-string">"..page_aligned"</span>)           \
        __aligned(PAGE_SIZE)

<span class="org-preprocessor">#define</span> <span class="org-function-name">DEFINE_PER_CPU_PAGE_ALIGNED</span>(<span class="org-variable-name">type</span>, <span class="org-variable-name">name</span>)                         \
        DEFINE_PER_CPU_SECTION(type, name, <span class="org-string">"..page_aligned"</span>)            \
        __aligned(PAGE_SIZE)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/include/asm/desc.h &#22768;&#26126;</span>
<span class="org-function-name">DECLARE_PER_CPU_PAGE_ALIGNED</span>(<span class="org-keyword">struct</span> <span class="org-type">gdt_page</span>, <span class="org-type">gdt_page</span>);

<span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/kernel/cpu/common.c &#23450;&#20041;</span>
<span class="org-function-name">DEFINE_PER_CPU_PAGE_ALIGNED</span>(<span class="org-keyword">struct</span> <span class="org-type">gdt_page</span>, <span class="org-type">gdt_page</span>) = { .gdt = {
<span class="org-preprocessor">#ifdef</span> CONFIG_X86_64
        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * We need valid kernel segments for data and code in long mode too</span>
<span class="org-comment">         * IRET will check the segment types  kkeil 2000/10/28</span>
<span class="org-comment">         * Also sysret mandates a special GDT layout</span>
<span class="org-comment">         *</span>
<span class="org-comment">         * TLS descriptors are currently at a different place compared to i386.</span>
<span class="org-comment">         * Hopefully nobody expects them at a fixed place (Wine?)</span>
<span class="org-comment">         </span><span class="org-comment-delimiter">*/</span>
        [GDT_ENTRY_KERNEL32_CS]         = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0xc09b</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xfffff</span>),
        [GDT_ENTRY_KERNEL_CS]           = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0xa09b</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xfffff</span>),
        [GDT_ENTRY_KERNEL_DS]           = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0xc093</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xfffff</span>),
        [GDT_ENTRY_DEFAULT_USER32_CS]   = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0xc0fb</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xfffff</span>),
        [GDT_ENTRY_DEFAULT_USER_DS]     = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0xc0f3</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xfffff</span>),
        [GDT_ENTRY_DEFAULT_USER_CS]     = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0xa0fb</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xfffff</span>),
<span class="org-preprocessor">#else</span>
        [GDT_ENTRY_KERNEL_CS]           = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0xc09a</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xfffff</span>),
        [GDT_ENTRY_KERNEL_DS]           = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0xc092</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xfffff</span>),
        [GDT_ENTRY_DEFAULT_USER_CS]     = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0xc0fa</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xfffff</span>),
        [GDT_ENTRY_DEFAULT_USER_DS]     = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0xc0f2</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xfffff</span>),
        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * Segments used for calling PnP BIOS have byte granularity.</span>
<span class="org-comment">         * They code segments and data segments have fixed 64k limits,</span>
<span class="org-comment">         * the transfer segment sizes are set at run time.</span>
<span class="org-comment">         </span><span class="org-comment-delimiter">*/</span>
        <span class="org-comment-delimiter">/* </span><span class="org-comment">32-bit code </span><span class="org-comment-delimiter">*/</span>
        [GDT_ENTRY_PNPBIOS_CS32]        = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0x409a</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xffff</span>),
        <span class="org-comment-delimiter">/* </span><span class="org-comment">16-bit code </span><span class="org-comment-delimiter">*/</span>
        [GDT_ENTRY_PNPBIOS_CS16]        = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0x009a</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xffff</span>),
        <span class="org-comment-delimiter">/* </span><span class="org-comment">16-bit data </span><span class="org-comment-delimiter">*/</span>
        [GDT_ENTRY_PNPBIOS_DS]          = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0x0092</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xffff</span>),
        <span class="org-comment-delimiter">/* </span><span class="org-comment">16-bit data </span><span class="org-comment-delimiter">*/</span>
        [GDT_ENTRY_PNPBIOS_TS1]         = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0x0092</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0</span>),
        <span class="org-comment-delimiter">/* </span><span class="org-comment">16-bit data </span><span class="org-comment-delimiter">*/</span>
        [GDT_ENTRY_PNPBIOS_TS2]         = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0x0092</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0</span>),
        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * The APM segments have byte granularity and their bases</span>
<span class="org-comment">         * are set at run time.  All have 64k limits.</span>
<span class="org-comment">         </span><span class="org-comment-delimiter">*/</span>
        <span class="org-comment-delimiter">/* </span><span class="org-comment">32-bit code </span><span class="org-comment-delimiter">*/</span>
        [GDT_ENTRY_APMBIOS_BASE]        = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0x409a</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xffff</span>),
        <span class="org-comment-delimiter">/* </span><span class="org-comment">16-bit code </span><span class="org-comment-delimiter">*/</span>
        [GDT_ENTRY_APMBIOS_BASE+<span class="org-highlight-numbers-number">1</span>]      = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0x009a</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xffff</span>),
        <span class="org-comment-delimiter">/* </span><span class="org-comment">data </span><span class="org-comment-delimiter">*/</span>
        [GDT_ENTRY_APMBIOS_BASE+<span class="org-highlight-numbers-number">2</span>]      = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0x4092</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xffff</span>),

        [GDT_ENTRY_ESPFIX_SS]           = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0xc092</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xfffff</span>),
        [GDT_ENTRY_PERCPU]              = GDT_ENTRY_INIT(<span class="org-highlight-numbers-number">0xc092</span>, <span class="org-highlight-numbers-number">0</span>, <span class="org-highlight-numbers-number">0xfffff</span>),
        GDT_STACK_CANARY_INIT
<span class="org-preprocessor">#endif</span>
} };
</pre>
</div></li>
</ul></li>
<li><p>
设置段寄存器
</p>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">xorl</span> <span class="org-keyword">%eax</span>,<span class="org-variable-name">%eax</span>
<span class="org-function-name">movl</span> <span class="org-keyword">%eax</span>,<span class="org-variable-name">%ds</span>
<span class="org-function-name">movl</span> <span class="org-keyword">%eax</span>,<span class="org-variable-name">%ss</span>
<span class="org-function-name">movl</span> <span class="org-keyword">%eax</span>,<span class="org-variable-name">%es</span>

<span class="org-function-name">movl</span> <span class="org-keyword">%eax</span>,<span class="org-variable-name">%fs</span>
<span class="org-function-name">movl</span> <span class="org-keyword">%eax</span>,<span class="org-variable-name">%gs</span>

<span class="org-function-name">movl</span>    <span class="org-keyword">$MSR</span>_GS_BASE,<span class="org-variable-name">%ecx</span>
<span class="org-function-name">movl</span>    <span class="org-keyword">initial</span>_gs(<span class="org-variable-name">%rip</span>),<span class="org-variable-name">%eax</span>
<span class="org-function-name">movl</span>    <span class="org-keyword">initial</span>_gs+4(<span class="org-variable-name">%rip</span>),<span class="org-variable-name">%edx</span>
<span class="org-function-name">wrmsr</span>

</pre>
</div>

<p>
the <code>gs</code> register always points to the bottom of the <code>irqstack</code> union. On the x86_64, the <code>gs</code> register is shared by per-cpu area and stack canary. All per-cpu symbols are zero based and the <code>gs</code> points to the base of the per-cpu area. You already know that <code>segmented memory model</code> is abolished in the long mode, but we can set the base address for the two segment registers-<code>fs</code> and <code>gs</code> with the <a href="http://en.wikipedia.org/wiki/Model-specific_register">Model specific registers</a> and these registers can be still be used as address registers.
</p></li>
<li>跳转到 <code>x86_64_start_kernel</code> (arch/x86/kernel/head64.c, c code)</li>
</ol>
</div>
</div>

<div id="outline-container-org4c7017f" class="outline-3">
<h3 id="org4c7017f"><span class="section-number-3">2.2</span> arch/x86/kernel/head64.c:x86_64_start_kernel</h3>
<div class="outline-text-3" id="text-2-2">
<ol class="org-ol">
<li><p>
检查下列的值是否符合条件，若不符合则编译错误。
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/boot/boot.h !!condition &#30456;&#24403;&#20110; condition != 0</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">BUILD_BUG_ON</span>(<span class="org-variable-name">condition</span>) ((<span class="org-type">void</span>)<span class="org-keyword">sizeof</span>(<span class="org-type">char</span>[<span class="org-highlight-numbers-number">1</span> - <span class="org-highlight-numbers-number">2</span>*<span class="org-negation-char">!</span>!(condition)]))

<span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/kernel/head64.c 393</span>
<span class="org-function-name">BUILD_BUG_ON</span>(MODULES_VADDR &lt; __START_KERNEL_map);
<span class="org-function-name">BUILD_BUG_ON</span>(MODULES_VADDR - __START_KERNEL_map &lt; KERNEL_IMAGE_SIZE);
<span class="org-function-name">BUILD_BUG_ON</span>(MODULES_LEN + KERNEL_IMAGE_SIZE &gt; <span class="org-highlight-numbers-number">2</span>*PUD_SIZE);
BUILD_BUG_ON((__START_KERNEL_map &amp; ~PMD_MASK) != <span class="org-highlight-numbers-number">0</span>);
BUILD_BUG_ON((MODULES_VADDR &amp; ~PMD_MASK) != <span class="org-highlight-numbers-number">0</span>);
BUILD_BUG_ON(<span class="org-negation-char">!</span>(MODULES_VADDR &gt; __START_KERNEL));
MAYBE_BUILD_BUG_ON(<span class="org-negation-char">!</span>(((MODULES_END - <span class="org-highlight-numbers-number">1</span>) &amp; PGDIR_MASK) ==
                     (__START_KERNEL &amp; PGDIR_MASK)));
<span class="org-function-name">BUILD_BUG_ON</span>(<span class="org-type">__fix_to_virt</span>(<span class="org-variable-name">__end_of_fixed_addresses</span>) &lt;= MODULES_END);
</pre>
</div></li>
<li>初始化 <code>cpu_tlbstate.cr4(percpu)</code> 为当前 cr4 值。</li>
<li>清理除内核占用的页表以外的 early page tables</li>
<li>clear <code>bss</code> seg</li>
<li><p>
清理 <code>init_top_pgt</code> (感觉没必要)，清理方式根据 cpu feature 选择
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/include/asm/page_64.h 47</span>
<span class="org-keyword">static</span> <span class="org-keyword">inline</span> <span class="org-type">void</span> <span class="org-function-name">clear_page</span>(<span class="org-type">void</span> *<span class="org-variable-name">page</span>)
{
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#25903;&#25345; X86_FEATURE_ERMS &#20351;&#29992; clear_page_erms</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#21542;&#21017;, &#22914;&#26524;&#25903;&#25345; X86_FEATURE_REP_GOOD &#20351;&#29992; clear_page_rep</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#21542;&#21017;, &#20351;&#29992; clear_page_orig</span>
        alternative_call_2(clear_page_orig,
                           clear_page_rep, X86_FEATURE_REP_GOOD,
                           clear_page_erms, X86_FEATURE_ERMS,
                           <span class="org-string">"=D"</span> (page),
                           <span class="org-string">"0"</span> (page)
                           : <span class="org-string">"cc"</span>, <span class="org-string">"memory"</span>, <span class="org-string">"rax"</span>, <span class="org-string">"rcx"</span>);
}
</pre>
</div></li>
<li><b>TODO</b> 对 SME 进行早期的初始化, SME 支持可能会更新 <code>early_pmd_flags</code> 以包含内存加密掩码，因此需要在可能产生页面错误的任何内容之前调用它。</li>
<li><b>TODO</b> <code>kasan_early_init</code></li>
<li>use early handler process initialize idt table(0-31) <a href="#orgfa499d1">2.2.1</a></li>
<li>copy <code>real_mode_data</code> to <code>boot_params</code>, reset some <code>boot_param</code> for keeping the specification
<b>TODO</b>: <code>sme_unmap_bootdata</code></li>
<li><b>TODO</b> <code>load_ucode_bsp</code></li>
<li><p>
set <code>init_top_pgt</code> kernel mapping
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-type">init_top_pgt</span>[<span class="org-highlight-numbers-number">511</span>] = early_top_pgt[<span class="org-highlight-numbers-number">511</span>];
</pre>
</div></li>
<li><b>TODO</b> initialize early x86 platform quirks.</li>
<li>call <code>start_kernel() init/main.c/ 531</code></li>
</ol>
</div>

<div id="outline-container-orgdd33fcd" class="outline-4">
<h4 id="orgdd33fcd"><span class="section-number-4">2.2.1</span> 早期的中断处理</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
<a id="orgfa499d1"></a>
</p>
<ul class="org-ul">
<li><p>
设置中断: 填充 <code>idt_descr</code> 并将 idt_descr 的地址加载到 idt
</p>
<ul class="org-ul">
<li>x86_64: 为前32个中断(异常)设置中断处理程序 <code>early_idt_handler_array</code></li>
<li>x86_32: 为所有的中断设置中断处理程序 <code>early_ignore_irq</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">extern</span> <span class="org-type">gate_desc</span> <span class="org-variable-name">idt_table</span>[]; <span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/include/asm/desc.h</span>
<span class="org-type">gate_desc</span> <span class="org-variable-name">idt_table</span>[IDT_ENTRIES] __page_aligned_bss; <span class="org-comment-delimiter">// </span><span class="org-comment">IDT_ENTRIES 256 arch/x86/kernel/idt.c</span>
</pre>
</div></li>
<li>中断处理函数:
<ul class="org-ul">
<li><p>
<code>early_idt_handler_array</code>: 32 个大小为 9 字节程序的数组
如果异常有错误代码，什么也不做。如果异常没有错误代码 将 0 压入栈(保持栈统一)。然后将中断向量号压栈并调用 <code>early_idt_handler_common</code>
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">// </span><span class="org-comment">NUM_EXCEPTION_VECTORS 32, EARLY_IDT_HANDLER_SIZE 9</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/include/asm/segment.h</span>
<span class="org-function-name">extern</span> <span class="org-keyword">const</span> char early_idt_handler_array[NUM_EXCEPTION_VECTORS][EARLY_IDT_HANDLER_SIZE]<span class="org-comment-delimiter">;</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/kernel/head_64.S</span>
<span class="org-function-name">ENTRY</span>(early_idt_handler_array)
        <span class="org-keyword">i</span> = <span class="org-highlight-numbers-number">0</span>
        <span class="org-keyword">.rept</span> NUM_EXCEPTION_VECTORS
        <span class="org-keyword">.if</span> ((EXCEPTION_ERRCODE_MASK &gt;&gt; i) &amp; <span class="org-highlight-numbers-number">1</span>) == <span class="org-highlight-numbers-number">0</span>
                <span class="org-keyword">UNWIND_HINT_IRET_REGS</span>
                <span class="org-keyword">pushq</span> $0        # Dummy error code, to make stack frame uniform
        <span class="org-keyword">.else</span>
                <span class="org-keyword">UNWIND_HINT_IRET_REGS</span> offset=8
        <span class="org-keyword">.endif</span>
        <span class="org-keyword">pushq</span> $i                # <span class="org-highlight-numbers-number">72</span>(<span class="org-variable-name">%rsp</span>) Vector number
        <span class="org-keyword">jmp</span> early_idt_handler_common
        <span class="org-keyword">UNWIND_HINT_IRET_REGS</span>
        <span class="org-keyword">i</span> = i + <span class="org-highlight-numbers-number">1</span>
        <span class="org-keyword">.fill</span> early_idt_handler_array + i*EARLY_IDT_HANDLER_SIZE - ., <span class="org-highlight-numbers-number">1</span>, <span class="org-highlight-numbers-number">0xcc</span>
        <span class="org-keyword">.endr</span>
        <span class="org-keyword">UNWIND_HINT_IRET_REGS</span> offset=16
<span class="org-function-name">END</span>(early_idt_handler_array)
</pre>
</div>

<ul class="org-ul">
<li><code>early_idt_handler_common</code>: 保存相关的寄存器，根据 <code>vector number</code> 调用相应得异常处理函数
<ul class="org-ul">
<li><code>early_make_pgtable</code>:
<ol class="org-ol">
<li>检查是否是无效地址，或者 early pgt 是否完成</li>
<li>检查异常地址在不同等级的页表所在位置的值。
<ul class="org-ul">
<li>不为零: 向下级页表搜索</li>
<li>为零: 检查 <code>early_dynamic_pgts</code> 是否超过 64 若超过则重置，然后为异常地址所在位置的页表设置地址。</li>
</ul></li>
</ol></li>
<li><code>early_fixup_exception</code>: 针对非 fault page 异常的处理
<ol class="org-ol">
<li>忽略 <code>X86_TRAP_NMI</code> 异常</li>
<li>搜索异常表 <a href="#org40e4b81">4.1</a></li>
<li>处理 bug 异常</li>
<li>打印相关异常信息</li>
</ol></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/kernel/head_64.S</span>
<span class="org-function-name">early_idt_handler_common</span>:
        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * The stack is the hardware frame, an error code or zero, and the</span>
<span class="org-comment">         * vector number.</span>
<span class="org-comment">         */</span>
        <span class="org-keyword">cld</span>

        <span class="org-keyword">incl</span> early_recursion_flag(<span class="org-variable-name">%rip</span>)

        <span class="org-comment-delimiter">/* </span><span class="org-comment">The vector number is currently in the pt_regs-&gt;di slot. */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%rsi</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;si */</span>
        <span class="org-keyword">movq</span> <span class="org-highlight-numbers-number">8</span>(<span class="org-variable-name">%rsp</span>), <span class="org-variable-name">%rsi</span>                      <span class="org-comment-delimiter">/* </span><span class="org-comment">RSI = vector number */</span>
        <span class="org-keyword">movq</span> <span class="org-variable-name">%rdi</span>, <span class="org-highlight-numbers-number">8</span>(<span class="org-variable-name">%rsp</span>)                      <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;di = RDI */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%rdx</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;dx */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%rcx</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;cx */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%rax</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;ax */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r8</span>                               <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r8 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r9</span>                               <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r9 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r10</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r10 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r11</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r11 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%rbx</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;bx */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%rbp</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;bp */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r12</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r12 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r13</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r13 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r14</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r14 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r15</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r15 */</span>
        <span class="org-keyword">UNWIND_HINT_REGS</span>

        <span class="org-keyword">cmpq</span> $14,<span class="org-variable-name">%rsi</span>           <span class="org-comment-delimiter">/* </span><span class="org-comment">Page fault? */</span>
        <span class="org-keyword">jnz</span> <span class="org-highlight-numbers-number">10f</span>
        <span class="org-keyword">GET_CR2_INTO</span>(<span class="org-variable-name">%rdi</span>)      <span class="org-comment-delimiter">/* </span><span class="org-comment">Can clobber any volatile register if pv */</span>
        <span class="org-keyword">call</span> early_make_pgtable
        <span class="org-keyword">andl</span> <span class="org-variable-name">%eax</span>,<span class="org-variable-name">%eax</span>
        <span class="org-keyword">jz</span> <span class="org-highlight-numbers-number">20f</span>                  <span class="org-comment-delimiter">/* </span><span class="org-comment">All good */</span>

<span class="org-highlight-numbers-number">10</span>:
        <span class="org-keyword">movq</span> <span class="org-variable-name">%rsp</span>,<span class="org-variable-name">%rdi</span>          <span class="org-comment-delimiter">/* </span><span class="org-comment">RDI = pt_regs; RSI is already trapnr */</span>
        <span class="org-keyword">call</span> early_fixup_exception

<span class="org-highlight-numbers-number">20</span>:
        <span class="org-keyword">decl</span> early_recursion_flag(<span class="org-variable-name">%rip</span>)
        <span class="org-keyword">jmp</span> restore_regs_and_return_to_kernel
<span class="org-function-name">END</span>(early_idt_handler_common)
</pre>
</div></li>
<li><p>
<code>early_ignore_irq</code>:
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">/* </span><span class="org-comment">This is the default interrupt "handler" :-) */</span>
<span class="org-function-name">ENTRY</span>(early_ignore_irq)
        <span class="org-keyword">cld</span>
<span class="org-preprocessor">#ifdef</span> <span class="org-variable-name">CONFIG_PRINTK</span>
        <span class="org-keyword">pushl</span> <span class="org-variable-name">%eax</span>
        <span class="org-keyword">pushl</span> <span class="org-variable-name">%ecx</span>
        <span class="org-keyword">pushl</span> <span class="org-variable-name">%edx</span>
        <span class="org-keyword">pushl</span> <span class="org-variable-name">%es</span>
        <span class="org-keyword">pushl</span> <span class="org-variable-name">%ds</span>
        <span class="org-keyword">movl</span> $(__KERNEL_DS),<span class="org-variable-name">%eax</span>
        <span class="org-keyword">movl</span> <span class="org-variable-name">%eax</span>,<span class="org-variable-name">%ds</span>
        <span class="org-keyword">movl</span> <span class="org-variable-name">%eax</span>,<span class="org-variable-name">%es</span>
        <span class="org-keyword">cmpl</span> $2,early_recursion_flag
        <span class="org-keyword">je</span> hlt_loop
        <span class="org-keyword">incl</span> early_recursion_flag
        <span class="org-keyword">pushl</span> <span class="org-highlight-numbers-number">16</span>(<span class="org-variable-name">%esp</span>)
        <span class="org-keyword">pushl</span> <span class="org-highlight-numbers-number">24</span>(<span class="org-variable-name">%esp</span>)
        <span class="org-keyword">pushl</span> <span class="org-highlight-numbers-number">32</span>(<span class="org-variable-name">%esp</span>)
        <span class="org-keyword">pushl</span> <span class="org-highlight-numbers-number">40</span>(<span class="org-variable-name">%esp</span>)
        <span class="org-keyword">pushl</span> $int_msg
        <span class="org-keyword">call</span> printk

        <span class="org-keyword">call</span> dump_stack

        <span class="org-keyword">addl</span> $(<span class="org-highlight-numbers-number">5</span>*<span class="org-highlight-numbers-number">4</span>),<span class="org-variable-name">%esp</span>
        <span class="org-keyword">popl</span> <span class="org-variable-name">%ds</span>
        <span class="org-keyword">popl</span> <span class="org-variable-name">%es</span>
        <span class="org-keyword">popl</span> <span class="org-variable-name">%edx</span>
        <span class="org-keyword">popl</span> <span class="org-variable-name">%ecx</span>
        <span class="org-keyword">popl</span> <span class="org-variable-name">%eax</span>
<span class="org-preprocessor">#endif</span>
        <span class="org-keyword">iret</span>

<span class="org-function-name">hlt_loop</span>:
        <span class="org-keyword">hlt</span>
        <span class="org-keyword">jmp</span> hlt_loop
<span class="org-function-name">ENDPROC</span>(early_ignore_irq)
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org7088c6d" class="outline-3">
<h3 id="org7088c6d"><span class="section-number-3">2.3</span> init/main.c:start_kernel</h3>
<div class="outline-text-3" id="text-2-3">
<ol class="org-ol">
<li>为 <code>init_stack</code> 的结尾设置 <code>STACK_END_MAGIC</code> (For easy inspection stack overflow)</li>
<li><b>TODO</b> <code>debug_objects_early_init</code></li>
<li><b>TODO</b> <code>cgroup_init_early</code></li>
<li><code>local_irq_disable</code>: <b>Disable local IRQs(interrupts for current CPU). Do necessary setups, then enable them.</b></li>
<li><code>boot_cpu_init()</code>: first processor activation
<ol class="org-ol">
<li>get the bootstrap processor id with a call to <code>smp_processor_id</code></li>
<li>set current CPU mask for online, active, present and possible</li>
</ol></li>
<li><code>page_address_init()</code>:</li>
<li><p>
print linux banner
</p>
<pre class="example">
[    0.000000] Linux version 4.19.0-rc6 (yydcnjjw@own) (gcc version 8.2.1 20180831 (GCC)) #1 SMP Sun Oct 7 10:19:25 CST 2018
</pre></li>
<li><code>setup_arch()</code>: architecture-dependent parts of initialization
<ol class="org-ol">
<li>memory init
<ol class="org-ol">
<li>reserve memory block for the kernel <code>_text</code> 、 <code>_data</code> and <code>_bss</code> which starts from the <code>_text</code> symbol and ends before <code>_bss_stop</code></li>
<li>reserve memory for initrd</li>
</ol></li>
<li>print kernel info which is the command line.</li>
<li><b>TODO</b> detects One Laptop Per Child support.</li>
<li><code>idt_setup_early_traps</code>: initializes <a href="#orga314a9b">4.3.4</a> (<code>INTG</code>, #DB - raised when the <code>TF</code> flag of rflags is set) and <a href="#orge557b4b">4.3.5</a> (<code>SYSG</code>, #BP), allow the <code>x86_64</code> architecture to have early exception processing for the purpose of debugging via the <code>kgdb</code></li>
<li><code>early_cpu_init</code>: cpu init:
<ol class="org-ol">
<li>print kernel supported cpus with <a href="#org9238628">7.1</a></li>
<li>initialization <code>boot_cpu_data</code> what is <code>struct cpuinfo_x86</code> for doing minimum CPU detection early</li>
</ol></li>
<li>initialization ideal nops according to <code>cpuinfo_x86.x86_vendor</code></li>
<li><b>TODO</b> Jump label support init</li>
<li><code>early_ioremap_init</code>: early <a href="#orgf22d65f">3.3</a> initialization, 512 (2K) temporary boot-time mappings, used by early_ioremap(), before ioremap() is functional</li>
<li><b>TODO</b> <code>setup_olpc_ofw_pgd</code>:</li>
<li><p>
obtaining major and minor numbers for the root device
</p>
<div class="org-src-container">
<pre class="src src-C">ROOT_DEV = old_decode_dev(boot_params.hdr.root_dev);
</pre>
</div></li>
<li>setup different parameters as information about a screen</li>
<li><p>
memory map setup: copy <code>e820_table</code> to <code>e820_table_kexec</code> and <code>e820_table_firmware</code>, then print e820 information
</p>
<pre class="example">
[    0.000000] BIOS-provided physical RAM map:
[    0.000000] BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable
[    0.000000] BIOS-e820: [mem 0x000000000009fc00-0x000000000009ffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000000f0000-0x00000000000fffff] reserved
[    0.000000] BIOS-e820: [mem 0x0000000000100000-0x0000000007fdffff] usable
[    0.000000] BIOS-e820: [mem 0x0000000007fe0000-0x0000000007ffffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved
</pre></li>
<li><code>parse_setup_data</code>: <a href="https://elixir.bootlin.com/linux/latest/source/Documentation/x86/boot.txt">bootparam:setup_data</a></li>
<li><code>copy_edd()</code>: copy the BIOS <code>EDD</code> information from <code>boot_params</code> into a safe place</li>
<li>memory descriptor initialization
<ol class="org-ol">
<li><a href="#org0286897">3.4</a> initialization</li>
<li><code>mpx_mm_init</code>: initialization of the intel Memory Protection Extensions</li>
<li>initialization of the code/data/bss resources</li>
</ol></li>
<li><code>x86_configure_nx()</code>: configure nx</li>
<li><code>parse_early_param()</code>: parse early param</li>
<li><p>
<code>x86_report_nx()</code>: print nx information of cpu according to cpu feature, command line option and More
</p>
<pre class="example">
[    0.000000] NX (Execute Disable) protection: active
</pre></li>
<li><code>memblock_x86_reserve_range_setup_data()</code>: remaps memory for the <code>setup_data</code> and reserved memory block for the setup_data</li>
<li><b>TODO</b> <a href="https://en.wikipedia.org/wiki/MultiProcessor_Specification">MPS</a></li>
<li>finish with memory parsing:
<ol class="org-ol">
<li><code>e820__reserve_setup_data()</code>: This function does almost the same as <code>memblock_x86_reserve_range_setup_data()</code>, but it also calls <code>e820__range_update</code> which add new regions to the <code>e820map</code> with the given type which is <code>E820_RESERVED_KERN</code>.</li>
<li><code>e820__finish_early_params()</code>:</li>
<li><code>e820_add_kernel_range()</code>: checks that <code>.text</code>, <code>.data</code> and <code>.bss</code> marked as <code>E820RAM</code> in the <code>e820map</code> . prints the warning message and remark if not.</li>
<li><code>trm_bios_range()</code>: update first 4096 bytes in <code>e820Map</code> as <code>E820_RESERVED</code></li>
<li><code>e820__end_of_ram_pfn()</code>: takes maximum page frame number on the certain architecture(<code>MAX_ARCH_PFN</code> is <code>0x4000000000</code> for x86_64).And print information about last page frame number and return it.</li>
<li>calculate <code>max_low_pfn</code> which is the GB page frame number in the low memory or below first 4 GB. if installed more than 4 GB of RAM, <code>max_low_pfn</code> will be result of the <code>e820_end_of_low_ram_pfn</code>.</li>
</ol></li>
<li>DMI(Desktop management interface) scanning: collecting information about computer with the DMI and following function:
<ol class="org-ol">
<li><p>
<code>dmi_scan_machine()</code>: the function goes through the <a href="http://en.wikipedia.org/wiki/System_Management_BIOS">System Management BIOS</a> structures and extracts information. And print.
</p>
<pre class="example">
[    0.000000] SMBIOS 2.8 present.
[    0.000000] DMI: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-20171110_100015-anatol 04/01/2014
</pre></li>
<li><code>dmi_memdev_walk()</code>: go over memory devices</li>
</ol></li>
<li><p>
<code>find_smp_config()</code>: finding of the SMP configuration.
<code>x86_init.mpparse.find_smp_config()</code> is the <code>default_find_smp_config</code> function from the <code>arch/x86/kernel/mpparse.c</code>
Scan several specific locations by <code>smp_scan_config</code> that going in a loop through the  given memory range and tries to find <code>MP floating pointer structure</code>. It checks that current byte points to the <code>SMP</code> signature, checks checksum, checks if <code>mpf-&gt;specification</code> is 1 or 4(it must be 1 or 4 by specification) in the loop.
</p>
<pre class="example">
[    0.014511] found SMP MP-table at [mem 0x000f5d60-0x000f5d6f] mapped at [(____ptrval____)]
</pre></li>
<li>Additional early memory initialization routines
<ol class="org-ol">
<li><code>early_alloc_pgt_buf()</code>: extend brk by add 6/12 pgtable(4KB).</li>
<li><code>reserve_brk()</code>: remap brk</li>
<li><code>cleanup_highmap()</code>: clean entries which are not between <code>_text</code> and <code>end</code></li>
<li><code>memblock_set_current_limit</code>: set the limit for the <code>memblock</code> allocation.</li>
<li><code>e820__memblock_alloc_reserved_mpc_new()</code>: allocates additional slots in the <code>e820map</code> for MultiProcessor Specification table.</li>
</ol></li>
<li><code>reserve_real_mode()</code>: reserves low memory from <code>0x0</code> to <code>1mb</code> for the trampoline to the real mode(for rebooting, etc.).</li>
<li><code>trim_platform_memory_ranges()</code>: trims certain memory regions.</li>
<li><code>trim_low_memory_range()</code>: reserves the first <code>4kb</code> page in <code>memblock</code></li>
<li><code>init_mem_mapping()</code>: reconstructs direct memory mappng and setups the direct mapping of the physical memory at <code>PAGE_OFFSET</code></li>
<li><code>idt_setup_early_pf()</code>: Initialize the idt table with early pagefault handler.(head64.c has Initialized ?) <a href="#org8ea2748">4.3.6</a></li>
<li><code>setup_log_buf(1)</code>: setup kernel early cyclic buffer.</li>
<li><code>reserve_inintrd()</code>: relocated <code>initrd</code> ramdisk image.</li>
<li><code>acpi_table_ugrade()</code></li>
<li><code>vsmp_init()</code></li>
<li><code>io_delay_init()</code></li>
<li><code>acpi_boot_table_init()</code></li>
<li><code>early_acpi_boot_init()</code></li>
<li><code>initmem_init()</code></li>
<li>Allocate are for <a href="#org8296bbc">3.5</a>: <code>dma_contiguous_reserve()</code>: allocate area for the <code>Direct memory access</code></li>
<li><code>x86_init.paging.pagetable_init()</code>: initialize sparse memory and zone sizes.</li>
<li><code>prefil_possible_map()</code>: calculates and writes to the <code>cpu_possible_mask</code> actual number of the CPUs</li>
<li><code>x86_init.timers.wallclock_init()</code>: initialize the wallclock device.</li>
<li><code>register_refined_jiffies(CLOCK_TICK_RATE)</code>: register <code>refined_jiffies</code> clocksource.</li>
</ol></li>
<li><code>boot_init_stack_canary()</code>: set the canary value to protect interrupt stack overflow</li>
<li><code>mm_init_cpumask()</code>: set the <a href="#org0eccdcd">7.3</a> pointer to the memory descriptor <code>cpumask</code> (clear 0).</li>
<li><code>setup_command_line()</code>: takes pointer to the kernel command line allocates a couple of buffers to store command line.
<ol class="org-ol">
<li><code>saved_command_line</code>: will contain boot command line</li>
<li><code>initcall_command_line</code>: will contain boot command line. will be used in the <code>do_initcall_level</code></li>
<li><code>static_command_line</code>: will contain command line for parameters parsing</li>
</ol></li>
<li><code>setup_nr_cpu_ids()</code>: set <code>nr_cpu_ids</code> (number of CPUs) according to the last bit in the <code>cpu_possible_mask</code></li>
<li><code>setup_per_cpu_areas()</code>: setups memory areas for the <code>percpu</code> variables.</li>
<li><code>smp_prepare_boot_cpu()</code>: <code>arch/x86/kernel/smpboot.c</code>
<ol class="org-ol">
<li>load the original GDT</li>
<li>reload the per-cpu base</li>
<li>fill <code>cpu_callout_mask</code> bitmap with the current cpu: indicate which secondary processor can be initialized next.</li>
<li>set cpu state as online with the setting <code>cpu_state</code> percpu variable for the current processor</li>
</ol></li>
<li><code>build_all_zonelists(NULL)</code>: set up the order of zones that allocations are preferred from</li>
<li><code>page_alloc_init()</code>: setup the <code>startup</code> and <code>teardown</code> callbacks for the <code>CPUHP_PAGE_ALLOC_DEAD</code> cpu hotplug state.</li>
<li><code>parse_early_param()</code>: handle linux kernel command line for no all architecture.</li>
<li><code>jump_label_init()</code>: initialize <a href="https://lwn.net/Articles/412072/">jump label</a></li>
<li><code>setup_log_buf()</code>: setup the <code>printk</code> log buffer</li>
<li><code>vfs_caches_init_early()</code>: do early initialization of the virtual file system</li>
<li><code>sort_main_extable()</code>: sort the kernel's built-in exception table entries which are between <code>__start___ex_table</code> and <code>__stop___ex_table</code></li>
<li><b>TODO</b> <code>trap_init()</code>: initialize trap handlers
<ol class="org-ol">
<li><code>cpu_init()</code>:
<ol class="org-ol">
<li><code>syscall_init()</code>: <a href="#orgaf435b7">5.2</a></li>
</ol></li>
</ol></li>
<li><code>mm_init()</code>: initialization of the memory manager
<ol class="org-ol">
<li><code>page_ext_init_flatmem()</code>: initializes extended data per page handing</li>
<li><code>mem_init()</code>: releases all <code>bootmem</code></li>
<li><code>kmem_cache_init()</code>: initialize kernel cache</li>
<li><code>pgtable_init()</code>: initialize the <code>page-&gt;pt1</code> kernel cache</li>
<li><code>vmalloc_init()</code>: initialize <code>vmalloc</code></li>
<li><code>init_espfix_bsp()</code>: prevent leaking of <code>31:16</code> bits of the <code>esp</code> register during returning to 16-bit stack</li>
</ol></li>
<li><code>sched_init()</code>: Scheduler initialization
<ol class="org-ol">
<li><code>wait_bit_init()</code>: initialization of the array of <code>waitqueues</code>
The <code>bit_wait_table</code> is array of wait queues that will be used for wait/wake up of processes depends on the value of a designated bit.</li>
<li>initialization of <code>waitqueues</code> array is calculating size of memory to allocate for the <code>root_task_group(sched_entity)</code> and <code>runqueues</code>.</li>
<li>allocate a space with the <code>kzalloc</code> functions and set pointers of <code>sched_entity</code> and <code>runqueues</code>.</li>
<li>initialize a <code>bandwidth</code> of CPU for <code>real-time</code> and <code>deadline</code> tasks.</li>
<li>initialization of the <code>root domain</code>: The real-time scheduler requires global resources to make scheduling decision. But unfortunately scalability bottlenecks appear as the number of CPUs increase. The concept of <code>root_domains</code> was introduced for improving scalability ans avoid such bottlenecks.</li>
<li><code>set_load_weight()</code>: initialization of <code>per-cpu</code> run queues with default values, we need to setup <code>load weight</code> of the first task in the system</li>
<li><code>init_sched_fair_class()</code>: Calculating next time period of the next calculation of CPU load and initialization of the <code>fair</code> class.</li>
</ol></li>
<li><b>TODO</b> <code>preempt_disable()</code>: disable preemption</li>
<li>check IRQs state and disabling</li>
<li><del>Initialization of the integer ID management</del></li>
<li><code>radix_tree_init()</code>: initialize kernel implementation of the <a href="http://en.wikipedia.org/wiki/Radix_tree">Radix tree</a></li>
<li><a href="#org0a92114">6.6</a> initialization:
<ol class="org-ol">
<li><code>rcu_bootup_announce()</code>: print information about the RCU</li>
<li><code>rcu_init_geometry()</code>: compute the node tree geometry depends on the amount of CPUs</li>
<li><code>rcu_init_one()</code>:</li>
</ol></li>
<li><code>trace_init()</code>: initialize <a href="https://en.wikipedia.org/wiki/Tracing_(software)">tracing</a> subsystem</li>
<li><code>early_irq_init()</code>:</li>
<li><code>init_IRQ()</code>:</li>
<li><code>tick_init</code>:
<ol class="org-ol">
<li><code>tick_broadcast_init()</code>: Initialization of <code>tick broadcast</code> framework related data structures.</li>
<li><code>tick_nohz_init()</code>: Initialization of <code>full</code> tickless mode relate data structures.</li>
</ol></li>
<li><code>init_timers()</code>:
<ol class="org-ol">
<li><code>init_timer_cpus()</code>: initialization of the <code>timer_base</code> structure for each processor.</li>
<li><code>open_softirq(TIMER_SOFTIRQ, run_timer_softirq)</code>:</li>
</ol></li>
<li><code>acpi_early_init()</code>:</li>
<li><code>thread_stack_cache_init()</code>: allocates cache for the <code>thread_stack_cache</code></li>
<li><code>cred_init()</code>: allocate cache for the credentials(like <code>uid</code>, <code>gid</code>, etc)</li>
<li><code>fork_init()</code>:
<ol class="org-ol">
<li><code>arch_task_cache_init()</code>: initialization of the architecture-specific caches.
allocate cache for the <code>task_xstate</code> which represents <code>FPU</code> state and sets up offsets and sizes of all extended states in <code>xsave</code> area.</li>
<li><code>set_max_threads(MAX_THREADS)</code>: calculate default maximum number of threads</li>
<li>initialize <code>signal</code> handler: set resource limit about signal</li>
</ol></li>
<li><code>proc_caches_init()</code>: allocate caches for the memory descriptors(or <code>mm_struct</code> structure)
<ol class="org-ol">
<li>allocate different <a href="http://en.wikipedia.org/wiki/Slab_allocation">SLAB</a> caches with the call of the <code>kmem_cache_create</code>
<ul class="org-ul">
<li><code>sighand_cachep</code>: manage information about installed signal handlers</li>
<li><code>signal_cachep</code>: manage information about process signal descriptor</li>
<li><code>files_cachep</code>: manage information about opened files</li>
<li><code>fs_cachep</code>: manage filesystem information</li>
<li><code>mm_cachep</code>: <code>mm_struct</code></li>
<li><code>vm_area_cachep</code>: allocate <code>SLAB</code> cache for the important <code>vm_area_struct</code> which used by the kernel to manage virtual memory space</li>
</ul></li>
<li><code>mmap_init()</code>: initialize virtual memory area <code>SLAB</code></li>
<li><code>nsproxy_cache_init()</code>: initialize <code>SLAB</code> for namespaces</li>
</ol></li>
<li><code>buffer_init()</code>:
<ul class="org-ul">
<li>allocate cache for the <code>buffer_head</code> (used for managing buffers)</li>
<li>calculate the maximum size of the buffers in memory(equal to the <code>10%</code> of the <code>ZONE_NORMAL(all RAM from the 4GB on the x86_64)</code>)</li>
</ul></li>
<li><code>vfs_caches_init()</code>:</li>
<li><code>pagecache_init()</code>: initialize the ratio for the dirty pages.</li>
<li><code>signals_init()</code>: allocate a cache for the <code>sigqueue</code> structures which represents queue of the real time signals.</li>
<li><code>proc_root_init()</code>: create the root for the <a href="https://en.wikipedia.org/wiki/Procfs">procfs</a></li>
<li><code>cgroup_init()</code>: make initialization of the rest of the cgroup subsystem</li>
<li><code>taskstats_init_early()</code>: export per-task statistic to the user-space</li>
<li><code>delayacct_init()</code>: initializes per-task delay accounting</li>
<li><code>check_bugs()</code>: fix some architecture dependent bugs</li>
<li><code>rest_init()</code>:
<ol class="org-ol">
<li><code>rcu_scheduler_starting()</code>: make RCU scheduler active</li>
<li><code>smpboot_thread_init()</code>: register the <code>smpboot_thread_notifier</code> CPU notifier</li>
<li></li>
</ol></li>
</ol>
</div>
</div>

<div id="outline-container-org90c37bf" class="outline-3">
<h3 id="org90c37bf"><span class="section-number-3">2.4</span> x86_init_ops</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">struct</span> <span class="org-type">x86_init_ops</span> <span class="org-type">x86_init</span> <span class="org-variable-name">__initdata</span> = {

        .resources = {
                .probe_roms             = probe_roms,
                .reserve_resources      = reserve_standard_io_resources,
                .memory_setup           = e820__memory_setup_default,
        },

        .mpparse = {
                .mpc_record             = x86_init_uint_noop,
                .setup_ioapic_ids       = x86_init_noop,
                .mpc_apic_id            = default_mpc_apic_id,
                .smp_read_mpc_oem       = default_smp_read_mpc_oem,
                .mpc_oem_bus_info       = default_mpc_oem_bus_info,
                .find_smp_config        = default_find_smp_config,
                .get_smp_config         = default_get_smp_config,
        },

        .irqs = {
                .pre_vector_init        = init_ISA_irqs,
                .intr_init              = native_init_IRQ,
                .trap_init              = x86_init_noop,
                .intr_mode_init         = apic_intr_mode_init
        },

        .oem = {
                .arch_setup             = x86_init_noop,
                .banner                 = default_banner,
        },

        .paging = {
                .pagetable_init         = native_pagetable_init,
        },

        .timers = {
                .setup_percpu_clockev   = setup_boot_APIC_clock,
                .timer_init             = hpet_time_init,
                .wallclock_init         = x86_init_noop,
        },

        .iommu = {
                .iommu_init             = iommu_init_noop,
        },

        .pci = {
                .init                   = x86_default_pci_init,
                .init_irq               = x86_default_pci_init_irq,
                .fixup_irqs             = x86_default_pci_fixup_irqs,
        },

        .hyper = {
                .init_platform          = x86_init_noop,
                .guest_late_init        = x86_init_noop,
                .x2apic_available       = bool_x86_init_noop,
                .init_mem_mapping       = x86_init_noop,
                .init_after_bootmem     = x86_init_noop,
        },

        .acpi = {
                .get_root_pointer       = x86_default_get_root_pointer,
                .reduced_hw_early_init  = acpi_generic_reduced_hw_init,
        },
};
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org236066b" class="outline-2">
<h2 id="org236066b"><span class="section-number-2">3</span> Memory management</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org184e72f" class="outline-3">
<h3 id="org184e72f"><span class="section-number-3">3.1</span> Paging</h3>
<div class="outline-text-3" id="text-3-1">
<p>
linux 采用五级分页模型
五种页表分别为:位数根据具体的计算机体系结构有关
</p>
<ul class="org-ul">
<li>页全局目录(page global directory)</li>
<li>p4d</li>
<li>页上级目录(page upper directory)</li>
<li>页中间目录(page middle directory)</li>
<li>页表(page table)</li>
</ul>
</div>

<div id="outline-container-orgb56b3af" class="outline-4">
<h4 id="orgb56b3af"><span class="section-number-4">3.1.1</span> arch x86</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
<b>TODO</b> PAE 分析
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">page mode</th>
<th scope="col" class="org-left">macro</th>
<th scope="col" class="org-right">PGD</th>
<th scope="col" class="org-right">P4D</th>
<th scope="col" class="org-right">PUD</th>
<th scope="col" class="org-right">PMD</th>
<th scope="col" class="org-right">PTE</th>
<th scope="col" class="org-left">max-lin</th>
</tr>

<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-left">-add-spac</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">PTRS_PER</td>
<td class="org-right">1024</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1024</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">32-bit</td>
<td class="org-left">SHIFT</td>
<td class="org-right">22</td>
<td class="org-right">22</td>
<td class="org-right">22</td>
<td class="org-right">22</td>
<td class="org-right">12</td>
<td class="org-left">4GB</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">SIZE</td>
<td class="org-right">4MB</td>
<td class="org-right">4MB</td>
<td class="org-right">4MB</td>
<td class="org-right">4MB</td>
<td class="org-right">4KB</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">PTRS_PER</td>
<td class="org-right">4</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">512</td>
<td class="org-right">512</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">PAE</td>
<td class="org-left">SHIFT</td>
<td class="org-right">30</td>
<td class="org-right">30</td>
<td class="org-right">30</td>
<td class="org-right">21</td>
<td class="org-right">12</td>
<td class="org-left">64GB</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">SIZE</td>
<td class="org-right">?</td>
<td class="org-right">2MB</td>
<td class="org-right">2MB</td>
<td class="org-right">2MB</td>
<td class="org-right">4KB</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">PTRS_PER</td>
<td class="org-right">512</td>
<td class="org-right">1</td>
<td class="org-right">512</td>
<td class="org-right">512</td>
<td class="org-right">512</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">4-level</td>
<td class="org-left">SHIFT</td>
<td class="org-right">39</td>
<td class="org-right">39</td>
<td class="org-right">30</td>
<td class="org-right">21</td>
<td class="org-right">12</td>
<td class="org-left">256TB</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">SIZE</td>
<td class="org-right">512GB</td>
<td class="org-right">512GB</td>
<td class="org-right">1GB</td>
<td class="org-right">2MB</td>
<td class="org-right">4KB</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">PTRS_PER</td>
<td class="org-right">512</td>
<td class="org-right">512</td>
<td class="org-right">512</td>
<td class="org-right">512</td>
<td class="org-right">512</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">5-level</td>
<td class="org-left">SHIFT</td>
<td class="org-right">48</td>
<td class="org-right">39</td>
<td class="org-right">30</td>
<td class="org-right">21</td>
<td class="org-right">12</td>
<td class="org-left">128PB</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">SIZE</td>
<td class="org-right">256TB</td>
<td class="org-right">512GB</td>
<td class="org-right">1GB</td>
<td class="org-right">2MB</td>
<td class="org-right">4KB</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
<code>arch/x86/include/asm/</code> 下的 <code>pgtable_types.h</code> 定义了页表格式, 其中包含
</p>
<ul class="org-ul">
<li>若配置 <code>x86_32</code> 包含 <code>pgtable_32_types.h</code>
<ul class="org-ul">
<li>若配置 <code>x86_PAE</code> 包含 <code>pgtable-3level_types.h</code>: PAE 相关定义</li>
<li>若没有配置 包含 <code>pgtable-2level_types.h</code>: 32-bit 相关定义</li>
</ul></li>
<li>若配置 <code>x86_64</code> 包含 <code>pgtable_64_types.h</code>: 4-level 和 5-level 相关定义</li>
</ul>
<p>
然后根据选择的分页模式修复(折叠)五种页表, 如果 <code>CONFIG_PGTABLE_LEVELS &lt; 4</code> 则包含 <code>include/asm-generic/pgtable-nop4d.h</code> (使 <code>P4D_PTRS_PER_P4D=1</code> 等等)。以此类推&#x2026;
</p>
</div>
</div>
</div>
<div id="outline-container-org5c5a8e0" class="outline-3">
<h3 id="org5c5a8e0"><span class="section-number-3">3.2</span> Memblock</h3>
<div class="outline-text-3" id="text-3-2">
<p>
<a id="orgcb5dd04"></a>
Memblock is a method of managing memory regions during the early boot period when the usual kernel memory allocators are not up and running.
Memblock views the system memory as collections of contiguous regions. There are several types of these collections:
</p>
<ul class="org-ul">
<li><code>memory</code>: describes the physical memory available to the kernel. This may differ from the actual physical memory installed in the system, for instance when the memory is restricted with</li>
<li><code>mem=</code>: command line parameter</li>
<li><code>reserved</code>: describes the regions that were allocated</li>
<li><code>physmap</code>: describes the actual physical memory regardless of the possible restrictions(the <code>physmap</code> type is only available on some architectures)</li>
</ul>

<p>
reference:
</p>
<ul class="org-ul">
<li><a href="https://www.kernel.org/doc/html/latest/core-api/boot-time-mm.html">https://www.kernel.org/doc/html/latest/core-api/boot-time-mm.html</a></li>
<li><a href="https://elixir.bootlin.com/linux/latest/source/mm/memblock.c">https://elixir.bootlin.com/linux/latest/source/mm/memblock.c</a></li>
<li><a href="https://elixir.bootlin.com/linux/latest/source/include/linux/memblock.h">https://elixir.bootlin.com/linux/latest/source/include/linux/memblock.h</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgf22d65f" class="outline-3">
<h3 id="orgf22d65f"><span class="section-number-3">3.3</span> ioremap</h3>
<div class="outline-text-3" id="text-3-3">
<p>
ioremap used to map device memory into kernel address space.
</p>
</div>
</div>
<div id="outline-container-org1c4d231" class="outline-3">
<h3 id="org1c4d231"><span class="section-number-3">3.4</span> mm_struct</h3>
<div class="outline-text-3" id="text-3-4">
<p>
<a id="org0286897"></a>
<a href="https://0xax.gitbooks.io/linux-insides/content/Initialization/linux-initialization-5.html">memory descriptor initialization</a>
</p>
</div>
</div>
<div id="outline-container-orgbd5663f" class="outline-3">
<h3 id="orgbd5663f"><span class="section-number-3">3.5</span> DMA</h3>
<div class="outline-text-3" id="text-3-5">
<p>
<a id="org8296bbc"></a>
Direct memory access
<a href="http://en.wikipedia.org/wiki/Direct_memory_access">http://en.wikipedia.org/wiki/Direct_memory_access</a>
</p>
</div>
</div>
<div id="outline-container-org6cf171a" class="outline-3">
<h3 id="org6cf171a"><span class="section-number-3">3.6</span> SLAB</h3>
<div class="outline-text-3" id="text-3-6">
<p>
The basic idea behind the slab allocator is to <b>have cache of commonly used object kept in an initialized state available</b> for use by the kernel. The slab allocator aims to cache the freed object so that the basic structure is preserved before uses.
</p>

<p>
The slab allocator has three principle aims:
</p>
<ol class="org-ol">
<li>The allocation of small blocks of memory to help eliminate internal fragmentation that would be otherwise caused by the buddy system. (<code>size-N and size-N(DMA)</code>)</li>
<li><p>
The caching of commonly used objects so that the system does not waste time allocating, initializing and destroying objects.
</p>

<p>
The slab allocator is to maintain caches of commonly used objects.
For many structures used in the kernel, the time needed to initialize an object is compareable to, or exceeds, the cost of allocating space for it.
</p></li>
<li>The better utilization of hardware cache by aligning objects to the L1 or L2 caches. (<code>slab coloring</code>, It is a scheme which attempts to have objects in different slabs use different lines in the cache).</li>
</ol>
</div>

<div id="outline-container-org0a8c7fc" class="outline-4">
<h4 id="org0a8c7fc"><span class="section-number-4">3.6.1</span> <code>kmem_cache</code></h4>
<div class="outline-text-4" id="text-3-6-1">
<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">struct</span> <span class="org-type">kmem_cache</span> {
        <span class="org-keyword">struct</span> <span class="org-type">array_cache</span> <span class="org-type">__percpu</span> *<span class="org-variable-name">cpu_cache</span>;

<span class="org-comment-delimiter">/* </span><span class="org-comment">1) Cache tunables. Protected by slab_mutex </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">batchcount</span>;
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">limit</span>;
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">shared</span>;

        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">size</span>;
        <span class="org-keyword">struct</span> <span class="org-type">reciprocal_value</span> <span class="org-variable-name">reciprocal_buffer_size</span>;
<span class="org-comment-delimiter">/* </span><span class="org-comment">2) touched by every alloc &amp; free from the backend </span><span class="org-comment-delimiter">*/</span>

        <span class="org-type">slab_flags_t</span> <span class="org-variable-name">flags</span>;             <span class="org-comment-delimiter">/* </span><span class="org-comment">constant flags </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">num</span>;               <span class="org-comment-delimiter">/* </span><span class="org-comment"># of objs per slab </span><span class="org-comment-delimiter">*/</span>

<span class="org-comment-delimiter">/* </span><span class="org-comment">3) cache_grow/shrink </span><span class="org-comment-delimiter">*/</span>
        <span class="org-comment-delimiter">/* </span><span class="org-comment">order of pgs per slab (2^n) </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">gfporder</span>;

        <span class="org-comment-delimiter">/* </span><span class="org-comment">force GFP flags, e.g. GFP_DMA </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">gfp_t</span> <span class="org-variable-name">allocflags</span>;

        <span class="org-type">size_t</span> <span class="org-variable-name">colour</span>;                  <span class="org-comment-delimiter">/* </span><span class="org-comment">cache colouring range </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">colour_off</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">colour offset </span><span class="org-comment-delimiter">*/</span>
        <span class="org-keyword">struct</span> <span class="org-type">kmem_cache</span> *<span class="org-variable-name">freelist_cache</span>;
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">freelist_size</span>;

        <span class="org-comment-delimiter">/* </span><span class="org-comment">constructor func </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">void</span> (*ctor)(<span class="org-type">void</span> *<span class="org-variable-name">obj</span>);

<span class="org-comment-delimiter">/* </span><span class="org-comment">4) cache creation/removal </span><span class="org-comment-delimiter">*/</span>
        <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>;
        <span class="org-keyword">struct</span> <span class="org-type">list_head</span> <span class="org-variable-name">list</span>;
        <span class="org-type">int</span> <span class="org-variable-name">refcount</span>;
        <span class="org-type">int</span> <span class="org-variable-name">object_size</span>;
        <span class="org-type">int</span> <span class="org-variable-name">align</span>;

<span class="org-comment-delimiter">/* </span><span class="org-comment">5) statistics </span><span class="org-comment-delimiter">*/</span>
<span class="org-preprocessor">#ifdef</span> CONFIG_DEBUG_SLAB
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">num_active</span>;
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">num_allocations</span>;
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">high_mark</span>;
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">grown</span>;
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">reaped</span>;
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">errors</span>;
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">max_freeable</span>;
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">node_allocs</span>;
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">node_frees</span>;
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">node_overflow</span>;
        <span class="org-type">atomic_t</span> <span class="org-variable-name">allochit</span>;
        <span class="org-type">atomic_t</span> <span class="org-variable-name">allocmiss</span>;
        <span class="org-type">atomic_t</span> <span class="org-variable-name">freehit</span>;
        <span class="org-type">atomic_t</span> <span class="org-variable-name">freemiss</span>;
<span class="org-preprocessor">#ifdef</span> CONFIG_DEBUG_SLAB_LEAK
        <span class="org-type">atomic_t</span> <span class="org-variable-name">store_user_clean</span>;
<span class="org-preprocessor">#endif</span>

        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * If debugging is enabled, then the allocator can add additional</span>
<span class="org-comment">         * fields and/or padding to every object. 'size' contains the total</span>
<span class="org-comment">         * object size including these internal fields, while 'obj_offset'</span>
<span class="org-comment">         * and 'object_size' contain the offset to the user object and its</span>
<span class="org-comment">         * size.</span>
<span class="org-comment">         </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">int</span> <span class="org-variable-name">obj_offset</span>;
<span class="org-preprocessor">#endif</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">CONFIG_DEBUG_SLAB </span><span class="org-comment-delimiter">*/</span>

<span class="org-preprocessor">#ifdef</span> CONFIG_MEMCG
        <span class="org-keyword">struct</span> <span class="org-type">memcg_cache_params</span> <span class="org-variable-name">memcg_params</span>;
<span class="org-preprocessor">#endif</span>
<span class="org-preprocessor">#ifdef</span> CONFIG_KASAN
        <span class="org-keyword">struct</span> <span class="org-type">kasan_cache</span> <span class="org-variable-name">kasan_info</span>;
<span class="org-preprocessor">#endif</span>

<span class="org-preprocessor">#ifdef</span> CONFIG_SLAB_FREELIST_RANDOM
        <span class="org-type">unsigned</span> <span class="org-type">int</span> *<span class="org-variable-name">random_seq</span>;
<span class="org-preprocessor">#endif</span>

        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">useroffset</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">Usercopy region offset </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">usersize</span>;          <span class="org-comment-delimiter">/* </span><span class="org-comment">Usercopy region size </span><span class="org-comment-delimiter">*/</span>

        <span class="org-keyword">struct</span> <span class="org-type">kmem_cache_node</span> *<span class="org-variable-name">node</span>[MAX_NUMNODES];
};

<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * The slab lists for all objects.</span>
<span class="org-comment"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">struct</span> <span class="org-type">kmem_cache_node</span> {
        <span class="org-type">spinlock_t</span> <span class="org-variable-name">list_lock</span>;

<span class="org-preprocessor">#ifdef</span> CONFIG_SLAB
        <span class="org-keyword">struct</span> <span class="org-type">list_head</span> <span class="org-variable-name">slabs_partial</span>; <span class="org-comment-delimiter">/* </span><span class="org-comment">partial list first, better asm code </span><span class="org-comment-delimiter">*/</span>
        <span class="org-keyword">struct</span> <span class="org-type">list_head</span> <span class="org-variable-name">slabs_full</span>;
        <span class="org-keyword">struct</span> <span class="org-type">list_head</span> <span class="org-variable-name">slabs_free</span>;
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">total_slabs</span>;      <span class="org-comment-delimiter">/* </span><span class="org-comment">length of all slab lists </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">free_slabs</span>;       <span class="org-comment-delimiter">/* </span><span class="org-comment">length of free slab list only </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">free_objects</span>;
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">free_limit</span>;
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">colour_next</span>;       <span class="org-comment-delimiter">/* </span><span class="org-comment">Per-node cache coloring </span><span class="org-comment-delimiter">*/</span>
        <span class="org-keyword">struct</span> <span class="org-type">array_cache</span> *<span class="org-variable-name">shared</span>;     <span class="org-comment-delimiter">/* </span><span class="org-comment">shared per node </span><span class="org-comment-delimiter">*/</span>
        <span class="org-keyword">struct</span> <span class="org-type">alien_cache</span> **<span class="org-variable-name">alien</span>;     <span class="org-comment-delimiter">/* </span><span class="org-comment">on other nodes </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">next_reap</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">updated without locking </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">int</span> <span class="org-variable-name">free_touched</span>;               <span class="org-comment-delimiter">/* </span><span class="org-comment">updated without locking </span><span class="org-comment-delimiter">*/</span>
<span class="org-preprocessor">#endif</span>

<span class="org-preprocessor">#ifdef</span> CONFIG_SLUB
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">nr_partial</span>;
        <span class="org-keyword">struct</span> <span class="org-type">list_head</span> <span class="org-variable-name">partial</span>;
<span class="org-preprocessor">#ifdef</span> CONFIG_SLUB_DEBUG
        <span class="org-type">atomic_long_t</span> <span class="org-variable-name">nr_slabs</span>;
        <span class="org-type">atomic_long_t</span> <span class="org-variable-name">total_objects</span>;
        <span class="org-keyword">struct</span> <span class="org-type">list_head</span> <span class="org-variable-name">full</span>;
<span class="org-preprocessor">#endif</span>
<span class="org-preprocessor">#endif</span>

};
</pre>
</div>

<p>
Basic Structure:
The slab allocator consists of a variable number of caches that are linked together on a doubly linked circular list called a <code>cache chain</code>.
</p>


<div class="figure">
<p><img src="image/slab_structure.png" alt="slab_structure.png" />
</p>
</div>


<ul class="org-ul">
<li><code>kmem_cache</code>:</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org6b0c32e" class="outline-3">
<h3 id="org6b0c32e"><span class="section-number-3">3.7</span> SLUB</h3>
</div>
</div>

<div id="outline-container-org98ba58e" class="outline-2">
<h2 id="org98ba58e"><span class="section-number-2">4</span> Interrupts</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Advanced_Programmable_Interrupt_Controller">APIC</a></li>
</ul>

<p>
the state of stack when an exception occurs is following:
</p>
<pre class="example">
    +------------+
+40 | %SS        |
+32 | %RSP       |
+24 | %EFLAGS    |
+16 | %CS        |
 +8 | %RIP       |
  0 | ERROR CODE | &lt;-- %RSP
    +------------+
</pre>
</div>

<div id="outline-container-org6b155a3" class="outline-3">
<h3 id="org6b155a3"><span class="section-number-3">4.1</span> exception-tables</h3>
<div class="outline-text-3" id="text-4-1">
<p>
<a id="org40e4b81"></a>
异常表位于段 <code>.__ex_table</code> 中，保存着指定代码地址的异常处理。
There it uses the address of the instruction that caused the exception(i.e. <code>regs-&gt;eip</code>) to <b>find an address where the execution can continue(fixup) and execution customized exception handler function</b>. If this search is successful, the fault handler modifies the return address (again regs-&gt;eip) and returns. The execution will continue at the address in <code>fixup</code>.
</p>
</div>

<div id="outline-container-orgdc35f59" class="outline-4">
<h4 id="orgdc35f59"><span class="section-number-4">4.1.1</span> <code>__ex_table</code> 结构</h4>
<div class="outline-text-4" id="text-4-1-1">
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/include/asm/extable.h</span>
<span class="org-keyword">struct</span> <span class="org-type">exception_table_entry</span> {
        <span class="org-type">int</span> <span class="org-variable-name">insn</span>, <span class="org-variable-name">fixup</span>, <span class="org-variable-name">handler</span>;
};
</pre>
</div>
<div class="org-src-container">
<pre class="src src-asm">  <span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/include/asm/asm.h</span>
<span class="org-preprocessor"># define</span> <span class="org-function-name">_ASM_EXTABLE_HANDLE</span>(<span class="org-variable-name">from</span>, <span class="org-variable-name">to</span>, <span class="org-variable-name">handler</span>)   \
         <span class="org-keyword">.pushsection</span> <span class="org-string">"__ex_table"</span>,<span class="org-string">"a"</span> <span class="org-comment-delimiter">;          </span><span class="org-comment">\</span>
         <span class="org-keyword">.balign</span> <span class="org-highlight-numbers-number">4</span> <span class="org-comment-delimiter">;                              </span><span class="org-comment">\</span>
         <span class="org-keyword">.long</span> (from) - . <span class="org-comment-delimiter">;                       </span><span class="org-comment">\</span>
         <span class="org-keyword">.long</span> (to) - . <span class="org-comment-delimiter">;                         </span><span class="org-comment">\</span>
         <span class="org-keyword">.long</span> (handler) - . <span class="org-comment-delimiter">;                    </span><span class="org-comment">\</span>
         <span class="org-keyword">.popsection</span>                              \
</pre>
</div>
<ul class="org-ul">
<li><code>insn</code>: 指定代码(可能发生异常)的地址和异常表位置的相对偏移</li>
<li><code>fixup</code>: 异常处理结束返回的地址(通常位于 <code>.fixup</code> 段中)和异常表位置的相对偏移
<code>.fixup</code> 里的代码包含 <code>jmp</code> 跳转回 <code>from</code> 之后得代码</li>
<li><code>handler</code>: 异常处理的地址和异常表位置的相对偏移</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org0aa9f62" class="outline-3">
<h3 id="org0aa9f62"><span class="section-number-3">4.2</span> early interrupt handler</h3>
<div class="outline-text-3" id="text-4-2">
<p>
<a id="org2e73625"></a>
</p>
<ul class="org-ul">
<li><p>
设置中断: 填充 <code>idt_descr</code> 并将 idt_descr 的地址加载到 idt
</p>
<ul class="org-ul">
<li>x86_64: 为前32个中断(异常)设置中断处理程序 <a href="#orgcda689c">4.3.2</a></li>
<li>x86_32: 为所有的中断设置中断处理程序 <a href="#orge5290cf">4.3.3</a></li>
</ul>
<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">extern</span> <span class="org-type">gate_desc</span> <span class="org-variable-name">idt_table</span>[]; <span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/include/asm/desc.h</span>
<span class="org-type">gate_desc</span> <span class="org-variable-name">idt_table</span>[IDT_ENTRIES] __page_aligned_bss; <span class="org-comment-delimiter">// </span><span class="org-comment">IDT_ENTRIES 256 arch/x86/kernel/idt.c</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgfbb1be9" class="outline-3">
<h3 id="orgfbb1be9"><span class="section-number-3">4.3</span> interrupt handler function</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-org937c057" class="outline-4">
<h4 id="org937c057"><span class="section-number-4">4.3.1</span> interrelated macro</h4>
<div class="outline-text-4" id="text-4-3-1">
<ul class="org-ul">
<li><p>
<code>idtentry</code>: define an interrupt/exception entry point, and do following preparation before an actual exception handler.
<code>idtentry</code> allocates place for the registers(<code>pt_regs</code> structure) on the stack, pushes dump error code for the stack consistency if an interrupt/exception has no error code, checks the segment selector in the <code>cs</code> segment register and switches depends on the previous stats(userspace or kernelspace)
</p>
<ul class="org-ul">
<li><code>sym</code>: name of the interrupt entry point</li>
<li><code>do_sym</code>: name of the interrupt handler</li>
<li><code>has_error_code</code>: has interrupt error code or not, information about existence of an error code of exception</li>
<li><code>paranoid</code>:  show us how we need to check current mode
helps us to know did we come from userpace or not to an exception handler.</li>
<li><code>shift_ist</code>: show us is an exception running at <code>Interrupt Stack Table</code>
Interrupt Stack Table: This feature allows to switch to a new stack for designated events such as an atomic exceptions like <code>double fault</code> and etc.</li>
</ul>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.macro</span> idtentry sym do_sym has_error_code:req paranoid=0 shift_ist=-1
<span class="org-function-name">ENTRY</span>(\sym)
        <span class="org-keyword">UNWIND_HINT_IRET_REGS</span> offset=\has_error_code*<span class="org-highlight-numbers-number">8</span>

        <span class="org-comment-delimiter">/* </span><span class="org-comment">Sanity check */</span>
        <span class="org-keyword">.if</span> \shift_ist != -1 &amp;&amp; \paranoid == <span class="org-highlight-numbers-number">0</span>
        <span class="org-keyword">.error</span> <span class="org-string">"using shift_ist requires paranoid=1"</span>
        <span class="org-keyword">.endif</span>

        <span class="org-keyword">ASM_CLAC</span>

        <span class="org-keyword">.if</span> \has_error_code == <span class="org-highlight-numbers-number">0</span>
        <span class="org-keyword">pushq</span>   $-1                             <span class="org-comment-delimiter">/* </span><span class="org-comment">ORIG_RAX: no syscall to restart */</span>
        <span class="org-keyword">.endif</span>

        <span class="org-keyword">.if</span> \paranoid == <span class="org-highlight-numbers-number">1</span>
        <span class="org-keyword">testb</span>   $3, CS-ORIG_RAX(<span class="org-variable-name">%rsp</span>)           <span class="org-comment-delimiter">/* </span><span class="org-comment">If coming from userspace, switch stacks */</span>
        <span class="org-keyword">jnz</span>     .Lfrom_usermode_switch_stack_\@
        <span class="org-keyword">.endif</span>

        <span class="org-keyword">.if</span> \paranoid
        <span class="org-keyword">call</span>    paranoid_entry
        <span class="org-keyword">.else</span>
        <span class="org-keyword">call</span>    error_entry
        <span class="org-keyword">.endif</span>
        <span class="org-keyword">UNWIND_HINT_REGS</span>
        <span class="org-comment-delimiter">/* </span><span class="org-comment">returned flag: ebx=0: need swapgs on exit, ebx=1: don't need it */</span>

        <span class="org-keyword">.if</span> \paranoid
        <span class="org-keyword">.if</span> \shift_ist != -1
        <span class="org-keyword">TRACE_IRQS_OFF_DEBUG</span>                    <span class="org-comment-delimiter">/* </span><span class="org-comment">reload IDT in case of recursion */</span>
        <span class="org-keyword">.else</span>
        <span class="org-keyword">TRACE_IRQS_OFF</span>
        <span class="org-keyword">.endif</span>
        <span class="org-keyword">.endif</span>

        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rsp</span>, <span class="org-variable-name">%rdi</span>                      <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs pointer */</span>

        <span class="org-keyword">.if</span> \has_error_code
        <span class="org-keyword">movq</span>    ORIG_RAX(<span class="org-variable-name">%rsp</span>), <span class="org-variable-name">%rsi</span>            <span class="org-comment-delimiter">/* </span><span class="org-comment">get error code */</span>
        <span class="org-keyword">movq</span>    $-1, ORIG_RAX(<span class="org-variable-name">%rsp</span>)             <span class="org-comment-delimiter">/* </span><span class="org-comment">no syscall to restart */</span>
        <span class="org-keyword">.else</span>
        <span class="org-keyword">xorl</span>    <span class="org-variable-name">%esi</span>, <span class="org-variable-name">%esi</span>                      <span class="org-comment-delimiter">/* </span><span class="org-comment">no error code */</span>
        <span class="org-keyword">.endif</span>

        <span class="org-keyword">.if</span> \shift_ist != -1
        <span class="org-keyword">subq</span>    $EXCEPTION_STKSZ, CPU_TSS_IST(\shift_ist)
        <span class="org-keyword">.endif</span>

        <span class="org-keyword">call</span>    \do_sym

        <span class="org-keyword">.if</span> \shift_ist != -1
        <span class="org-keyword">addq</span>    $EXCEPTION_STKSZ, CPU_TSS_IST(\shift_ist)
        <span class="org-keyword">.endif</span>

        <span class="org-comment-delimiter">/* </span><span class="org-comment">these procedures expect "no swapgs" flag in ebx */</span>
        <span class="org-keyword">.if</span> \paranoid
        <span class="org-keyword">jmp</span>     paranoid_exit
        <span class="org-keyword">.else</span>
        <span class="org-keyword">jmp</span>     error_exit
        <span class="org-keyword">.endif</span>

        <span class="org-keyword">.if</span> \paranoid == <span class="org-highlight-numbers-number">1</span>
        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * Entry from userspace.  Switch stacks and treat it</span>
<span class="org-comment">         * as a normal entry.  This means that paranoid handlers</span>
<span class="org-comment">         * run in real process context if user_mode(regs).</span>
<span class="org-comment">         */</span>
<span class="org-keyword">.Lfrom_usermode_switch_stack</span>_\@:
        <span class="org-keyword">call</span>    error_entry

        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rsp</span>, <span class="org-variable-name">%rdi</span>                      <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs pointer */</span>

        <span class="org-keyword">.if</span> \has_error_code
        <span class="org-keyword">movq</span>    ORIG_RAX(<span class="org-variable-name">%rsp</span>), <span class="org-variable-name">%rsi</span>            <span class="org-comment-delimiter">/* </span><span class="org-comment">get error code */</span>
        <span class="org-keyword">movq</span>    $-1, ORIG_RAX(<span class="org-variable-name">%rsp</span>)             <span class="org-comment-delimiter">/* </span><span class="org-comment">no syscall to restart */</span>
        <span class="org-keyword">.else</span>
        <span class="org-keyword">xorl</span>    <span class="org-variable-name">%esi</span>, <span class="org-variable-name">%esi</span>                      <span class="org-comment-delimiter">/* </span><span class="org-comment">no error code */</span>
        <span class="org-keyword">.endif</span>

        <span class="org-keyword">call</span>    \do_sym

        <span class="org-keyword">jmp</span>     error_exit
        <span class="org-keyword">.endif</span>
<span class="org-function-name">END</span>(\sym)
<span class="org-keyword">.endm</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org421af98" class="outline-4">
<h4 id="org421af98"><span class="section-number-4">4.3.2</span> <code>early_idt_handler_array</code></h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
<a id="orgcda689c"></a>
<code>early_idt_handler_array</code> 是 32 个大小为 9 字节程序的数组
如果异常有错误代码，什么也不做。如果异常没有错误代码 将 0 压入栈(保持栈统一)。然后将中断向量号压栈并调用 <code>early_idt_handler_common</code>
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">// </span><span class="org-comment">NUM_EXCEPTION_VECTORS 32, EARLY_IDT_HANDLER_SIZE 9</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/include/asm/segment.h</span>
<span class="org-function-name">extern</span> <span class="org-keyword">const</span> char early_idt_handler_array[NUM_EXCEPTION_VECTORS][EARLY_IDT_HANDLER_SIZE]<span class="org-comment-delimiter">;</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/kernel/head_64.S</span>
<span class="org-function-name">ENTRY</span>(early_idt_handler_array)
        <span class="org-keyword">i</span> = <span class="org-highlight-numbers-number">0</span>
        <span class="org-keyword">.rept</span> NUM_EXCEPTION_VECTORS
        <span class="org-keyword">.if</span> ((EXCEPTION_ERRCODE_MASK &gt;&gt; i) &amp; <span class="org-highlight-numbers-number">1</span>) == <span class="org-highlight-numbers-number">0</span>
                <span class="org-keyword">UNWIND_HINT_IRET_REGS</span>
                <span class="org-keyword">pushq</span> $0        # Dummy error code, to make stack frame uniform
        <span class="org-keyword">.else</span>
                <span class="org-keyword">UNWIND_HINT_IRET_REGS</span> offset=8
        <span class="org-keyword">.endif</span>
        <span class="org-keyword">pushq</span> $i                # <span class="org-highlight-numbers-number">72</span>(<span class="org-variable-name">%rsp</span>) Vector number
        <span class="org-keyword">jmp</span> early_idt_handler_common
        <span class="org-keyword">UNWIND_HINT_IRET_REGS</span>
        <span class="org-keyword">i</span> = i + <span class="org-highlight-numbers-number">1</span>
        <span class="org-keyword">.fill</span> early_idt_handler_array + i*EARLY_IDT_HANDLER_SIZE - ., <span class="org-highlight-numbers-number">1</span>, <span class="org-highlight-numbers-number">0xcc</span>
        <span class="org-keyword">.endr</span>
        <span class="org-keyword">UNWIND_HINT_IRET_REGS</span> offset=16
<span class="org-function-name">END</span>(early_idt_handler_array)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/kernel/head_64.S</span>
<span class="org-function-name">early_idt_handler_common</span>:
        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * The stack is the hardware frame, an error code or zero, and the</span>
<span class="org-comment">         * vector number.</span>
<span class="org-comment">         */</span>
        <span class="org-keyword">cld</span>

        <span class="org-keyword">incl</span> early_recursion_flag(<span class="org-variable-name">%rip</span>)

        <span class="org-comment-delimiter">/* </span><span class="org-comment">The vector number is currently in the pt_regs-&gt;di slot. */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%rsi</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;si */</span>
        <span class="org-keyword">movq</span> <span class="org-highlight-numbers-number">8</span>(<span class="org-variable-name">%rsp</span>), <span class="org-variable-name">%rsi</span>                      <span class="org-comment-delimiter">/* </span><span class="org-comment">RSI = vector number */</span>
        <span class="org-keyword">movq</span> <span class="org-variable-name">%rdi</span>, <span class="org-highlight-numbers-number">8</span>(<span class="org-variable-name">%rsp</span>)                      <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;di = RDI */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%rdx</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;dx */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%rcx</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;cx */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%rax</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;ax */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r8</span>                               <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r8 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r9</span>                               <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r9 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r10</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r10 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r11</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r11 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%rbx</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;bx */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%rbp</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;bp */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r12</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r12 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r13</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r13 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r14</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r14 */</span>
        <span class="org-keyword">pushq</span> <span class="org-variable-name">%r15</span>                              <span class="org-comment-delimiter">/* </span><span class="org-comment">pt_regs-&gt;r15 */</span>
        <span class="org-keyword">UNWIND_HINT_REGS</span>

        <span class="org-keyword">cmpq</span> $14,<span class="org-variable-name">%rsi</span>           <span class="org-comment-delimiter">/* </span><span class="org-comment">Page fault? */</span>
        <span class="org-keyword">jnz</span> <span class="org-highlight-numbers-number">10f</span>
        <span class="org-keyword">GET_CR2_INTO</span>(<span class="org-variable-name">%rdi</span>)      <span class="org-comment-delimiter">/* </span><span class="org-comment">Can clobber any volatile register if pv */</span>
        <span class="org-keyword">call</span> early_make_pgtable
        <span class="org-keyword">andl</span> <span class="org-variable-name">%eax</span>,<span class="org-variable-name">%eax</span>
        <span class="org-keyword">jz</span> <span class="org-highlight-numbers-number">20f</span>                  <span class="org-comment-delimiter">/* </span><span class="org-comment">All good */</span>

<span class="org-highlight-numbers-number">10</span>:
        <span class="org-keyword">movq</span> <span class="org-variable-name">%rsp</span>,<span class="org-variable-name">%rdi</span>          <span class="org-comment-delimiter">/* </span><span class="org-comment">RDI = pt_regs; RSI is already trapnr */</span>
        <span class="org-keyword">call</span> early_fixup_exception

<span class="org-highlight-numbers-number">20</span>:
        <span class="org-keyword">decl</span> early_recursion_flag(<span class="org-variable-name">%rip</span>)
        <span class="org-keyword">jmp</span> restore_regs_and_return_to_kernel
<span class="org-function-name">END</span>(early_idt_handler_common)
</pre>
</div>

<ul class="org-ul">
<li><code>early_idt_handler_common</code>: 保存相关的寄存器，根据 <code>vector number</code> 调用相应得异常处理函数
<ul class="org-ul">
<li><code>early_make_pgtable</code>:
<ol class="org-ol">
<li>检查是否是无效地址，或者 early pgt 是否完成</li>
<li>检查异常地址在不同等级的页表所在位置的值。
<ul class="org-ul">
<li>不为零: 向下级页表搜索</li>
<li>为零: 检查 <code>early_dynamic_pgts</code> 是否超过 64 若超过则重置，然后为异常地址所在位置的页表设置地址。</li>
</ul></li>
</ol></li>
<li><code>early_fixup_exception</code>: 针对非 fault page 异常的处理
<ol class="org-ol">
<li>忽略 <code>X86_TRAP_NMI</code> 异常</li>
<li>搜索异常表 <a href="#org40e4b81">4.1</a></li>
<li>处理 bug 异常</li>
<li>打印相关异常信息</li>
</ol></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgd0c1598" class="outline-4">
<h4 id="orgd0c1598"><span class="section-number-4">4.3.3</span> <code>early_ignore_irq</code></h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
<a id="orge5290cf"></a>
</p>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">/* </span><span class="org-comment">This is the default interrupt "handler" :- */</span>
<span class="org-function-name">ENTRY</span>(early_ignore_irq)
        <span class="org-keyword">cld</span>
<span class="org-preprocessor">#ifdef</span> <span class="org-variable-name">CONFIG_PRINTK</span>
        <span class="org-keyword">pushl</span> <span class="org-variable-name">%eax</span>
        <span class="org-keyword">pushl</span> <span class="org-variable-name">%ecx</span>
        <span class="org-keyword">pushl</span> <span class="org-variable-name">%edx</span>
        <span class="org-keyword">pushl</span> <span class="org-variable-name">%es</span>
        <span class="org-keyword">pushl</span> <span class="org-variable-name">%ds</span>
        <span class="org-keyword">movl</span> $(__KERNEL_DS),<span class="org-variable-name">%eax</span>
        <span class="org-keyword">movl</span> <span class="org-variable-name">%eax</span>,<span class="org-variable-name">%ds</span>
        <span class="org-keyword">movl</span> <span class="org-variable-name">%eax</span>,<span class="org-variable-name">%es</span>
        <span class="org-keyword">cmpl</span> $2,early_recursion_flag
        <span class="org-keyword">je</span> hlt_loop
        <span class="org-keyword">incl</span> early_recursion_flag
        <span class="org-keyword">pushl</span> <span class="org-highlight-numbers-number">16</span>(<span class="org-variable-name">%esp</span>)
        <span class="org-keyword">pushl</span> <span class="org-highlight-numbers-number">24</span>(<span class="org-variable-name">%esp</span>)
        <span class="org-keyword">pushl</span> <span class="org-highlight-numbers-number">32</span>(<span class="org-variable-name">%esp</span>)
        <span class="org-keyword">pushl</span> <span class="org-highlight-numbers-number">40</span>(<span class="org-variable-name">%esp</span>)
        <span class="org-keyword">pushl</span> $int_msg
        <span class="org-keyword">call</span> printk

        <span class="org-keyword">call</span> dump_stack

        <span class="org-keyword">addl</span> $(<span class="org-highlight-numbers-number">5</span>*<span class="org-highlight-numbers-number">4</span>),<span class="org-variable-name">%esp</span>
        <span class="org-keyword">popl</span> <span class="org-variable-name">%ds</span>
        <span class="org-keyword">popl</span> <span class="org-variable-name">%es</span>
        <span class="org-keyword">popl</span> <span class="org-variable-name">%edx</span>
        <span class="org-keyword">popl</span> <span class="org-variable-name">%ecx</span>
        <span class="org-keyword">popl</span> <span class="org-variable-name">%eax</span>
<span class="org-preprocessor">#endif</span>
        <span class="org-keyword">iret</span>

<span class="org-function-name">hlt_loop</span>:
        <span class="org-keyword">hlt</span>
        <span class="org-keyword">jmp</span> hlt_loop
<span class="org-function-name">ENDPROC</span>(early_ignore_irq)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf9e5170" class="outline-4">
<h4 id="orgf9e5170"><span class="section-number-4">4.3.4</span> <code>debug</code></h4>
<div class="outline-text-4" id="text-4-3-4">
<p>
<a id="orga314a9b"></a>
<code>#DB</code> or <code>debug</code> exception occurs when a debug event occurs.
<a href="https://en.wikipedia.org/wiki/X86_debug_registerx">x86 debug register</a>
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/include/asm/trap.h</span>
asmlinkage <span class="org-type">void</span> <span class="org-function-name">debug</span>(<span class="org-type">void</span>);
<span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/entry/entry_64.S</span>
idtentry debug <span class="org-type">do_debug</span> <span class="org-variable-name">has_error_code</span>=<span class="org-highlight-numbers-number">0</span> paranoid=<span class="org-highlight-numbers-number">1</span> shift_ist=DEBUG_STACK
</pre>
</div>

<pre class="example">
+-----------------------------------------------------+
|Vector|Mnemonic|Description         |Type |Error Code|
+-----------------------------------------------------+
|1     | #DB    |Reserved            |F/T  |NO        |
+-----------------------------------------------------+
</pre>
</div>
</div>

<div id="outline-container-org9e7e9bd" class="outline-4">
<h4 id="org9e7e9bd"><span class="section-number-4">4.3.5</span> <code>int3</code></h4>
<div class="outline-text-4" id="text-4-3-5">
<p>
<a id="orge557b4b"></a>
<code>#BP</code> or <code>breakpoint</code> exception occurs when processor executes the <code>int3</code> instruction.
</p>
</div>
</div>

<div id="outline-container-org08449b3" class="outline-4">
<h4 id="org08449b3"><span class="section-number-4">4.3.6</span> <code>page_fault</code></h4>
<div class="outline-text-4" id="text-4-3-6">
<p>
<a id="org8ea2748"></a>
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/include/asm/trap.h</span>
asmlinkage <span class="org-type">void</span> <span class="org-function-name">page_fault</span>(<span class="org-type">void</span>);
<span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/entry/entry_64.S</span>
idtentry page_fault             <span class="org-type">do_page_fault</span>           <span class="org-variable-name">has_error_code</span>=<span class="org-highlight-numbers-number">1</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-C">dotraplinkage <span class="org-type">void</span> <span class="org-function-name">notrace</span>
do_page_fault(<span class="org-keyword">struct</span> <span class="org-type">pt_regs</span> *<span class="org-variable-name">regs</span>, <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">error_code</span>)
{
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">address</span> = read_cr2(); <span class="org-comment-delimiter">/* </span><span class="org-comment">Get the faulting address </span><span class="org-comment-delimiter">*/</span>
        <span class="org-keyword">enum</span> <span class="org-type">ctx_state</span> <span class="org-variable-name">prev_state</span>;

        prev_state = exception_enter();
        <span class="org-keyword">if</span> (trace_pagefault_enabled())
                trace_page_fault_entries(address, regs, error_code);

        __do_page_fault(regs, error_code, address);
        exception_exit(prev_state);
}
<span class="org-function-name">NOKPROBE_SYMBOL</span>(do_page_fault);
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf0f5ba5" class="outline-3">
<h3 id="orgf0f5ba5"><span class="section-number-3">4.4</span> external interrupts</h3>
</div>
</div>

<div id="outline-container-org56dff23" class="outline-2">
<h2 id="org56dff23"><span class="section-number-2">5</span> Syscall</h2>
<div class="outline-text-2" id="text-5">
<p>
A system call is just userspace request of kernel function. Userspace use <code>SYSCALL</code> instruction to invoke an OS system-call handler at privilege level 0.
</p>

<ul class="org-ul">
<li><code>SYSCALL/SYSRET</code>:
<ul class="org-ul">
<li>load <code>RIP</code> from the <code>IA32_LSTAR MSR</code></li>
<li>save <code>RFLAGS</code> into <code>R11</code> and then masks <code>RFLAGS</code> using the <code>IA32_FMASK MSR</code></li>
<li>load the CS and SS selectors with values derived from bits <code>47:32</code> of the <code>IA32_STAR MSR</code></li>
<li>The instruction <b>does not save the stack pointer</b> which from userspace, thus user have to save the stack pointer for myself.</li>
</ul></li>
<li><b>TODO</b> <code>SYSENTER/SYSEXIT</code></li>
</ul>
</div>

<div id="outline-container-orge349abb" class="outline-3">
<h3 id="orge349abb"><span class="section-number-3">5.1</span> implement</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Linux kernel provide a system calls table that is called <code>sys_call_table</code> (<code>arch/x86/entry/system_64.c</code>). System searches <code>sys_call_table</code> by when userspace invokes <code>SYSCALL</code>
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-type">asmlinkage</span> <span class="org-keyword">const</span> <span class="org-variable-name">sys_call_ptr_t</span> sys_call_table[__NR_syscall_max+<span class="org-highlight-numbers-number">1</span>] = {
        [<span class="org-highlight-numbers-number">0</span> ... __NR_syscall_max] = &amp;sys_ni_syscall,
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;asm/syscalls_64.h&gt;</span>
};
</pre>
</div>

<ul class="org-ul">
<li><code>sys_ni_syscall</code>: function not implemented</li>
<li><code>__NR_syscall_max</code>: maximum number of system calls</li>
<li><code>asm/syscalls_64.h</code>: the header file is generated by the special script at <code>arch/x86/entry/syscall/syscalltbl.sh</code> and generates our header file from the syscall table.</li>
</ul>
</div>

<div id="outline-container-org78882a6" class="outline-4">
<h4 id="org78882a6"><span class="section-number-4">5.1.1</span> entry_SYSCALL_64</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
<b>TODO</b>
<code>entry_SYSCALL_64</code> do the preparations required before a system call handler will be executed.
</p>
<ol class="org-ol">
<li>call <code>swapgs</code> that exchanges the current GS base register value contained in the <code>MSR_KERNEL_GS_BASE</code> mode specific(move it on to the kernel stack)</li>
<li></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org8101cab" class="outline-3">
<h3 id="org8101cab"><span class="section-number-3">5.2</span> initialization</h3>
<div class="outline-text-3" id="text-5-2">
<p>
<code>arch/x86/kernel/cpu/common.c syscall_init()</code>
<a id="orgaf435b7"></a>
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-type">void</span> <span class="org-function-name">syscall_init</span>(<span class="org-type">void</span>)
{
        <span class="org-keyword">extern</span> <span class="org-type">char</span> <span class="org-variable-name">_entry_trampoline</span>[];
        <span class="org-keyword">extern</span> <span class="org-type">char</span> <span class="org-variable-name">entry_SYSCALL_64_trampoline</span>[];

        <span class="org-type">int</span> <span class="org-variable-name">cpu</span> = smp_processor_id();
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">SYSCALL64_entry_trampoline</span> =
                (<span class="org-type">unsigned</span> <span class="org-type">long</span>)get_cpu_entry_area(cpu)-&gt;entry_trampoline +
                (entry_SYSCALL_64_trampoline - _entry_trampoline);
        <span class="org-comment-delimiter">// </span><span class="org-comment">63:48 bits of the user code segment</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">47:32 bits of the kernel code segment</span>
        wrmsr(MSR_STAR, <span class="org-highlight-numbers-number">0</span>, (__USER32_CS &lt;&lt; <span class="org-highlight-numbers-number">16</span>) | __KERNEL_CS);

        <span class="org-keyword">if</span> (static_cpu_has(X86_FEATURE_PTI))
                wrmsrl(MSR_LSTAR, SYSCALL64_entry_trampoline);
        <span class="org-keyword">else</span>
                wrmsrl(MSR_LSTAR, (<span class="org-type">unsigned</span> <span class="org-type">long</span>)entry_SYSCALL_64);

        <span class="org-comment-delimiter">// </span><span class="org-comment">for sysenter/sysexit instruction</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">for supporting 32</span>
<span class="org-preprocessor">#ifdef</span> CONFIG_IA32_EMULATION
        wrmsrl(MSR_CSTAR, (<span class="org-type">unsigned</span> <span class="org-type">long</span>)entry_SYSCALL_compat);
        wrmsrl_safe(MSR_IA32_SYSENTER_CS, (<span class="org-type">u64</span>)__KERNEL_CS);
        wrmsrl_safe(MSR_IA32_SYSENTER_ESP, (<span class="org-type">unsigned</span> <span class="org-type">long</span>)(cpu_entry_stack(cpu) + <span class="org-highlight-numbers-number">1</span>));
        wrmsrl_safe(MSR_IA32_SYSENTER_EIP, (<span class="org-type">u64</span>)entry_SYSENTER_compat);
<span class="org-preprocessor">#else</span>
        wrmsrl(MSR_CSTAR, (<span class="org-type">unsigned</span> <span class="org-type">long</span>)ignore_sysret);
        wrmsrl_safe(MSR_IA32_SYSENTER_CS, (<span class="org-type">u64</span>)GDT_ENTRY_INVALID_SEG);
        wrmsrl_safe(MSR_IA32_SYSENTER_ESP, <span class="org-highlight-numbers-number">0ULL</span>);
        wrmsrl_safe(MSR_IA32_SYSENTER_EIP, <span class="org-highlight-numbers-number">0ULL</span>);
<span class="org-preprocessor">#endif</span>

        <span class="org-comment-delimiter">/* </span><span class="org-comment">Flags to clear on syscall </span><span class="org-comment-delimiter">*/</span>
        wrmsrl(MSR_SYSCALL_MASK,
               X86_EFLAGS_TF|X86_EFLAGS_DF|X86_EFLAGS_IF|
               X86_EFLAGS_IOPL|X86_EFLAGS_AC|X86_EFLAGS_NT);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5edf0ae" class="outline-3">
<h3 id="org5edf0ae"><span class="section-number-3">5.3</span> vsyscall and vDSO</h3>
<div class="outline-text-3" id="text-5-3">
<p>
These two mechanisms - <code>vsyscall</code> and <code>vDSO</code> are designed to speed up this process for certain system calls.
</p>

<p>
principle:
</p>
<ul class="org-ul">
<li>vsyscall: The Linux kernel maps into user space a page that contain some variables and the implementation of some system calls.</li>
<li>vDSO: <code>vDSO</code> maps memory pages into each process in a shared object from.</li>
</ul>
</div>

<div id="outline-container-org1d900f1" class="outline-4">
<h4 id="org1d900f1"><span class="section-number-4">5.3.1</span> vsyscall</h4>
</div>
<div id="outline-container-org868f692" class="outline-4">
<h4 id="org868f692"><span class="section-number-4">5.3.2</span> vDSO</h4>
</div>
</div>
</div>

<div id="outline-container-org7f69fc5" class="outline-2">
<h2 id="org7f69fc5"><span class="section-number-2">6</span> Synchronization primitives</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orga267532" class="outline-3">
<h3 id="orga267532"><span class="section-number-3">6.1</span> Spinlock</h3>
<div class="outline-text-3" id="text-6-1">
<p>
a <b>spinlock</b> is a lock which causes a thread trying to acquire it to simply wait in a loop("spin") while repeatedly checking if the lock is available. Since the thread remains active but is not performing a useful task, <b>the use of such a lock is kind of busy waiting</b>.
</p>

<p>
Because they avoid overhead from operating system process rescheduling or context switching, spinlocks are efficient if threads are likely to be blocked for only short periods.
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">include/asm-generic/qspinlock_types.h</span>
<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">qspinlock</span> {
        <span class="org-keyword">union</span> {
                <span class="org-type">atomic_t</span> <span class="org-variable-name">val</span>;
<span class="org-preprocessor">#ifdef</span> __LITTLE_ENDIAN
                <span class="org-keyword">struct</span> {
                        <span class="org-type">u8</span>      <span class="org-variable-name">locked</span>;
                        <span class="org-type">u8</span>      <span class="org-variable-name">pending</span>;
                };
                <span class="org-keyword">struct</span> {
                        <span class="org-type">u16</span>     <span class="org-variable-name">locked_pending</span>;
                        <span class="org-type">u16</span>     <span class="org-variable-name">tail</span>;
                };
<span class="org-preprocessor">#else</span>
                <span class="org-keyword">struct</span> {
                        <span class="org-type">u16</span>     <span class="org-variable-name">tail</span>;
                        <span class="org-type">u16</span>     <span class="org-variable-name">locked_pending</span>;
                };
                <span class="org-keyword">struct</span> {
                        <span class="org-type">u8</span>      <span class="org-variable-name">reserved</span>[<span class="org-highlight-numbers-number">2</span>];
                        <span class="org-type">u8</span>      <span class="org-variable-name">pending</span>;
                        <span class="org-type">u8</span>      <span class="org-variable-name">locked</span>;
                };
<span class="org-preprocessor">#endif</span>
        };
} <span class="org-type">arch_spinlock_t</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">include/linux/spinlock_type.h</span>
<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">raw_spinlock</span> {
        <span class="org-type">arch_spinlock_t</span> <span class="org-variable-name">raw_lock</span>;
<span class="org-preprocessor">#ifdef</span> CONFIG_DEBUG_SPINLOCK
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">magic</span>, <span class="org-variable-name">owner_cpu</span>;
        <span class="org-type">void</span> *<span class="org-variable-name">owner</span>;
<span class="org-preprocessor">#endif</span>
<span class="org-preprocessor">#ifdef</span> CONFIG_DEBUG_LOCK_ALLOC
        <span class="org-keyword">struct</span> <span class="org-type">lockdep_map</span> <span class="org-variable-name">dep_map</span>;
<span class="org-preprocessor">#endif</span>
} <span class="org-type">raw_spinlock_t</span>;

<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">spinlock</span> {
        <span class="org-keyword">union</span> {
                <span class="org-keyword">struct</span> <span class="org-type">raw_spinlock</span> <span class="org-variable-name">rlock</span>;

<span class="org-preprocessor">#ifdef</span> CONFIG_DEBUG_LOCK_ALLOC
<span class="org-preprocessor"># define</span> <span class="org-variable-name">LOCK_PADSIZE</span> (offsetof(<span class="org-keyword">struct</span> <span class="org-type">raw_spinlock</span>, dep_map))
                <span class="org-keyword">struct</span> {
                        <span class="org-type">u8</span> <span class="org-variable-name">__padding</span>[LOCK_PADSIZE];
                        <span class="org-keyword">struct</span> <span class="org-type">lockdep_map</span> <span class="org-variable-name">dep_map</span>;
                };
<span class="org-preprocessor">#endif</span>
        };
} <span class="org-type">spinlock_t</span>;
</pre>
</div>
</div>

<div id="outline-container-org8cc3bf8" class="outline-4">
<h4 id="org8cc3bf8"><span class="section-number-4">6.1.1</span> normal spinlock</h4>
<div class="outline-text-4" id="text-6-1-1">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>pseudocode</label><pre class="src src-C"><span class="org-type">int</span> <span class="org-function-name">lock</span>(lock) {
    <span class="org-keyword">while</span> (test_and_set(lock) == <span class="org-highlight-numbers-number">1</span>);
    <span class="org-keyword">return</span> <span class="org-highlight-numbers-number">0</span>;
}
<span class="org-type">int</span> <span class="org-function-name">unlock</span>(lock) {
    lock = <span class="org-highlight-numbers-number">0</span>;
    <span class="org-keyword">return</span> lock;
}
</pre>
</div>

<p>
The implementations is not very good for performance, because it has at least two problems.
</p>
<ol class="org-ol">
<li>The implementation may <b>be unfair</b> and the thread from one processor may <b>have long waiting time</b>, even if it called the <code>lock</code> before other threads which are waiting for free lock too.</li>
<li>All thread which want to acquire a lock must to execute many atomic operations like <code>test_and_set</code> on a variable which is in shared memory. This leads to the <b>cache invalidation</b> as the cache of the processor will store <code>lock=1</code>, but the value of the lock in memory may be 1 after a thread will release this lock.</li>
</ol>
</div>
</div>

<div id="outline-container-orgc78eca0" class="outline-4">
<h4 id="orgc78eca0"><span class="section-number-4">6.1.2</span> ticket spinlock</h4>
<div class="outline-text-4" id="text-6-1-2">
<p>
<a href="https://en.wikipedia.org/wiki/Ticket_lock">Ticket spinlock</a>
This approach solves the first problem of normal spinlock and may guarantee order of threads which want to acquire a lock.
</p>

<p>
The <code>lock value</code> splits into two field.
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">next</td>
<td class="org-left">owner</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>pseudocode</label><pre class="src src-C"><span class="org-function-name">lock_init</span>() {
    next = owner = <span class="org-highlight-numbers-number">0</span>;
}
<span class="org-function-name">lock</span>() {
    my_ticket = next++;
    <span class="org-keyword">while</span>(my_ticket != owner);
}
<span class="org-function-name">unlock</span>() {
    ++owner;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb800b31" class="outline-4">
<h4 id="orgb800b31"><span class="section-number-4">6.1.3</span> queue spinlock(MCS lock)</h4>
<div class="outline-text-4" id="text-6-1-3">
<p>
<a href="http://www.cs.rochester.edu/~scott/papers/1991_TOCS_synch.pdf">mcs lock</a>
This approach may help to solve both of problems which normal spinlock.
The <code>queued apinlocks</code> allows to each processor to use its own memory location to spin.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>pseudocode</label><pre class="src src-C"><span class="org-type">void</span> <span class="org-function-name">lock</span>(...) {
    lock.next = <span class="org-constant">NULL</span>;
    ancestor = put_lock_to_queue_and_return_ancestor(queue, lock);
    <span class="org-comment-delimiter">// </span><span class="org-comment">if we have ancestor, the lock already acquired and we</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">need to wait until it will be released</span>
    <span class="org-keyword">if</span> (ancestor) {
        lock.locked = <span class="org-highlight-numbers-number">1</span>;
        ancestor.next = lock;
        <span class="org-keyword">while</span> (lock.is_locked == <span class="org-constant">true</span>);
    }
    <span class="org-comment-delimiter">// </span><span class="org-comment">in other way we are owner of the lock and may exit</span>
}
<span class="org-type">void</span> <span class="org-function-name">unlock</span>(...) {
    <span class="org-comment-delimiter">// </span><span class="org-comment">do we need to notify somebody or we are alonw in the</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">queue?</span>
    <span class="org-keyword">if</span> (lock.next != <span class="org-constant">NULL</span>) {
        <span class="org-comment-delimiter">// </span><span class="org-comment">the while loop from the lock() function will be</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">finished</span>
        lock.next.is_locked = <span class="org-constant">false</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">delete ourself from the queue and exit</span>
        <span class="org-keyword">return</span>;
    }
    <span class="org-comment-delimiter">// </span><span class="org-comment">So, we have no next threads in the queue to notify about</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">lock releasing event. Let's just put `0` to the lock, will</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">delete ourself from the queue and exit.</span>
}
</pre>
</div>

<p>
Linux kernel implement:
</p>

<ul class="org-ul">
<li><p>
<code>cmpxchg(void* ptr, int old, int new)</code>:
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">if</span> (*ptr == old) *ptr = new;
<span class="org-keyword">else</span> <span class="org-keyword">return</span> *ptr
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgc95fd91" class="outline-4">
<h4 id="orgc95fd91"><span class="section-number-4">6.1.4</span> related operations</h4>
<div class="outline-text-4" id="text-6-1-4">
<p>
<code>include/linux/spinlock.h</code>
</p>
</div>
</div>
</div>
<div id="outline-container-org390ae0d" class="outline-3">
<h3 id="org390ae0d"><span class="section-number-3">6.2</span> Semaphores</h3>
<div class="outline-text-3" id="text-6-2">
<ul class="org-ul">
<li><code>semaphores</code> is a solution for locks which may be acquired for a long time.</li>
<li>semaphore's lock value is not limited to 0 and 1. There are two types of <code>semaphores</code>:
<ul class="org-ul">
<li>binary semaphore</li>
<li>normal semaphore: it is called as <code>counting semaphore</code> and it allows to acquires a lock to more than 1 process. <b>This allows us to keep records of available resources, when spinlock allows to hold a lock only on one task</b>.</li>
</ul></li>
<li><code>semaphores</code> allows to sleep.</li>
<li>force rescheduling of processes which are in waiters list.</li>
</ul>

<p>
Semaphore Structure:
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">struct</span> <span class="org-type">semaphore</span> {
        <span class="org-type">raw_spinlock_t</span>          <span class="org-variable-name">lock</span>;
        <span class="org-type">unsigned</span> <span class="org-type">int</span>            <span class="org-variable-name">count</span>;
        <span class="org-keyword">struct</span> <span class="org-type">list_head</span>        <span class="org-variable-name">wait_list</span>;
};
</pre>
</div>
<ul class="org-ul">
<li>lock: spinlock for a semaphore data protection</li>
<li>count: amount available resources</li>
<li>wait_list: list of processes which are waiting to acquire a lock</li>
</ul>

<p>
Initialize a <code>semaphore</code>
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#define</span> <span class="org-function-name">__SEMAPHORE_INITIALIZER</span>(<span class="org-variable-name">name</span>, <span class="org-variable-name">n</span>)                                \
{                                                                       \
        .lock           = __RAW_SPIN_LOCK_UNLOCKED((name).lock),        \ <span class="org-comment-delimiter">// </span><span class="org-comment">0</span>
        .count          = n,                                            \
        .wait_list      = LIST_HEAD_INIT((name).wait_list),             \
}
</pre>
</div>
<ul class="org-ul">
<li><p>
statically: acquired binary semaphore
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#define</span> <span class="org-function-name">DEFINE_SEMAPHORE</span>(<span class="org-variable-name">name</span>)  \
        <span class="org-keyword">struct</span> <span class="org-type">semaphore</span> <span class="org-variable-name">name</span> = __SEMAPHORE_INITIALIZER(name, <span class="org-highlight-numbers-number">1</span>)
</pre>
</div></li>
<li><p>
dynamically: acquired normal semaphore
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">static</span> <span class="org-keyword">inline</span> <span class="org-type">void</span> <span class="org-function-name">sema_init</span>(<span class="org-keyword">struct</span> <span class="org-type">semaphore</span> *<span class="org-variable-name">sem</span>, <span class="org-type">int</span> <span class="org-variable-name">val</span>) {
        <span class="org-keyword">static</span> <span class="org-keyword">struct</span> <span class="org-type">lock_class_key</span> <span class="org-variable-name">__key</span>;
        *sem = (<span class="org-keyword">struct</span> <span class="org-type">semaphore</span>) __SEMAPHORE_INITIALIZER(*sem, val);
        lockdep_init_map(&amp;sem-&gt;lock.dep_map, <span class="org-string">"semaphore-&gt;lock"</span>, &amp;__key, <span class="org-highlight-numbers-number">0</span>);
}
</pre>
</div></li>
</ul>

<p>
Lock Operations:
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">extern</span> <span class="org-type">void</span> <span class="org-function-name">down</span>(<span class="org-keyword">struct</span> <span class="org-type">semaphore</span> *<span class="org-variable-name">sem</span>);
<span class="org-keyword">extern</span> <span class="org-type">int</span> <span class="org-function-name">__must_check</span> down_interruptible(<span class="org-keyword">struct</span> <span class="org-type">semaphore</span> *<span class="org-variable-name">sem</span>);
<span class="org-keyword">extern</span> <span class="org-type">int</span> <span class="org-function-name">__must_check</span> down_killable(<span class="org-keyword">struct</span> <span class="org-type">semaphore</span> *<span class="org-variable-name">sem</span>);
<span class="org-keyword">extern</span> <span class="org-type">int</span> <span class="org-function-name">__must_check</span> down_trylock(<span class="org-keyword">struct</span> <span class="org-type">semaphore</span> *<span class="org-variable-name">sem</span>);
<span class="org-keyword">extern</span> <span class="org-type">int</span> <span class="org-function-name">__must_check</span> down_timeout(<span class="org-keyword">struct</span> <span class="org-type">semaphore</span> *<span class="org-variable-name">sem</span>, <span class="org-type">long</span> <span class="org-variable-name">jiffies</span>);
<span class="org-keyword">extern</span> <span class="org-type">void</span> <span class="org-function-name">up</span>(<span class="org-keyword">struct</span> <span class="org-type">semaphore</span> *<span class="org-variable-name">sem</span>);
</pre>
</div>
<ul class="org-ul">
<li><code>down</code>: acquire the semaphore, calling this function will put the task to sleep until the semaphore is released.</li>
<li><code>down_interruptible</code>: acquire the semaphore unless interrupted. If the sleep is interrupted by a signal, this function will return <code>-EINTR</code>.</li>
<li><code>down_killable</code>: acquire the semaphore unless killed. If the sleep is interrupted by a fatal signal, this function will return <code>-EINTR</code>.</li>
<li><code>down_trylock</code>: try to acquire the semaphore, without waiting.</li>
<li><code>down_timeout</code>: acquire the semaphore within a specified time. If the semaphore is not released within the specified number of jiffies, this function returns <code>-ETIME</code>.</li>
<li><code>up</code>: release the semaphore.</li>
</ul>
</div>
</div>
<div id="outline-container-orgbd91d03" class="outline-3">
<h3 id="orgbd91d03"><span class="section-number-3">6.3</span> Mutex</h3>
<div class="outline-text-3" id="text-6-3">
<ul class="org-ul">
<li>only one task can hold the mutex at a time</li>
<li>only the owner can unlock the mutex</li>
<li>multiple unlocks are not permitted</li>
<li>recursive locking is not permitted</li>
<li>a mutex object must be initialized via the API</li>
<li>a mutex object must not be initialized via <code>memset</code> or copying</li>
<li>task may not exit with mutex held</li>
<li>memory areas where held locks reside must not be freed</li>
<li>held mutexes must not be reinitialized</li>
<li>mutexes may not be used in hardware or software interrupt contexts such as tasklets and timers</li>
</ul>

<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">struct</span> <span class="org-type">mutex</span> {
        <span class="org-type">atomic_long_t</span>           <span class="org-variable-name">owner</span>;
        <span class="org-type">spinlock_t</span>              <span class="org-variable-name">wait_lock</span>;
<span class="org-preprocessor">#ifdef</span> CONFIG_MUTEX_SPIN_ON_OWNER
        <span class="org-keyword">struct</span> <span class="org-type">optimistic_spin_queue</span> <span class="org-variable-name">osq</span>; <span class="org-comment-delimiter">/* </span><span class="org-comment">Spinner MCS lock </span><span class="org-comment-delimiter">*/</span>
<span class="org-preprocessor">#endif</span>
        <span class="org-keyword">struct</span> <span class="org-type">list_head</span>        <span class="org-variable-name">wait_list</span>;
<span class="org-preprocessor">#ifdef</span> CONFIG_DEBUG_MUTEXES
        <span class="org-type">void</span>                    *<span class="org-variable-name">magic</span>;
<span class="org-preprocessor">#endif</span>
<span class="org-preprocessor">#ifdef</span> CONFIG_DEBUG_LOCK_ALLOC
        <span class="org-keyword">struct</span> <span class="org-type">lockdep_map</span>      <span class="org-variable-name">dep_map</span>;
<span class="org-preprocessor">#endif</span>
};
</pre>
</div>

<p>
when a process try to acquire a <code>mutex</code>, there three possible:
</p>
<ul class="org-ul">
<li><code>fastpath</code>: Nobody acquired a <code>mutex</code>. In this case, change <code>owner</code> to <code>current(task_struct)</code></li>
<li><code>slowpath</code>: Someone acquired a <code>mutex</code>
<ul class="org-ul">
<li><code>optimistic spinning</code>: if there are no other processes ready to run that have higher priority. In this case, using <code>MCS lock</code></li>
<li><code>slowpath</code>: using <code>semaphore</code> lock</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org6e4148a" class="outline-3">
<h3 id="org6e4148a"><span class="section-number-3">6.4</span> Reader/Writer semaphore</h3>
<div class="outline-text-3" id="text-6-4">
<p>
<a href="https://en.wikipedia.org/wiki/Readers%E2%80%93writer_lock">R/W lock</a>
When a process which wants to write something into data, all other writer and reader processes will be blocked until the process which acquired a lock, will not release it. When a process reads data, other processes which want to read the same data too, will not be locked and will be able to do this.
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#ifdef</span> CONFIG_RWSEM_GENERIC_SPINLOCK
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/rwsem-spinlock.h&gt;</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">use a generic implementation </span><span class="org-comment-delimiter">*/</span>
<span class="org-preprocessor">#else</span>
<span class="org-comment-delimiter">/* </span><span class="org-comment">All arch specific implementations share the same struct </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">struct</span> <span class="org-type">rw_semaphore</span> {
        <span class="org-type">atomic_long_t</span> <span class="org-variable-name">count</span>;
        <span class="org-keyword">struct</span> <span class="org-type">list_head</span> <span class="org-variable-name">wait_list</span>;
        <span class="org-type">raw_spinlock_t</span> <span class="org-variable-name">wait_lock</span>;
<span class="org-preprocessor">#ifdef</span> CONFIG_RWSEM_SPIN_ON_OWNER
        <span class="org-keyword">struct</span> <span class="org-type">optimistic_spin_queue</span> <span class="org-variable-name">osq</span>; <span class="org-comment-delimiter">/* </span><span class="org-comment">spinner MCS lock </span><span class="org-comment-delimiter">*/</span>
        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * Write owner. Used as a speculative check to see</span>
<span class="org-comment">         * if the owner is running on the cpu.</span>
<span class="org-comment">         </span><span class="org-comment-delimiter">*/</span>
        <span class="org-keyword">struct</span> <span class="org-type">task_struct</span> *<span class="org-variable-name">owner</span>;
<span class="org-preprocessor">#endif</span>
<span class="org-preprocessor">#ifdef</span> CONFIG_DEBUG_LOCK_ALLOC
        <span class="org-keyword">struct</span> <span class="org-type">lockdep_map</span>      <span class="org-variable-name">dep_map</span>;
<span class="org-preprocessor">#endif</span>
};
</pre>
</div>
<p>
The count field of a <code>rw_semaphore</code> structure may have following values:
</p>
<ul class="org-ul">
<li><code>0x0000000000000000</code>: reader/writer semaphore is in unlocked state and no one is waiting for a lock.</li>
<li><code>0x000000000000000X</code>: X readers are active or attempting to acquire a lock and no writer waiting.</li>
<li><code>0xffffffff0000000X</code>: may represent different cases. The first is - X readers are active or attempting to acquire a lock with waiters for the lock. The second is - one writer attempting a lock, no waiters for the lock. And the last - one writer is active and no waiters for the lock.</li>
<li><code>0xffffffff00000001</code>: may represented two different cases. The first is - one reader is active or attempting to acquire a lock and exist waiters for the lock. The second case is one writer is active or attempting to acquire a lock and no waiters for the lock.</li>
<li><code>0xffffffff00000000</code>: represents situation when there are readers or writers are queued, but no one is active or is in the process of acquire of a lock.</li>
<li><code>0xfffffffe00000001</code>: a writer is active or attempting to acquire a lock and waiters are in queue.</li>
</ul>

<p>
Api:
<code>include/linux/rwsem.h</code>
</p>
</div>
</div>
<div id="outline-container-org112d9bc" class="outline-3">
<h3 id="org112d9bc"><span class="section-number-3">6.5</span> SeqLock</h3>
<div class="outline-text-3" id="text-6-5">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>pseudocode</label><pre class="src src-C"><span class="org-type">int</span> <span class="org-variable-name">counter</span> = <span class="org-highlight-numbers-number">0</span>;
<span class="org-type">void</span> <span class="org-function-name">write</span>() {
    counter++;
    lock();
    <span class="org-comment-delimiter">// </span><span class="org-comment">write operation</span>
    unlock();
    counter++;
}

<span class="org-type">void</span> <span class="org-function-name">read</span>() {
    <span class="org-type">int</span> <span class="org-variable-name">count</span> = counter;
    <span class="org-comment-delimiter">// </span><span class="org-comment">read operation</span>
    <span class="org-keyword">if</span> (count != counter) {
        <span class="org-comment-delimiter">// </span><span class="org-comment">repeat read operation</span>
    }
}
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>Sequential lock struct</label><pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">include/linux/seqlock.h</span>
<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">seqcount</span> {
        <span class="org-type">unsigned</span> <span class="org-variable-name">sequence</span>;
<span class="org-preprocessor">#ifdef</span> CONFIG_DEBUG_LOCK_ALLOC
        <span class="org-keyword">struct</span> <span class="org-type">lockdep_map</span> <span class="org-variable-name">dep_map</span>;
<span class="org-preprocessor">#endif</span>
} <span class="org-type">seqcount_t</span>;

<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> {
        <span class="org-keyword">struct</span> <span class="org-type">seqcount</span> <span class="org-variable-name">seqcount</span>;
        <span class="org-type">spinlock_t</span> <span class="org-variable-name">lock</span>;
} <span class="org-type">seqlock_t</span>;

</pre>
</div>
</div>
</div>

<div id="outline-container-orgab7631d" class="outline-3">
<h3 id="orgab7631d"><span class="section-number-3">6.6</span> RCU</h3>
<div class="outline-text-3" id="text-6-6">
<p>
<a id="org0a92114"></a>
</p>
</div>
</div>

<div id="outline-container-orga34369a" class="outline-3">
<h3 id="orga34369a"><span class="section-number-3">6.7</span> Completions</h3>
<div class="outline-text-3" id="text-6-7">
<p>
<a href="https://elixir.bootlin.com/linux/latest/source/Documentation/scheduler/completion.txt">Completions</a>
</p>
</div>
</div>

<div id="outline-container-org9a571f7" class="outline-3">
<h3 id="org9a571f7"><span class="section-number-3">6.8</span> Locking Traps</h3>
<div class="outline-text-3" id="text-6-8">
<ul class="org-ul">
<li>Ambiguous Rules
<ul class="org-ul">
<li><p>
Locking should really be laid out a the beginning, it can be a hard thing to retrofit in afterward
</p>

<p>
Time taken at the outset usually is paid back generously at debugging time.
</p></li>
<li><p>
To make your locking work properly, you have to write some functions with the assumption that their caller has already acquired the relevant lock(s).
</p>

<p>
If one function acquires a lock and then calls another function that also attempts to acquire the lock, you code deadlocks.
</p></li>
</ul></li>
<li><p>
Lock Ordering Rules: when multiple locks must be acquired, they should always be acquired in the same order. (<code>Circular wait</code>)
</p>

<p>
A couple of rules of thumb:
</p>
<ul class="org-ul">
<li>If you must obtain a lock that is local to your code(a device lock, say) along with a lock belonging to a more central part of the kernel, take your lock first.</li>
<li>If you have a combination of semaphores and spinlocks, you must, of course, obtain the semaphore(s) first; calling down(which can sleep) while holding a spinlock is a serious error.</li>
</ul></li>
<li>Fine-Versus Coarse-Grained Locking</li>
</ul>
</div>
</div>

<div id="outline-container-orgf3f961b" class="outline-3">
<h3 id="orgf3f961b"><span class="section-number-3">6.9</span> Sleep</h3>
<div class="outline-text-3" id="text-6-9">
</div>
<div id="outline-container-orged98472" class="outline-4">
<h4 id="orged98472"><span class="section-number-4">6.9.1</span> How a process sleeps</h4>
<div class="outline-text-4" id="text-6-9-1">
<ol class="org-ol">
<li><p>
set the state of the process to mark it as being asleep
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">TASK_INTERRUPTIBLE and TASK_UNINTERRUPTIBLE</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">set_current_state</span>(<span class="org-variable-name">state_value</span>)
</pre>
</div></li>
<li>giving up the processor</li>
</ol>
</div>
</div>
</div>
</div>

<div id="outline-container-org43189ee" class="outline-2">
<h2 id="org43189ee"><span class="section-number-2">7</span> SMP</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org4c329b5" class="outline-3">
<h3 id="org4c329b5"><span class="section-number-3">7.1</span> cpu_dev</h3>
<div class="outline-text-3" id="text-7-1">
<p>
<a id="org9238628"></a>
</p>

<p>
cpu_dev definition information which kernel support CPU types.
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/kernel/cpu/cpu.h</span>
<span class="org-comment-delimiter">/* </span><span class="org-comment">attempt to consolidate cpu attributes </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">struct</span> <span class="org-type">cpu_dev</span> {
        <span class="org-keyword">const</span> <span class="org-type">char</span>      *<span class="org-variable-name">c_vendor</span>;

        <span class="org-comment-delimiter">/* </span><span class="org-comment">some have two possibilities for cpuid string </span><span class="org-comment-delimiter">*/</span>
        <span class="org-keyword">const</span> <span class="org-type">char</span>      *<span class="org-variable-name">c_ident</span>[<span class="org-highlight-numbers-number">2</span>];

        <span class="org-type">void</span>            (*c_early_init)(<span class="org-keyword">struct</span> <span class="org-type">cpuinfo_x86</span> *);
        <span class="org-type">void</span>            (*c_bsp_init)(<span class="org-keyword">struct</span> <span class="org-type">cpuinfo_x86</span> *);
        <span class="org-type">void</span>            (*c_init)(<span class="org-keyword">struct</span> <span class="org-type">cpuinfo_x86</span> *);
        <span class="org-type">void</span>            (*c_identify)(<span class="org-keyword">struct</span> <span class="org-type">cpuinfo_x86</span> *);
        <span class="org-type">void</span>            (*c_detect_tlb)(<span class="org-keyword">struct</span> <span class="org-type">cpuinfo_x86</span> *);
        <span class="org-type">void</span>            (*c_bsp_resume)(<span class="org-keyword">struct</span> <span class="org-type">cpuinfo_x86</span> *);
        <span class="org-type">int</span>             <span class="org-variable-name">c_x86_vendor</span>;
<span class="org-preprocessor">#ifdef</span> CONFIG_X86_32
        <span class="org-comment-delimiter">/* </span><span class="org-comment">Optional vendor specific routine to obtain the cache size. </span><span class="org-comment-delimiter">*/</span>
        <span class="org-type">unsigned</span> <span class="org-type">int</span>    (*legacy_cache_size)(<span class="org-keyword">struct</span> <span class="org-type">cpuinfo_x86</span> *,
                                             <span class="org-type">unsigned</span> <span class="org-type">int</span>);

        <span class="org-comment-delimiter">/* </span><span class="org-comment">Family/stepping-based lookup table for model names. </span><span class="org-comment-delimiter">*/</span>
        <span class="org-keyword">struct</span> <span class="org-type">legacy_cpu_model_info</span> {
                <span class="org-type">int</span>             <span class="org-variable-name">family</span>;
                <span class="org-keyword">const</span> <span class="org-type">char</span>      *<span class="org-variable-name">model_names</span>[<span class="org-highlight-numbers-number">16</span>];
        }               <span class="org-variable-name">legacy_models</span>[<span class="org-highlight-numbers-number">5</span>];
<span class="org-preprocessor">#endif</span>
};
</pre>
</div>

<p>
cpu_dev declare variable in the <code>.x86_cpu_dev.init</code> section by <code>cpu_dev_register</code>
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#define</span> <span class="org-function-name">cpu_dev_register</span>(<span class="org-variable-name">cpu_devX</span>) \
        <span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">cpu_dev</span> *<span class="org-keyword">const</span> <span class="org-function-name">__cpu_dev_</span>##cpu_devX __used \
        <span class="org-keyword">__attribute__</span>((__section__(<span class="org-string">".x86_cpu_dev.init"</span>))) = \
        &amp;cpu_devX;
</pre>
</div>
</div>
</div>

<div id="outline-container-org30ab669" class="outline-3">
<h3 id="org30ab669"><span class="section-number-3">7.2</span> Per-CPU</h3>
<div class="outline-text-3" id="text-7-2">
<p>
Per-CPU variables are one of the kernel features. We can create a variable and each processor core will have its own copy of this variable.
</p>
</div>

<div id="outline-container-orgbb2488a" class="outline-4">
<h4 id="orgbb2488a"><span class="section-number-4">7.2.1</span> Create per-cpu variables</h4>
<div class="outline-text-4" id="text-7-2-1">
</div>
<ol class="org-ol">
<li><a id="orgfc4af40"></a>static variables declare<br />
<div class="outline-text-5" id="text-7-2-1-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> declare per-cpu variables macro <code>include/linux/percpu-defs.h</code></caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">macro</td>
<td class="org-left">description</td>
</tr>

<tr>
<td class="org-left">DECLARE_PER_CPU</td>
<td class="org-left">ordinary per-CPU variables</td>
</tr>

<tr>
<td class="org-left">DECLARE_PER_CPU_FIRST</td>
<td class="org-left">must come first in the set of variables</td>
</tr>

<tr>
<td class="org-left">DECLARE_PER_CPU_SHARED_ALIGNED</td>
<td class="org-left">must be cacheline aligned under SMP conditions</td>
</tr>

<tr>
<td class="org-left">DECLARE_PER_CPU_ALIGNED</td>
<td class="org-left">must be cacheline aligned</td>
</tr>

<tr>
<td class="org-left">DECLARE_PER_CPU_PAGE_ALIGNED</td>
<td class="org-left">must be page aligned</td>
</tr>

<tr>
<td class="org-left">DECLARE_PER_CPU_READ_MOSTLY</td>
<td class="org-left">muse be read mostly</td>
</tr>

<tr>
<td class="org-left">DECLARE_PER_CPU_DECRYPTED</td>
<td class="org-left">should be accessed as decrypted</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">when encryption is enabled in the guest</td>
</tr>
</tbody>
</table>

<p>
per-CPU is declared to <code>PER_CPU_BASE_SECTION + Subsection</code> according to the different macro of the above table.
</p>
</div>
</li>
<li><a id="org7ee994d"></a>dynamic define<br /></li>
</ol>
</div>

<div id="outline-container-org1cc136e" class="outline-4">
<h4 id="org1cc136e"><span class="section-number-4">7.2.2</span> per-cpu operate</h4>
</div>

<div id="outline-container-orgb67039d" class="outline-4">
<h4 id="orgb67039d"><span class="section-number-4">7.2.3</span> per-cpu areas initialization process</h4>
<div class="outline-text-4" id="text-7-2-3">
<ol class="org-ol">
<li><code>init/main.c setup_per_cpu_areas()</code>:
<ol class="org-ol">
<li>print information about:
<ul class="org-ul">
<li><code>NR_CPUs</code>: maximum number of CPUs</li>
<li><code>nr_cpumask_bits</code>: <code>NR_CPUs</code> bit for the new <code>cpumask</code> operators</li>
<li><code>nr_cpu_ids</code>: actual number of CPUs</li>
<li><code>nr_node_ids</code>: number of <code>NUMA</code> nodes</li>
</ul></li>
<li></li>
</ol></li>
<li></li>
</ol>
</div>
</div>
</div>


<div id="outline-container-orgf80e759" class="outline-3">
<h3 id="orgf80e759"><span class="section-number-3">7.3</span> Cpumasks</h3>
<div class="outline-text-3" id="text-7-3">
<p>
<a id="org0eccdcd"></a>
</p>
</div>
</div>
</div>
<div id="outline-container-org2b6b479" class="outline-2">
<h2 id="org2b6b479"><span class="section-number-2">8</span> Drive</h2>
</div>

<div id="outline-container-org25a4dbf" class="outline-2">
<h2 id="org25a4dbf"><span class="section-number-2">9</span> Networking</h2>
<div class="outline-text-2" id="text-9">
<p>
The factors that determines the traversal of a packet in the network stack
</p>
<ul class="org-ul">
<li>lookup in the routing subsystem</li>
<li>netfilter subsystem(netfilter hook)</li>
<li>IPsec subsystem</li>
<li>the value of the <code>ttl</code> field in the IPv4 header of a packet being forwarded</li>
</ul>
</div>

<div id="outline-container-org7c6294b" class="outline-3">
<h3 id="org7c6294b"><span class="section-number-3">9.1</span> Netlink Sockets</h3>
<div class="outline-text-3" id="text-9-1">
<p>
The netlink protocol is socket-based Inter Process Communication(IPC) mechanism, based on <a href="https://tools.ietf.org/html/rfc3549">RFC 3549</a>.
Netlink sockets can send asynchronous messages to userspace from the kernel. The netlink socket handles bidirectional communication with a kernel netlink socket, usually sending message to configure various system settings and getting responses back from the kernel.
</p>
</div>

<div id="outline-container-org04c32ef" class="outline-4">
<h4 id="org04c32ef"><span class="section-number-4">9.1.1</span> Netlink advantages</h4>
<div class="outline-text-4" id="text-9-1-1">
<ul class="org-ul">
<li>no need for polling when working with netlink sockets.</li>
<li>the kernel can be the initiator of sending asynchronous messages to userspace, without any need for the userspace to trigger any action.</li>
<li>support multicast transmission.</li>
</ul>
</div>
</div>

<div id="outline-container-orgb59998f" class="outline-4">
<h4 id="orgb59998f"><span class="section-number-4">9.1.2</span> Kernel Netlink Sockets</h4>
<div class="outline-text-4" id="text-9-1-2">
<p>
Netlink sockets is created by <code>netlink_kernel_create()</code> in the kernel networking stack. <b>Each kernel sockets handles messages of different types</b>.
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">include/linux/netlink.h</span>
<span class="org-keyword">static</span> <span class="org-keyword">inline</span> <span class="org-keyword">struct</span> <span class="org-type">sock</span> *
<span class="org-function-name">netlink_kernel_create</span>(<span class="org-keyword">struct</span> <span class="org-type">net</span> *<span class="org-variable-name">net</span>, <span class="org-type">int</span> <span class="org-variable-name">unit</span>, <span class="org-keyword">struct</span> <span class="org-type">netlink_kernel_cfg</span> *<span class="org-variable-name">cfg</span>)
</pre>
</div>

<ul class="org-ul">
<li><code>net</code>: the network namespace</li>
<li><code>unit</code>: netlink protocol</li>
<li><p>
<code>cfg</code>: consists of optional parameters for the netlink socket creation
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">/* </span><span class="org-comment">optional Netlink kernel configuration parameters </span><span class="org-comment-delimiter">*/</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">include/linux/netlink.h</span>
<span class="org-keyword">struct</span> <span class="org-type">netlink_kernel_cfg</span> {
        <span class="org-type">unsigned</span> <span class="org-type">int</span>    <span class="org-variable-name">groups</span>;
        <span class="org-type">unsigned</span> <span class="org-type">int</span>    <span class="org-variable-name">flags</span>;
        <span class="org-type">void</span>            (*input)(<span class="org-keyword">struct</span> <span class="org-type">sk_buff</span> *<span class="org-variable-name">skb</span>);
        <span class="org-keyword">struct</span> <span class="org-type">mutex</span>    *<span class="org-variable-name">cb_mutex</span>;
        <span class="org-type">int</span>             (*bind)(<span class="org-keyword">struct</span> <span class="org-type">net</span> *<span class="org-variable-name">net</span>, <span class="org-type">int</span> <span class="org-variable-name">group</span>);
        <span class="org-type">void</span>            (*unbind)(<span class="org-keyword">struct</span> <span class="org-type">net</span> *<span class="org-variable-name">net</span>, <span class="org-type">int</span> <span class="org-variable-name">group</span>);
        bool            (*compare)(<span class="org-keyword">struct</span> <span class="org-type">net</span> *<span class="org-variable-name">net</span>, <span class="org-keyword">struct</span> <span class="org-type">sock</span> *<span class="org-variable-name">sk</span>);
};
</pre>
</div>
<ul class="org-ul">
<li><code>groups</code>: for specifying a multicast group(or a mask of multicast groups)</li>
<li><code>flags</code>: <code>NL_CFG_F_NONROOT_RECV</code> or <code>NL_CFG_F_NONROOT_SEND</code>
<ul class="org-ul">
<li><code>NL_CFG_F_NONROOT_RECV</code>: It is set, a non-superuser can bind to a multicast group, And it is not set, then when binding to a multicast group the <code>netlink_capable()</code> method will return 0, and you get <code>-EPRM</code> error</li>
<li><code>NL_CFG_F_NONROOT_SEND</code>: It is set, a non-superuser is allowed to send multicast</li>
</ul></li>
<li><code>input</code>: when the input member is NULL, the kernel socket won't be able to receive data from userspace(sending data from the kernel to userspace is possible, though)</li>
<li><code>mutex</code>: when not defining a mutex, you use the default one(<code>cb_def_mutex</code>)</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-orga0b7511" class="outline-2">
<h2 id="orga0b7511"><span class="section-number-2">10</span> Timers and time management</h2>
<div class="outline-text-2" id="text-10">
</div>
<div id="outline-container-org1a20f0d" class="outline-3">
<h3 id="org1a20f0d"><span class="section-number-3">10.1</span> jiffy</h3>
<div class="outline-text-3" id="text-10-1">
<p>
<code>jiffy</code>: is an informal term for any unspecified short period of time. In the Linux kernel this definition is very similar to the <code>jiffy</code>. There is global variable with the <code>jiffies</code> which holds the number of ticks(timer interrupt of times) that have occurred since the system booted.
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">include/linux/jiffies.h</span>
<span class="org-keyword">extern</span> u64 <span class="org-type">__cacheline_aligned_in_smp</span> <span class="org-variable-name">jiffies_64</span>;
<span class="org-keyword">extern</span> <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-keyword">volatile</span> <span class="org-type">__cacheline_aligned_in_smp</span> <span class="org-type">__jiffy_arch_data</span> <span class="org-variable-name">jiffies</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/kernel/time/timer.c</span>
__visible u64 <span class="org-type">jiffies_64</span> <span class="org-variable-name">__cacheline_aligned_in_smp</span> = INITIAL_JIFFIES;
<span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/kernel/time.c</span>
<span class="org-preprocessor">#ifdef</span> CONFIG_X86_64
<span class="org-type">__visible</span> <span class="org-keyword">volatile</span> <span class="org-type">unsigned</span> <span class="org-type">long</span> jiffies __cacheline_aligned_in_smp = INITIAL_JIFFIES;
<span class="org-preprocessor">#endif</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">arch/x86/kernel/vmlinux.lds.S</span>
<span class="org-preprocessor">#ifdef</span> CONFIG_X86_32
<span class="org-function-name">OUTPUT_ARCH</span>(i386)
<span class="org-function-name">ENTRY</span>(phys_startup_32)
jiffies = jiffies_64;
<span class="org-preprocessor">#else</span>
<span class="org-function-name">OUTPUT_ARCH</span>(i386:x86-<span class="org-highlight-numbers-number">64</span>)
<span class="org-function-name">ENTRY</span>(phys_startup_64)
jiffies_64 = jiffies;
<span class="org-preprocessor">#endif</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orgd12a65e" class="outline-3">
<h3 id="orgd12a65e"><span class="section-number-3">10.2</span> clocksource</h3>
<div class="outline-text-3" id="text-10-2">
<p>
<code>struct clocksource</code>: hardware abstraction for a free running counter. Provides mostly state-free accessors to the underlying hardware. This is the structure used for system time.
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">include/linux/clocksource.h</span>
<span class="org-keyword">struct</span> <span class="org-type">clocksource</span> {
        u64 (*read)(<span class="org-keyword">struct</span> <span class="org-type">clocksource</span> *<span class="org-variable-name">cs</span>);
        <span class="org-type">u64</span> <span class="org-variable-name">mask</span>;
        <span class="org-type">u32</span> <span class="org-variable-name">mult</span>;
        <span class="org-type">u32</span> <span class="org-variable-name">shift</span>;
        <span class="org-type">u64</span> <span class="org-variable-name">max_idle_ns</span>;
        <span class="org-type">u32</span> <span class="org-variable-name">maxadj</span>;
<span class="org-preprocessor">#ifdef</span> CONFIG_ARCH_CLOCKSOURCE_DATA
        <span class="org-keyword">struct</span> <span class="org-type">arch_clocksource_data</span> <span class="org-variable-name">archdata</span>;
<span class="org-preprocessor">#endif</span>
        <span class="org-type">u64</span> <span class="org-variable-name">max_cycles</span>;
        <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>;
        <span class="org-keyword">struct</span> <span class="org-type">list_head</span> <span class="org-variable-name">list</span>;
        <span class="org-type">int</span> <span class="org-variable-name">rating</span>;
        <span class="org-type">int</span> (*enable)(<span class="org-keyword">struct</span> <span class="org-type">clocksource</span> *<span class="org-variable-name">cs</span>);
        <span class="org-type">void</span> (*disable)(<span class="org-keyword">struct</span> <span class="org-type">clocksource</span> *<span class="org-variable-name">cs</span>);
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">flags</span>;
        <span class="org-type">void</span> (*suspend)(<span class="org-keyword">struct</span> <span class="org-type">clocksource</span> *<span class="org-variable-name">cs</span>);
        <span class="org-type">void</span> (*resume)(<span class="org-keyword">struct</span> <span class="org-type">clocksource</span> *<span class="org-variable-name">cs</span>);
        <span class="org-type">void</span> (*mark_unstable)(<span class="org-keyword">struct</span> <span class="org-type">clocksource</span> *<span class="org-variable-name">cs</span>);
        <span class="org-type">void</span> (*tick_stable)(<span class="org-keyword">struct</span> <span class="org-type">clocksource</span> *<span class="org-variable-name">cs</span>);

        <span class="org-comment-delimiter">/* </span><span class="org-comment">private: </span><span class="org-comment-delimiter">*/</span>
<span class="org-preprocessor">#ifdef</span> CONFIG_CLOCKSOURCE_WATCHDOG
        <span class="org-comment-delimiter">/* </span><span class="org-comment">Watchdog related data, used by the framework </span><span class="org-comment-delimiter">*/</span>
        <span class="org-keyword">struct</span> <span class="org-type">list_head</span> <span class="org-variable-name">wd_list</span>;
        <span class="org-type">u64</span> <span class="org-variable-name">cs_last</span>;
        <span class="org-type">u64</span> <span class="org-variable-name">wd_last</span>;
<span class="org-preprocessor">#endif</span>
        <span class="org-keyword">struct</span> <span class="org-type">module</span> *<span class="org-variable-name">owner</span>;
};
</pre>
</div>

<ul class="org-ul">
<li>name: ptr to clocksource name</li>
<li>list: list head for registration</li>
<li>rating: rating value for selection (higher is better)
To avoid rating inflation the following list should give you a guide as to how to assign your clocksource a rating
<ul class="org-ul">
<li>1-99: Unfit for real use Only available for bootup and testing purposes.</li>
<li>100-199: Base level usability. Functional for real use, but not desired.</li>
<li>200-299: Good. A correct and usable clocksource.</li>
<li>300-399: Desired. A reasonably fast and accurate clocksource.</li>
<li>400-499: Perfect The ideal clocksource. A must-use where available.</li>
</ul></li>
<li>read: returns a cycle value, passes clocksource as argument</li>
<li>enable: optional function to enable the clocksource</li>
<li>disable: optional function to disable the clocksource</li>
<li>mask: bitmask for two's complement subtraction of non 64 bit counters
<ul class="org-ul">
<li>32bit: counters wrap around to after 42 nanoseconds</li>
</ul></li>
<li>mult: cycle to nanosecond multiplier</li>
<li>shift: cycle to nanosecond divisor (power of two)</li>
<li>max_idle_ns: idle time permitted by the clocksource (nsecs)</li>
<li>maxadj: adjustment value to mult (~11%)</li>
<li>max_cycles: safe cycle value which won't overflow on multiplication</li>
<li>flags: describing special properties</li>
<li>archdata:	arch-specific data</li>
<li>suspend: suspend function for the clocksource, if necessary</li>
<li>resume: resume function for the clocksource, if necessary</li>
<li>mark_unstable: Optional function to inform the clocksource driver that the watchdog marked the clocksource unstable.</li>
<li>owner: module reference, must be set by clocksource in modules</li>
</ul>
</div>

<div id="outline-container-orgad18322" class="outline-4">
<h4 id="orgad18322"><span class="section-number-4">10.2.1</span> clocksource register</h4>
<div class="outline-text-4" id="text-10-2-1">
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">include/linux/clocksource.h</span>
<span class="org-keyword">extern</span> <span class="org-type">int</span>
<span class="org-function-name">__clocksource_register_scale</span>(<span class="org-keyword">struct</span> <span class="org-type">clocksource</span> *<span class="org-variable-name">cs</span>, <span class="org-type">u32</span> <span class="org-variable-name">scale</span>, <span class="org-type">u32</span> <span class="org-variable-name">freq</span>);

<span class="org-keyword">static</span> <span class="org-keyword">inline</span> <span class="org-type">int</span> <span class="org-function-name">clocksource_register_hz</span>(<span class="org-keyword">struct</span> <span class="org-type">clocksource</span> *<span class="org-variable-name">cs</span>, <span class="org-type">u32</span> <span class="org-variable-name">hz</span>)
{
        <span class="org-keyword">return</span> __clocksource_register_scale(cs, <span class="org-highlight-numbers-number">1</span>, hz);
}

<span class="org-keyword">static</span> <span class="org-keyword">inline</span> <span class="org-type">int</span> <span class="org-function-name">clocksource_register_khz</span>(<span class="org-keyword">struct</span> <span class="org-type">clocksource</span> *<span class="org-variable-name">cs</span>, <span class="org-type">u32</span> <span class="org-variable-name">khz</span>)
{
        <span class="org-keyword">return</span> __clocksource_register_scale(cs, <span class="org-highlight-numbers-number">1000</span>, khz);
}
</pre>
</div>
<ul class="org-ul">
<li><code>__clocksoure_register_scale()</code>: The function updates mult/shift and max_idle_ns field in the <code>struct clocksource</code>. Then It adds clocksource to the clocksource list and clocksource watchdog list. At last select the best <code>clocksource</code> from registered clocksources.
<ul class="org-ul">
<li><code>cs</code>: clocksource to be installed.</li>
<li><code>scale</code>: scale factor of a clock source. In other words, if we will multiply value of this parameter on frequency, we will get <code>hz</code> of a clocksource.</li>
<li><code>freq</code>: clock source frequency divided by scale.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org3ad7ec6" class="outline-4">
<h4 id="org3ad7ec6"><span class="section-number-4">10.2.2</span> x86 clocksource</h4>
<div class="outline-text-4" id="text-10-2-2">
</div>
<ol class="org-ol">
<li><a id="orgaad8a6f"></a>clocksource_jiffies<br />
<div class="outline-text-5" id="text-10-2-2-1">
<p>
The standard <code>jiffies</code> based clock source is the lowest common denominator clock source which should function on all system that the same resolution as <b>timer interrupt frequency</b>.
</p>
<ul class="org-ul">
<li>name: jiffies</li>
<li>rating: 1</li>
<li>read: jiffies_read</li>
<li>mask(32): 0x00000000ffffffff</li>
<li>mult: 1000000 &lt;&lt; 8</li>
<li>shift: 8</li>
<li>max_cycles: 0xffffffff</li>
<li>max_idle_ns: 6370867519511994</li>
</ul>
</div>
</li>
<li><a id="org2653cb9"></a>refined_jiffies<br />
<div class="outline-text-5" id="text-10-2-2-2">
<p>
<code>refined_jiffies</code> is based on the <code>i8253/i8254</code> <a href="https://en.wikipedia.org/wiki/Programmable_interval_timer">programmable interval timer</a> tick rate which is almost <code>1193182(CLOCK_TICK_RATE)</code> hertz.
</p>
<ul class="org-ul">
<li>name: refined-jiffies</li>
<li>rating: 2</li>
<li>mult:</li>
<li>shift: 8</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-org7f48bd4" class="outline-4">
<h4 id="org7f48bd4"><span class="section-number-4">10.2.3</span> clocksource_sysfs</h4>
<div class="outline-text-4" id="text-10-2-3">
<p>
<code>/sys/devices/system/clocksource</code>
</p>
</div>
</div>
</div>
<div id="outline-container-org63c3778" class="outline-3">
<h3 id="org63c3778"><span class="section-number-3">10.3</span> Reducing Scheduling-Clock Ticks</h3>
<div class="outline-text-3" id="text-10-3">
<p>
<code>Documentation/timers/NO_HZ.txt</code>
There are three main way of managing scheduling-clock interrupts
</p>
<ol class="org-ol">
<li>Never omit scheduling-clock ticks(<code>CONFIG_HZ_PERIODIC=y</code>)</li>
<li>Omit scheduling-clock tick on idle CPUs(<code>CONFIG_NO_HZ_IDLE=y</code>)</li>
<li>Omit scheduling-clock tick on CPUs that are either idle or that have only one runable task(<code>CONFIG_NO_HZ_FULL=y</code>)</li>
</ol>
</div>
<div id="outline-container-org5f6a20a" class="outline-4">
<h4 id="org5f6a20a"><span class="section-number-4">10.3.1</span> dyntick</h4>
</div>
</div>
<div id="outline-container-orgae91c18" class="outline-3">
<h3 id="orgae91c18"><span class="section-number-3">10.4</span> clock events device</h3>
</div>
<div id="outline-container-org8f4f8bb" class="outline-3">
<h3 id="org8f4f8bb"><span class="section-number-3">10.5</span> tick broadcast</h3>
<div class="outline-text-3" id="text-10-5">
<p>
Each processor in the system has its own local timer which is programmed updating <code>jiffies</code> and etc. These timers represented by the <code>tick_device</code> structure in the Linux kernel.
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">enum</span> <span class="org-type">tick_device_mode</span> {
        <span class="org-variable-name">TICKDEV_MODE_PERIODIC</span>,
        <span class="org-variable-name">TICKDEV_MODE_ONESHOT</span>,
};

<span class="org-keyword">struct</span> <span class="org-type">tick_device</span> {
        <span class="org-keyword">struct</span> <span class="org-type">clock_event_device</span> *<span class="org-variable-name">evtdev</span>;
        <span class="org-keyword">enum</span> <span class="org-type">tick_device_mode</span> <span class="org-variable-name">mode</span>;
};
</pre>
</div>

<p>
Each <code>clock events</code> device in the system registers itself by the call of the <code>clockevents_register_device</code> function or <code>clockevents_config_and_register</code> function during initialization process of the Linux kernel. During the registration of a new <code>clock event</code> device, kernel calls the <code>tick_check_new_device</code> function that checks the given <code>clock events</code> device should be used by the Linux kernel. After all checks, the <code>tick_check_new_device</code> function executes a call of the <code>tick_install_broadcast_device(newdev)</code>
function that checks that the given <code>clock event</code> device can be broadcast device and install it as <code>current tick broadcast device</code>.
</p>

<p>
Tick broadcast wake cpu by using <code>tick_broadcast_mask</code>. when CPU enters sleep and its local timer stopped, it call <code>tick_broadcast_enable</code> that sets <code>tick_broadcast_mask</code> and <code>tick_broadcast_on</code> cpumask and call <code>tick_broadcast_start_periodic()</code> or <code>tick_broadcast_setup_oneshot()</code> according to current <code>tick broadcast device</code>.
</p>

<p>
Related variable:
</p>
<ul class="org-ul">
<li><code>tick_broadcast_mask</code>: the bitmap which represents list of processors that are in a sleeping mode</li>
<li><code>tick_broadcast_on</code>: the bitmap that stores numbers of processors which are in a periodic broadcast state</li>
<li><code>tmpmask</code>: this bitmap for temporary usage</li>
<li><code>tick_broadcast_oneshot_mask</code>: stores numbers of processors that must be notified</li>
<li><code>tick_broadcast_pending_mask</code>: stores numbers of processors that pending broadcast</li>
<li><code>tick_broadcast_force_mask</code> numbers of processors with enforced broadcast</li>
</ul>

<p>
Related function:
</p>
<ul class="org-ul">
<li><b>TODO</b> <code>tick_broadcast_start_periodic</code>: set event_handler &#x2026;</li>
<li><code>tick_broadcast_setup_oneshot</code>:</li>
</ul>

<p>
<a href="https://lwn.net/Articles/574962/">ref:LWN tick broadcast</a>
</p>
</div>
</div>
<div id="outline-container-orgb6f813b" class="outline-3">
<h3 id="orgb6f813b"><span class="section-number-3">10.6</span> Timers</h3>
</div>
</div>

<div id="outline-container-org5763fc2" class="outline-2">
<h2 id="org5763fc2"><span class="section-number-2">11</span> Misc</h2>
<div class="outline-text-2" id="text-11">
</div>
<div id="outline-container-orgb757cca" class="outline-3">
<h3 id="orgb757cca"><span class="section-number-3">11.1</span> linux 构建过程</h3>
<div class="outline-text-3" id="text-11-1">
</div>
<div id="outline-container-orgd7e3348" class="outline-4">
<h4 id="orgd7e3348"><span class="section-number-4">11.1.1</span> linux kernel Makefile 文件组成</h4>
<div class="outline-text-4" id="text-11-1-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">名称</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">顶级 Makefile</td>
<td class="org-left">顶级 Makefile 主要负责构建：vmlinux(常驻内核映像)和模块(任何模块文件)</td>
</tr>

<tr>
<td class="org-left">.config</td>
<td class="org-left">配置文件，配置内核时生成。所有的Makefile文件（包括顶层目录和各级子目录）都是根据.config来决定使用哪些文件的</td>
</tr>

<tr>
<td class="org-left">arch/\$(ARCH)/Makefile</td>
<td class="org-left">不同平台的 Makefile</td>
</tr>

<tr>
<td class="org-left">scripts/Makefile.*</td>
<td class="org-left">Makefile 公用的通用规则、脚本等</td>
</tr>

<tr>
<td class="org-left">子目录 kbuild Makefiles</td>
<td class="org-left">各级子目录的Makefile相对简单，被上一层Makefile.build调用来编译当前目录的文件</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> scripts/Makefile.* 文件组成</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">名称</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Kbuild.include</td>
<td class="org-left">定义了一些函数如：if_changed，和变量如：build</td>
</tr>

<tr>
<td class="org-left">Makefile.build</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Makefile.lib</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Makefile.clean</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgb096d82" class="outline-4">
<h4 id="orgb096d82"><span class="section-number-4">11.1.2</span> Kbuild</h4>
<div class="outline-text-4" id="text-11-1-2">
<p>
利用 GNU Make 组织的一套复杂的构建系统。
Kbuild主要利用以下 Make 的功能
</p>
</div>

<ol class="org-ol">
<li><a id="orgee2cf71"></a>Makefile的包含<br />
<div class="outline-text-5" id="text-11-1-2-1">
<ul class="org-ul">
<li><p>
顶层 Makefile 包含平台相关的 Makefile(方便添加对新平台的支持)
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-keyword">include</span> arch/$(<span class="org-variable-name">SRCARCH</span>)/Makefile
</pre>
</div></li>

<li><p>
Makefile.build 包含各个子目录下的 Makefile:Kbuild 将所以与编译过程相关的公共的规则和变量都提取到 scripts 目录下的 Makefile.build, 具体子目录下的 Makefile 文件则可以写的非常简单和直接
</p>

<p>
<b>实现</b>: Kbuild 定义了 obj-y、obj-m 等变量,用于记录参与编译过程的文件。
例: <code>fs/notify/dnotify/Makefile</code>, 只有简单的一行
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">obj-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_DNOTIFY</span></span><span class="org-variable-name">)</span>           += dnotify.o
</pre>
</div>

<p>
在编译时,Makefile.build 会指导 make 将要编译的子目录下 Makefile 文件包含到 Makefile.inclde 中动态组成完整的 Makefile 文件。
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-comment-delimiter"># </span><span class="org-comment">scripts/Makefile.build</span>
<span class="org-variable-name">kbuild-dir</span> := $(<span class="org-variable-name">if</span> $(<span class="org-variable-name">filter</span> /%,$(<span class="org-variable-name">src</span>)),$(<span class="org-variable-name">src</span>),$(<span class="org-variable-name">srctree</span>)/$(<span class="org-variable-name">src</span>))
<span class="org-variable-name">kbuild-file</span> := $(<span class="org-variable-name">if</span> $(<span class="org-variable-name">wildcard</span> $(<span class="org-variable-name">kbuild-dir</span>)/Kbuild),$(<span class="org-variable-name">kbuild-dir</span>)/Kbuild,$(<span class="org-variable-name">kbuild-dir</span>)/Makefile)
<span class="org-keyword">include</span> $(<span class="org-variable-name">kbuild-file</span>)
</pre>
</div>
<ul class="org-ul">
<li><code>src</code> ：指向需要构建的目录(相对)</li>
<li><code>kbuild-dir</code> ：指向需要构建的目录(绝对)</li>
<li><code>srctree</code> ：内核顶层目录的绝对路径</li>
</ul></li>
</ul>
</div>
</li>

<li><a id="orgbf0e857"></a>使用指定 Makefile 的方式进行递归<br />
<div class="outline-text-5" id="text-11-1-2-2">
<ul class="org-ul">
<li>kbuild 编译子目录采用绝对目录的方式执行 make</li>
<li><p>
kbuild 使用的典型方式:
</p>

<div class="org-src-container">
<pre class="src src-makefile">$(MAKE) $(<span class="org-variable-name">build</span>)=&lt;subdir&gt; [target]
</pre>
</div>

<p>
make 执行 scripts/Makefile.build 将子目录中的 Makefile 包含到 Makefile.include,动态组成子目录的真正的 Makefile
</p>
<ul class="org-ul">
<li>通过 make 的 -f 选项将子目录的 Makefile 传递给 make: <code>$(MAKE)</code> 相当于 make 命令。</li>
<li><p>
<code>$(build)</code> 定义在 <code>Kbuild.include</code> 里。
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-comment-delimiter"># </span><span class="org-comment">scripts/Kbuild.include</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Shorthand for $(</span><span class="org-comment"><span class="org-variable-name">Q</span></span><span class="org-comment">)$(</span><span class="org-comment"><span class="org-variable-name">MAKE</span></span><span class="org-comment">) -f scripts/Makefile.build obj=</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Usage:</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">$(</span><span class="org-comment"><span class="org-variable-name">Q</span></span><span class="org-comment">)$(</span><span class="org-comment"><span class="org-variable-name">MAKE</span></span><span class="org-comment">) $(</span><span class="org-comment"><span class="org-variable-name">build</span></span><span class="org-comment">)=dir</span>
<span class="org-variable-name">build</span> := -f $(<span class="org-variable-name">srctree</span>)/scripts/Makefile.build obj
</pre>
</div>

<blockquote>
<p>
KBUILD_SRC 只有在子目录进行 make 时,才会被设置为子目录,否则在顶层目录进行 make,该变量为空。
</p>
</blockquote></li>
</ul></li>

<li>为了在顶层工作目录中跟踪编译所在的子目录,kbuild 定义了两个变量
<ul class="org-ul">
<li><p>
src：始终指向需要构建的目录
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-comment-delimiter"># </span><span class="org-comment">scripts/Makefile.build</span>
<span class="org-variable-name">src</span> := $(<span class="org-variable-name">obj</span>)
</pre>
</div></li>

<li><code>obj</code> ：指向构建的目标存放的目录</li>
<li>在引用源码树中已存在的对象时使用变量 <code>src</code>, 引用编译时动态生成的对象使用变量 <code>obj</code></li>
</ul></li>
</ul>
</div>
</li>

<li><a id="orgb2c59bf"></a>有用的函数<br />
<ol class="org-ol">
<li><a id="org60d3cbd"></a>if_changed<br />
<div class="outline-text-6" id="text-11-1-2-3-1">
<p>
如果 <code>any-prereq</code> 或 <code>arg-check</code> 发生改变,执行表达式 <code>$(cmd_$(1))</code> 展开的值。
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">if_changed</span> = $(<span class="org-variable-name">if</span> $(<span class="org-variable-name">strip</span> $(<span class="org-variable-name">any-prereq</span>) $(<span class="org-variable-name">arg-check</span>)),                       \
        @set -e;                                                             \
        $(<span class="org-variable-name">echo-cmd</span>) $(<span class="org-variable-name">cmd_</span>$(<span class="org-highlight-numbers-number">1</span>));                                             \
        printf <span class="org-string">'%s\n'</span> <span class="org-string">'cmd_</span><span class="org-makefile-targets"><span class="org-string">$</span></span><span class="org-makefile-targets"><span class="org-string"><span class="org-constant">@</span></span></span><span class="org-string"> := $(</span><span class="org-string"><span class="org-variable-name">make-cmd</span></span><span class="org-string">)'</span> &gt; $(<span class="org-variable-name">dot-target</span>).cmd, @:)
</pre>
</div>

<ul class="org-ul">
<li><code>any-prereq</code> ：检查是否有依赖比目标新,或依赖还没有创建。</li>
<li><code>arg-check</code> ：检查编译目标的命令相对上次是否发生变化。</li>
</ul>
</div>
</li>

<li><a id="org40b7045"></a>cmd 脚本<br />
<div class="outline-text-6" id="text-11-1-2-3-2">
<ul class="org-ul">
<li><p>
<code>cmd_ld</code> ：链接脚本
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-comment-delimiter"># </span><span class="org-comment">/scripts/Makefile.lib 228&#34892;</span>
<span class="org-variable-name">quiet_cmd_ld</span> = LD      <span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span>
<span class="org-variable-name">cmd_ld</span> = $(<span class="org-variable-name">LD</span>) $(<span class="org-variable-name">LDFLAGS</span>) $(<span class="org-variable-name">ldflags-y</span>) $(<span class="org-variable-name">LDFLAGS_</span>$(@F)) \
        $(<span class="org-variable-name">filter-out</span> FORCE,$<span class="org-constant">^</span>) -o <span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span>
</pre>
</div></li>

<li><p>
<code>cmd_objcopy</code> ：执行 <code>objcopy</code> ，使用 <code>OBJCOPYFLAGS_$(@F)</code> 等规则，将内核转换为裸二进制格式(删除如 .note .comment 等 elf 头)，并从 <code>$&lt;</code> 复制到 <code>$@</code>
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-comment-delimiter"># </span><span class="org-comment">/scripts/Makefile.lib 235&#34892;</span>
<span class="org-variable-name">quiet_cmd_objcopy</span> = OBJCOPY <span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span>
<span class="org-variable-name">cmd_objcopy</span> = $(<span class="org-variable-name">OBJCOPY</span>) $(<span class="org-variable-name">OBJCOPYFLAGS</span>) $(<span class="org-variable-name">OBJCOPYFLAGS_</span>$(@F)) $<span class="org-constant">&lt;</span> <span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span>
</pre>
</div>

<ul class="org-ul">
<li><code>$(@F)</code> ：表示去除目录的文件名</li>
</ul></li>
</ul>
</div>
</li>
</ol>
</li>
</ol>
</div>

<div id="outline-container-org1246178" class="outline-4">
<h4 id="org1246178"><span class="section-number-4">11.1.3</span> 根目录 Makefile 分析</h4>
<div class="outline-text-4" id="text-11-1-3">
</div>
<ol class="org-ol">
<li><a id="org792a798"></a>make 的输出<br />
<div class="outline-text-5" id="text-11-1-3-1">
<p>
Makefile 在执行时会回显整个命令，linux 定义了三种 make 显示方式
</p>
<ul class="org-ul">
<li><code>make V=0(默认)</code> ：打印简短的输出</li>
<li><code>make V=1</code> ：打印完整的输出</li>
<li><code>make -s</code> ：不显示任何输出</li>
</ul>
<p>
linux kernel 在 顶级 Makefile 里 定义了 <code>KBUILD_VERBOSE=、=quiet=、=Q</code>
</p>
<ul class="org-ul">
<li><code>KBUILD_VERBOSE=：相当与 =V</code></li>
<li><p>
<code>$(quiet)=：通过使用 =$($(quiet)$(cmd))</code> 定义不同的输出格式
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">quiet_cmd_cc_o_c</span> = Compiling $(<span class="org-variable-name">RELDIR</span>)/<span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span>
<span class="org-variable-name">cmd_cc_o_c</span>       = $(<span class="org-variable-name">CC</span>) $(<span class="org-variable-name">c_flags</span>) -c -o <span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span> $<span class="org-constant">&lt;</span>
</pre>
</div>

<ul class="org-ul">
<li><code>$(quiet)</code> 为空：对应 V = 1</li>
<li><code>$(quiet)</code> 为 quiet_：对应 V = 0</li>
<li><code>$(quiet)</code> 为 silent_：对于 -s</li>
</ul></li>
<li><p>
<code>$(Q)</code> ：是否显示命令
</p>
<ul class="org-ul">
<li><code>$(Q)</code> 为空(V=1)：显示命令</li>
<li><code>$(Q)</code> 为 @ (V=0)：隐藏命令</li>
</ul>
<p>
<b>注</b> ：@ 在 make 表示隐藏命令
</p></li>
</ul>
</div>
</li>

<li><a id="orgbfb538b"></a>目标 arch 的选择<br />
<div class="outline-text-5" id="text-11-1-3-2">
<p>
linux kernel 默认使用用户的 arch，通过 <code>SUBARCH</code> 确定。
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">SUBARCH</span> := $(<span class="org-variable-name">shell</span> uname -m | sed -e s/i.<span class="org-highlight-numbers-number">86/x86/</span> -e s/x86_64/x86/
                <span class="org-type">-</span><span class="org-makefile-shell">e s/sun4u/sparc64/ \</span>
                -e s/arm.*/arm/ -e s/sa110/arm/ \
                -e s/s390x/s390/ -e s/parisc64/parisc/ \
                -e s/ppc.*/powerpc/ -e s/mips.*/mips/ \
                -e s/sh[<span class="org-highlight-numbers-number">234</span>].*/sh/ -e s/aarch64.*/arm64/ \
                -e s/riscv.*/riscv/)
</pre>
</div>

<p>
如果对其他体系进行交叉编译应手动指定平台和交叉编译工具
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">ARCH</span>            ?= $(<span class="org-variable-name">SUBARCH</span>) <span class="org-comment-delimiter"># </span><span class="org-comment">&#36873;&#25321; arch/ &#19979;&#30340;&#24179;&#21488;</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#25351;&#23450;&#25152;&#26377;&#20132;&#21449;&#32534;&#35793;&#30456;&#20851;&#21487;&#25191;&#34892;&#25991;&#20214;&#30340;&#21069;&#32512;</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#22914; ia64-linux-</span>
<span class="org-variable-name">CROSS_COMPILE</span>   ?= $(<span class="org-variable-name">CONFIG_CROSS_COMPILE</span>:<span class="org-string">"%"</span>=%)
</pre>
</div>
</div>
</li>

<li><a id="orgef1afe3"></a>Makefile 的目标<br />
<div class="outline-text-5" id="text-11-1-3-3">
<ul class="org-ul">
<li>当在命令行没有指定目标时默认目标是 <code>all: vmlinux</code> 。</li>
<li><p>
更多的目标在 <code>arch/$(SRCARCH)/Makefile</code> ，该 Makefile 被包含在顶级 Makefile 里。
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-keyword">include</span> arch/$(<span class="org-variable-name">SRCARCH</span>)/Makefile
</pre>
</div></li>
</ul>
</div>

<ol class="org-ol">
<li><a id="org44370ab"></a>目标 vmlinux<br />
<div class="outline-text-6" id="text-11-1-3-3-1">
<div class="org-src-container">
<pre class="src src-makefile"><span class="org-makefile-targets">vmlinux</span>: scripts/link-vmlinux.sh autoksyms_recursive $(<span class="org-variable-name">vmlinux-deps</span>) FORCE
ifdef CONFIG_HEADERS_CHECK
        $(<span class="org-variable-name">Q</span>)$(<span class="org-variable-name">MAKE</span>) -f $(<span class="org-variable-name">srctree</span>)/Makefile headers_check
endif
ifdef CONFIG_GDB_SCRIPTS
        $(<span class="org-variable-name">Q</span>)ln -fsn $(<span class="org-variable-name">abspath</span> $(<span class="org-variable-name">srctree</span>)/scripts/gdb/vmlinux-gdb.py)
endif
        +$(<span class="org-variable-name">call</span> if_changed,link-vmlinux)
</pre>
</div>

<p>
link-vmlinux 展开的值为 cmd_link-vmlinux
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">cmd_link-vmlinux</span> =                                                 \
        $(<span class="org-variable-name">CONFIG_SHELL</span>) $<span class="org-constant">&lt;</span> $(<span class="org-variable-name">LD</span>) $(<span class="org-variable-name">LDFLAGS</span>) $(<span class="org-variable-name">LDFLAGS_vmlinux</span>) ;    \
        $(<span class="org-variable-name">if</span> $(<span class="org-variable-name">ARCH_POSTLINK</span>), $(<span class="org-variable-name">MAKE</span>) -f $(<span class="org-variable-name">ARCH_POSTLINK</span>) <span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span>, true)
</pre>
</div>

<p>
<code>cmd_link-vmlinux</code> 执行 <code>vmlinux</code> 的第一个依赖 <code>scripts/link-vmlinux.sh</code> ，该脚本负责链接 <code>vmlinux</code> 。
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">vmlinux</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">^</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">|</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">+-&lt; $(KBUILD_VMLINUX_INIT)</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">|   +--&lt; init/version.o + more</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">|</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">+--&lt; $(KBUILD_VMLINUX_MAIN)</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">|    +--&lt; drivers/built-in.a mm/built-in.a + more</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">|</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">+--&lt; $(KBUILD_VMLINUX_LIBS)</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">|    +--&lt; lib/lib.a + more</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">|</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">+-&lt; ${kallsymso} (see description in KALLSYMS section)</span>
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org9a67cfd"></a>依赖的目标<br />
<div class="outline-text-7" id="text-11-1-3-3-1-1">
<ul class="org-ul">
<li><code>$(vmlinux-deps)</code> ：vmlinux 的依赖包含下面目录的 <code>built-in.a</code> 。</li>
</ul>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-comment-delimiter"># </span><span class="org-comment">arch/$(</span><span class="org-comment"><span class="org-variable-name">SRCARCH</span></span><span class="org-comment">)/Makefile &#19979;</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#20363; x86/Makefile 269 &#34892;</span>
<span class="org-variable-name">head-y</span> += arch/x86/kernel/head$(<span class="org-variable-name">BITS</span>).o
<span class="org-variable-name">head-y</span> += arch/x86/kernel/ebda.o
<span class="org-variable-name">head-y</span> += arch/x86/kernel/platform-quirks.o

<span class="org-variable-name">libs-y</span>  += arch/x86/lib/

<span class="org-comment-delimiter"># </span><span class="org-comment">See arch/x86/Kbuild for content of core part of the kernel</span>
<span class="org-variable-name">core-y</span> += arch/x86/

<span class="org-comment-delimiter"># </span><span class="org-comment">drivers-y are linked after core-y</span>
<span class="org-variable-name">drivers-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_MATH_EMULATION</span></span><span class="org-variable-name">)</span> += arch/x86/math-emu/
<span class="org-variable-name">drivers-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_PCI</span></span><span class="org-variable-name">)</span>            += arch/x86/pci/

<span class="org-comment-delimiter"># </span><span class="org-comment">must be linked after kernel/</span>
<span class="org-variable-name">drivers-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_OPROFILE</span></span><span class="org-variable-name">)</span> += arch/x86/oprofile/

<span class="org-comment-delimiter"># </span><span class="org-comment">suspend and hibernation support</span>
<span class="org-variable-name">drivers-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_PM</span></span><span class="org-variable-name">)</span> += arch/x86/power/

<span class="org-variable-name">drivers-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_FB</span></span><span class="org-variable-name">)</span> += arch/x86/video/
...
<span class="org-comment-delimiter"># </span><span class="org-comment">575 &#34892;</span>
<span class="org-variable-name">init-y</span>          := init/
<span class="org-variable-name">drivers-y</span>       := drivers/ sound/ firmware/
<span class="org-variable-name">net-y</span>           := net/
<span class="org-variable-name">libs-y</span>          := lib/
<span class="org-variable-name">core-y</span>          := usr/
<span class="org-variable-name">virt-y</span>          := virt/
...
<span class="org-comment-delimiter"># </span><span class="org-comment">981 &#34892;</span>
<span class="org-variable-name">core-y</span>          += kernel/ certs/ mm/ fs/ ipc/ security/ crypto/ block/
...
<span class="org-comment-delimiter"># </span><span class="org-comment">990 &#34892;</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">init/built-in.a</span>
<span class="org-variable-name">init-y</span>          := $(<span class="org-variable-name">patsubst</span> %/, %/built-in.a, $(<span class="org-variable-name">init-y</span>))
<span class="org-comment-delimiter"># </span><span class="org-comment">usr/built-in.a ...</span>
<span class="org-variable-name">core-y</span>          := $(<span class="org-variable-name">patsubst</span> %/, %/built-in.a, $(<span class="org-variable-name">core-y</span>))
<span class="org-comment-delimiter"># </span><span class="org-comment">drivers/built-in.a sound/built-in.a firmware/built-in.a</span>
<span class="org-variable-name">drivers-y</span>       := $(<span class="org-variable-name">patsubst</span> %/, %/built-in.a, $(<span class="org-variable-name">drivers-y</span>))
<span class="org-comment-delimiter"># </span><span class="org-comment">net/built-in.a</span>
<span class="org-variable-name">net-y</span>           := $(<span class="org-variable-name">patsubst</span> %/, %/built-in.a, $(<span class="org-variable-name">net-y</span>))
<span class="org-comment-delimiter"># </span><span class="org-comment">lib/lib.a</span>
<span class="org-variable-name">libs-y1</span>         := $(<span class="org-variable-name">patsubst</span> %/, %/lib.a, $(<span class="org-variable-name">libs-y</span>))
<span class="org-comment-delimiter"># </span><span class="org-comment">lib/built-in.a</span>
<span class="org-variable-name">libs-y2</span>         := $(<span class="org-variable-name">patsubst</span> %/, %/built-in.a, $(<span class="org-variable-name">filter-out</span> %.a, $(<span class="org-variable-name">libs-y</span>)))
<span class="org-comment-delimiter"># </span><span class="org-comment">virt/built-in.a</span>
<span class="org-variable-name">virt-y</span>          := $(<span class="org-variable-name">patsubst</span> %/, %/built-in.a, $(<span class="org-variable-name">virt-y</span>))

<span class="org-comment-delimiter"># </span><span class="org-comment">&#32473; link-vmlinux.sh &#20351;&#29992;</span>
export <span class="org-variable-name">KBUILD_VMLINUX_INIT</span> := $(<span class="org-variable-name">head-y</span>) $(<span class="org-variable-name">init-y</span>)
export <span class="org-variable-name">KBUILD_VMLINUX_MAIN</span> := $(<span class="org-variable-name">core-y</span>) $(<span class="org-variable-name">libs-y2</span>) $(<span class="org-variable-name">drivers-y</span>) $(<span class="org-variable-name">net-y</span>) $(<span class="org-variable-name">virt-y</span>)
export <span class="org-variable-name">KBUILD_VMLINUX_LIBS</span> := $(<span class="org-variable-name">libs-y1</span>)
export <span class="org-variable-name">KBUILD_LDS</span>          := arch/$(<span class="org-variable-name">SRCARCH</span>)/kernel/vmlinux.lds
<span class="org-comment-delimiter"># </span><span class="org-comment">...</span>
<span class="org-variable-name">vmlinux-deps</span> := $(<span class="org-variable-name">KBUILD_LDS</span>) $(<span class="org-variable-name">KBUILD_VMLINUX_INIT</span>) $(<span class="org-variable-name">KBUILD_VMLINUX_MAIN</span>) $(<span class="org-variable-name">KBUILD_VMLINUX_LIBS</span>)

<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">sort</span></span><span class="org-makefile-targets"> $(</span><span class="org-variable-name"><span class="org-makefile-targets">vmlinux-deps</span></span><span class="org-makefile-targets">))</span>: $(<span class="org-variable-name">vmlinux-dirs</span>) ;
</pre>
</div>

<ul class="org-ul">
<li><p>
<code>$(vmlinux-dirs)</code> ：递归 make 相关子目录，生成 built-in.a 或 lib.a，vmlinux-dirs：将相关 <code>dirs/</code> 替换为 <code>dirs</code>
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-comment-delimiter"># </span><span class="org-comment">983 &#34892;</span>
<span class="org-variable-name">vmlinux-dirs</span>    := $(<span class="org-variable-name">patsubst</span> %/,%,$(<span class="org-variable-name">filter</span> %/, $(<span class="org-variable-name">init-y</span>) $(<span class="org-variable-name">init-m</span>) \
                        $(<span class="org-variable-name">core-y</span>) $(<span class="org-variable-name">core-m</span>) $(<span class="org-variable-name">drivers-y</span>) $(<span class="org-variable-name">drivers-m</span>) \
                        $(<span class="org-variable-name">net-y</span>) $(<span class="org-variable-name">net-m</span>) $(<span class="org-variable-name">libs-y</span>) $(<span class="org-variable-name">libs-m</span>) $(<span class="org-variable-name">virt-y</span>)))
...
<span class="org-comment-delimiter"># </span><span class="org-comment">1062 &#34892;</span>
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">vmlinux-dirs</span></span><span class="org-makefile-targets">)</span>: prepare scripts
        $(<span class="org-variable-name">Q</span>)$(<span class="org-variable-name">MAKE</span>) $(<span class="org-variable-name">build</span>)=<span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span> need-builtin=<span class="org-highlight-numbers-number">1</span>
</pre>
</div></li>
<li><p>
<code>autoksyms_recursive</code> ：
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-makefile-targets">autoksyms_recursive</span>: $(<span class="org-variable-name">vmlinux-deps</span>)
ifdef CONFIG_TRIM_UNUSED_KSYMS
    $(<span class="org-variable-name">Q</span>)$(<span class="org-variable-name">CONFIG_SHELL</span>) $(<span class="org-variable-name">srctree</span>)/scripts/adjust_autoksyms.sh \
      <span class="org-string">"$(</span><span class="org-string"><span class="org-variable-name">MAKE</span></span><span class="org-string">) -f $(</span><span class="org-string"><span class="org-variable-name">srctree</span></span><span class="org-string">)/Makefile vmlinux"</span>
endif
</pre>
</div></li>
</ul>
</div>
</li>
</ol>
</li>

<li><a id="orgda04d44"></a>目标 bzImage<br />
<div class="outline-text-6" id="text-11-1-3-3-2">
<p>
<code>bzImage</code> 在 <code>arch/$(ARCH)/Makefile</code>
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-makefile-targets">bzImage</span>: vmlinux
ifeq ($(<span class="org-variable-name">CONFIG_X86_DECODER_SELFTEST</span>),y)
        $(<span class="org-variable-name">Q</span>)$(<span class="org-variable-name">MAKE</span>) $(<span class="org-variable-name">build</span>)=arch/x86/tools posttest
endif
        $(<span class="org-variable-name">Q</span>)$(<span class="org-variable-name">MAKE</span>) $(<span class="org-variable-name">build</span>)=$(<span class="org-variable-name">boot</span>) $(<span class="org-variable-name">KBUILD_IMAGE</span>)
        $(<span class="org-variable-name">Q</span>)mkdir -p $(<span class="org-variable-name">objtree</span>)/arch/$(<span class="org-variable-name">UTS_MACHINE</span>)/boot
        $(<span class="org-variable-name">Q</span>)ln -fsn ../../x86/boot/bzImage $(<span class="org-variable-name">objtree</span>)/arch/$(<span class="org-variable-name">UTS_MACHINE</span>)/boot/<span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span>
</pre>
</div>

<p>
<code>$(Q)$(MAKE) $(build)=$(boot) $(KBUILD_IMAGE)</code> 展开为
</p>

<div class="org-src-container">
<pre class="src src-makefile">make -f scripts/Makefile.build obj=arch/x86/boot arch/x86/boot/bzImage
</pre>
</div>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">cmd_image</span> = $(<span class="org-variable-name">obj</span>)/tools/build $(<span class="org-variable-name">obj</span>)/setup.bin $(<span class="org-variable-name">obj</span>)/vmlinux.bin \
                               $(<span class="org-variable-name">obj</span>)/zoffset.h <span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span> $($(<span class="org-variable-name">quiet</span>)redirect_image)
...
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/bzImage</span>: $(<span class="org-variable-name">obj</span>)/setup.bin $(<span class="org-variable-name">obj</span>)/vmlinux.bin $(<span class="org-variable-name">obj</span>)/tools/build FORCE
        $(<span class="org-variable-name">call</span> if_changed,image)
        <span class="org-type">@</span><span class="org-makefile-shell">$(</span><span class="org-makefile-shell"><span class="org-variable-name">kecho</span></span><span class="org-makefile-shell">) </span><span class="org-string"><span class="org-makefile-shell">'Kernel: </span></span><span class="org-makefile-targets"><span class="org-string"><span class="org-makefile-shell">$</span></span></span><span class="org-makefile-targets"><span class="org-string"><span class="org-makefile-shell"><span class="org-constant">@</span></span></span></span><span class="org-string"><span class="org-makefile-shell"> is ready'</span></span><span class="org-makefile-shell"> </span><span class="org-string"><span class="org-makefile-shell">' (#'`cat .version`')'</span></span>
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org04fada8"></a>依赖的目标<br />
<div class="outline-text-7" id="text-11-1-3-3-2-1">
<ul class="org-ul">
<li><code>$(obj)/tools/build</code> ：从三个不同的文件构建磁盘映像(简单连接为 bzImage)，它会检查所有文件的类型是否正确，并在指定目的地写入结果，移除头和适当填充，写一些系统数据到 stdout
<ul class="org-ul">
<li>setup：8086 machine code, sets up system parm</li>
<li>system：80386 code for actual system</li>
<li>zoffset.h：header with ZO_* defines</li>
</ul></li>
<li><p>
<code>$(obj)/vmlinux.bin</code> ：删除 .note .comment elf头、符号表和重定位表，并从 arch/x86/boot/compressed/vmlinux 复制到 arch/x86/boot/vmlinux.bin
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">OBJCOPYFLAGS_vmlinux.bin</span> := -O binary -R .note -R .comment -S
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/vmlinux.bin</span>: $(<span class="org-variable-name">obj</span>)/compressed/vmlinux FORCE
        $(<span class="org-variable-name">call</span> if_changed,objcopy)
...
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/compressed/vmlinux</span>: FORCE
        $(<span class="org-variable-name">Q</span>)$(<span class="org-variable-name">MAKE</span>) $(<span class="org-variable-name">build</span>)=$(<span class="org-variable-name">obj</span>)/compressed <span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span>
</pre>
</div>

<ul class="org-ul">
<li><p>
<code>$(obj)/compressed/vmlinux</code> ：创建一个压缩的 vmlinux image。
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-comment-delimiter"># </span><span class="org-comment">/arch/x86/boot/compressed/Makefile</span>
<span class="org-variable-name">vmlinux-objs-y</span> := $(<span class="org-variable-name">obj</span>)/vmlinux.lds $(<span class="org-variable-name">obj</span>)/head_$(<span class="org-variable-name">BITS</span>).o $(<span class="org-variable-name">obj</span>)/misc.o \
                        $(<span class="org-variable-name">obj</span>)/string.o $(<span class="org-variable-name">obj</span>)/cmdline.o $(<span class="org-variable-name">obj</span>)/error.o \
                        $(<span class="org-variable-name">obj</span>)/piggy.o $(<span class="org-variable-name">obj</span>)/cpuflags.o

<span class="org-variable-name">vmlinux-objs-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_EARLY_PRINTK</span></span><span class="org-variable-name">)</span> += $(<span class="org-variable-name">obj</span>)/early_serial_console.o
<span class="org-variable-name">vmlinux-objs-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_RANDOMIZE_BASE</span></span><span class="org-variable-name">)</span> += $(<span class="org-variable-name">obj</span>)/kaslr.o
ifdef CONFIG_X86_64
<span class="org-variable-name">vmlinux-objs-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_RANDOMIZE_BASE</span></span><span class="org-variable-name">)</span> += $(<span class="org-variable-name">obj</span>)/kaslr_64.o
<span class="org-variable-name">vmlinux-objs-y</span> += $(<span class="org-variable-name">obj</span>)/mem_encrypt.o
<span class="org-variable-name">vmlinux-objs-y</span> += $(<span class="org-variable-name">obj</span>)/pgtable_64.o
endif

<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/eboot.o</span>: <span class="org-variable-name">KBUILD_CFLAGS</span> += -fshort-wchar -mno-red-zone

<span class="org-variable-name">vmlinux-objs-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_EFI_STUB</span></span><span class="org-variable-name">)</span> += $(<span class="org-variable-name">obj</span>)/eboot.o $(<span class="org-variable-name">obj</span>)/efi_stub_$(<span class="org-variable-name">BITS</span>).o \
                        $(<span class="org-variable-name">objtree</span>)/drivers/firmware/efi/libstub/lib.a
<span class="org-variable-name">vmlinux-objs-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_EFI_MIXED</span></span><span class="org-variable-name">)</span> += $(<span class="org-variable-name">obj</span>)/efi_thunk_$(<span class="org-variable-name">BITS</span>).o
...
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/vmlinux</span>: $(<span class="org-variable-name">vmlinux-objs-y</span>) FORCE
        $(<span class="org-variable-name">call</span> if_changed,check_data_rel)
        $(<span class="org-variable-name">call</span> if_changed,ld)
</pre>
</div>

<ul class="org-ul">
<li><p>
<code>$(vmlinux-objs-y)</code> ：vmlinux 链接依赖的一些文件
其中 piggy.o 由目标 <code>$(obj)/piggy.S</code> 生成，包含了压缩映像和解压内核所需的信息。
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-makefile-targets">$(obj)/piggy.S</span>: $(<span class="org-variable-name">obj</span>)/vmlinux.bin.$(<span class="org-variable-name">suffix-y</span>) $(<span class="org-variable-name">obj</span>)/mkpiggy FORCE
        $(<span class="org-variable-name">call</span> if_changed,mkpiggy)
</pre>
</div>

<p>
生成的示例：定义了解压 <code>vmlinux.bin.$(suffix-y)</code> 的需要的一些信息，包括压缩映像的长度、解压后的长度等。
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.section</span> <span class="org-string">".rodata..compressed"</span>,<span class="org-string">"a"</span>,@progbits
<span class="org-keyword">.globl</span> z_input_len
<span class="org-function-name">z_input_len</span> = <span class="org-highlight-numbers-number">589355</span>
<span class="org-keyword">.globl</span> z_output_len
<span class="org-function-name">z_output_len</span> = <span class="org-highlight-numbers-number">1264628</span>
<span class="org-keyword">.globl</span> input_data, input_data_end
<span class="org-function-name">input_data</span>:
<span class="org-keyword">.incbin</span> <span class="org-string">"arch/x86/boot/compressed/vmlinux.bin.gz"</span>
<span class="org-function-name">input_data_end</span>:
</pre>
</div>

<ul class="org-ul">
<li><p>
<code>$(suffix-y)</code> ：定义 vmlinux 压缩方式
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">suffix-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_KERNEL_GZIP</span></span><span class="org-variable-name">)</span>    := gz
<span class="org-variable-name">suffix-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_KERNEL_BZIP2</span></span><span class="org-variable-name">)</span>   := bz2
<span class="org-variable-name">suffix-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_KERNEL_LZMA</span></span><span class="org-variable-name">)</span>    := lzma
<span class="org-variable-name">suffix-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_KERNEL_XZ</span></span><span class="org-variable-name">)</span>      := xz
<span class="org-variable-name">suffix-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_KERNEL_LZO</span></span><span class="org-variable-name">)</span>     := lzo
<span class="org-variable-name">suffix-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_KERNEL_LZ4</span></span><span class="org-variable-name">)</span>     := lz4
</pre>
</div></li>

<li><p>
<code>$(obj)/vmlinux.bin.$(suffix-y)</code> ：对 vmlinux.bin (和 <code>vmlinux.relocs</code>)执行压缩
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-makefile-targets">$(obj)/vmlinux.bin.gz</span>: $(<span class="org-variable-name">vmlinux.bin.all-y</span>) FORCE
        $(<span class="org-variable-name">call</span> if_changed,gzip)
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/vmlinux.bin.bz2</span>: $(<span class="org-variable-name">vmlinux.bin.all-y</span>) FORCE
        $(<span class="org-variable-name">call</span> if_changed,bzip2)
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/vmlinux.bin.lzma</span>: $(<span class="org-variable-name">vmlinux.bin.all-y</span>) FORCE
        $(<span class="org-variable-name">call</span> if_changed,lzma)
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/vmlinux.bin.xz</span>: $(<span class="org-variable-name">vmlinux.bin.all-y</span>) FORCE
        $(<span class="org-variable-name">call</span> if_changed,xzkern)
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/vmlinux.bin.lzo</span>: $(<span class="org-variable-name">vmlinux.bin.all-y</span>) FORCE
        $(<span class="org-variable-name">call</span> if_changed,lzo)
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/vmlinux.bin.lz4</span>: $(<span class="org-variable-name">vmlinux.bin.all-y</span>) FORCE
        $(<span class="org-variable-name">call</span> if_changed,lz4)
</pre>
</div>

<p>
<code>$(vmlinux.bin.all-y)</code> ：执行 <code>$(obj)/vmlinux.bin</code> 如 配置 <code>relocs</code> 执行 <code>$(obj)/vmlinux.relocs</code> (如果内核被配置为可重定位，包括记录重定位信息的 <code>vmlinux.relocs</code>)。
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">vmlinux.bin.all-y</span> := $(<span class="org-variable-name">obj</span>)/vmlinux.bin
<span class="org-variable-name">vmlinux.bin.all-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_X86_NEED_RELOCS</span></span><span class="org-variable-name">)</span> += $(<span class="org-variable-name">obj</span>)/vmlinux.relocs
</pre>
</div>

<p>
<code>$(obj)/vmlinux.bin</code> ：删除 .comment elf头、符号表和重定位表，并从 /vmlinux 复制到 arch/x86/boot/compressed/vmlinux.bin
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">OBJCOPYFLAGS_vmlinux.bin</span> :=  -R .comment -S
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/vmlinux.bin</span>: vmlinux FORCE
        $(<span class="org-variable-name">call</span> if_changed,objcopy)
</pre>
</div></li>
</ul></li>
<li><code>cmd_check_data_rel</code> ：检查 elf 是否存在重定位数据，存在则停止链接</li>
<li><code>cmd_ld</code> ：vmlinux.lds 指导链接规则</li>
</ul></li>
</ul></li>
<li><p>
<code>$(obj)/setup.bin</code> ：将相关文件链接为 setup.elf 并转换为裸二进制格式的 setup.bin
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">setup-y</span>         += a20.o bioscall.o cmdline.o copy.o cpu.o cpuflags.o cpucheck.o
<span class="org-variable-name">setup-y</span>         += early_serial_console.o edd.o header.o main.o memory.o
<span class="org-variable-name">setup-y</span>         += pm.o pmjump.o printf.o regs.o string.o tty.o video.o
<span class="org-variable-name">setup-y</span>         += video-mode.o version.o
<span class="org-variable-name">setup-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_X86_APM_BOOT</span></span><span class="org-variable-name">)</span> += apm.o

<span class="org-variable-name">setup-y</span>         += video-vga.o
<span class="org-variable-name">setup-y</span>         += video-vesa.o
<span class="org-variable-name">setup-y</span>         += video-bios.o
...
<span class="org-variable-name">SETUP_OBJS</span> = $(<span class="org-variable-name">addprefix</span> $(<span class="org-variable-name">obj</span>)/,$(<span class="org-variable-name">setup-y</span>))
...
<span class="org-variable-name">LDFLAGS_setup.elf</span>       := -T
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/setup.elf</span>: $(<span class="org-variable-name">src</span>)/setup.ld $(<span class="org-variable-name">SETUP_OBJS</span>) FORCE
        $(<span class="org-variable-name">call</span> if_changed,ld)

<span class="org-variable-name">OBJCOPYFLAGS_setup.bin</span>  := -O binary
        <span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/setup.bin</span>: $(<span class="org-variable-name">obj</span>)/setup.elf FORCE
        $(<span class="org-variable-name">call</span> if_changed,objcopy)
</pre>
</div></li>

<li><p>
<code>$(obj)/zoffset.h</code> ：使用 nm 提取 vmlinx 信息输出为 zoffset.h
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">sed-zoffset</span> := -e <span class="org-string">'s/^\([0-9a-fA-F]*\) [ABCDGRSTVW] \(startup_32\|startup_64\|efi32_stub_entry\|efi64_stub_entry\|efi_pe_entry\|input_data\|_end\|_ehead\|_text\|z_.*\)$$/\#define ZO_\2 0x\1/p'</span>

<span class="org-variable-name">quiet_cmd_zoffset</span> = ZOFFSET <span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span>
<span class="org-variable-name">cmd_zoffset</span> = $(<span class="org-variable-name">NM</span>) $<span class="org-constant">&lt;</span> | sed -n $(<span class="org-variable-name">sed-zoffset</span>) &gt; <span class="org-makefile-targets">$</span><span class="org-makefile-targets"><span class="org-constant">@</span></span>

<span class="org-variable-name">targets</span> += zoffset.h
<span class="org-makefile-targets">$(</span><span class="org-variable-name"><span class="org-makefile-targets">obj</span></span><span class="org-makefile-targets">)/zoffset.h</span>: $(<span class="org-variable-name">obj</span>)/compressed/vmlinux FORCE
        $(<span class="org-variable-name">call</span> if_changed,zoffset)
</pre>
</div>

<p>
输出示例
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#define</span> <span class="org-variable-name">ZO__ehead</span> <span class="org-highlight-numbers-number">0x00000069</span> <span class="org-comment-delimiter">// </span><span class="org-comment">vmlinux &#22836;&#37096;&#20195;&#30721;&#30340;&#32467;&#26463;&#20301;&#32622;</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">ZO__end</span> <span class="org-highlight-numbers-number">0x000a6000</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">ZO__text</span> <span class="org-highlight-numbers-number">0x0008fe94</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">ZO_input_data</span> <span class="org-highlight-numbers-number">0x00000069</span> <span class="org-comment-delimiter">// </span><span class="org-comment">vmlinux &#21387;&#32553;&#20869;&#26680;&#30340;&#36215;&#22987;&#20301;&#32622;</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">ZO_startup_32</span> <span class="org-highlight-numbers-number">0x00000000</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">ZO_z_input_len</span> <span class="org-highlight-numbers-number">0x0008fe2b</span> <span class="org-comment-delimiter">// </span><span class="org-comment">&#21387;&#32553;&#20869;&#26680;&#30340;&#38271;&#24230;</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">ZO_z_output_len</span> <span class="org-highlight-numbers-number">0x00134bf4</span> <span class="org-comment-delimiter">// </span><span class="org-comment">&#35299;&#21387;&#32553;&#20869;&#26680;&#21518;&#30340;&#38271;&#24230;</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org8d56fad"></a>总结<br />
<div class="outline-text-7" id="text-11-1-3-3-2-2">
<ol class="org-ol">
<li>将根目录的 vmlinux 复制到 arch/x86/boot/compressed/vmliux.bin，并删除 .comment elf头、符号表和重定位表。</li>
<li>定义压缩方式，将 vmlinux.bin 和 vmlinux.relocs(若配置了可重定向) 压缩为如 vmlinux.bin.gz。</li>
<li>使用内核自带的工具 mkpiggy 构建了 piggy.S(定义了解压内核所需的信息)。</li>
<li>将相关文件 head_32.o、misc.o 和包含压缩映像的 piggy.o 等目标文件链接为 vmlinux。</li>
<li>将 arch/x86/boot/compressed/vmlinux 复制到 arch/x86/boot/vmlinux.bin 并删除 .note .comment elf头、符号表和重定位表。</li>
<li>使用 nm 提取 vmlinx 信息生成为 zoffset.h</li>
<li>将相关文件链接为 setup.elf 并转换为裸二进制格式的 setup.bin。</li>
<li>将 setup.bin vmlinux.bin zoffset.h 简单链接为 bzImage。</li>
</ol>
</div>
</li>
</ol>
</li>

<li><a id="orga8a25d2"></a>相关目标<br />
<div class="outline-text-6" id="text-11-1-3-3-3">
<ul class="org-ul">
<li><p>
FORCE：这个规则没有命令也没有依赖，它的目标也不是一个存在的文件名。在执行此规则时，目标 FORCE 总会被认为是最新的。这样当它作为其它规则的依赖时，因为依赖总被认为被更新过的，所以那个规则的中定义的命令总会被执行。
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">PHONY</span> += FORCE
<span class="org-makefile-targets">FORCE</span>:
</pre>
</div></li>

<li>scripts_basic：修复文件依赖性，避免内核配置发生改变时避免文件重新编译。</li>
<li><p>
scripts：脚本包含用于构建过程中遍及内核的各种辅助程序，如：
</p>
<ul class="org-ul">
<li>kallsyms：在 vmlinux 中查找所有符号</li>
<li>pnmttologo：Convert pnm files to logo files</li>
<li>等等</li>
</ul>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">PHONY</span> += scripts
<span class="org-makefile-targets">scripts</span>: scripts_basic include/config/auto.conf include/config/tristate.conf \
                                asm-generic gcc-plugins $(<span class="org-variable-name">autoksyms_h</span>)
        $(<span class="org-variable-name">Q</span>)$(<span class="org-variable-name">MAKE</span>) $(<span class="org-variable-name">build</span>)=$(<span class="org-variable-name">@</span>)
</pre>
</div>

<p>
<b>asm-generic 和 uapi-asm-generic</b> ：为一些特定的平台生成通用头文件，如构建 x86 为了支持 i386 生成一些 i386 的头文件(如 syscall_32.h)
</p></li>
<li><p>
prepare：在构建内核之前的一些准备工作
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">PHONY</span> += prepare archprepare prepare0 prepare1 prepare2 prepare3
<span class="org-comment-delimiter"># </span><span class="org-comment">prepare3 &#34987;&#29992;&#26469;&#26597;&#30475;&#26159;&#21542;&#22312;&#19968;&#20010;&#21333;&#29420;&#30340;&#36755;&#20986;&#30446;&#24405;&#26500;&#24314;</span>
<span class="org-makefile-targets">prepare3</span>: include/config/kernel.release
ifneq ($(<span class="org-variable-name">KBUILD_SRC</span>),)
        <span class="org-type">@</span><span class="org-makefile-shell">$(</span><span class="org-makefile-shell"><span class="org-variable-name">kecho</span></span><span class="org-makefile-shell">) </span><span class="org-string"><span class="org-makefile-shell">'  Using $(</span></span><span class="org-string"><span class="org-makefile-shell"><span class="org-variable-name">srctree</span></span></span><span class="org-string"><span class="org-makefile-shell">) as source for kernel'</span></span>
        $(<span class="org-variable-name">Q</span>)if [ -f $(<span class="org-variable-name">srctree</span>)/.config -o -d $(<span class="org-variable-name">srctree</span>)/include/config ]; then \
                echo &gt;&amp;2 <span class="org-string">"  $(</span><span class="org-string"><span class="org-variable-name">srctree</span></span><span class="org-string">) is not clean, please run 'make mrproper'"</span>; \
                echo &gt;&amp;2 <span class="org-string">"  in the '$(</span><span class="org-string"><span class="org-variable-name">srctree</span></span><span class="org-string">)' directory."</span>;\
        /bin/false; \
        fi;
endif

<span class="org-comment-delimiter"># </span><span class="org-comment">prepare2 &#22914;&#26524;&#22312;&#21333;&#29420;&#30446;&#24405;&#36755;&#20986;&#21017;&#21019;&#24314;&#19968;&#20010; makefile</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#21644; .config &#30340;&#30456;&#20851;&#26816;&#26597;</span>
<span class="org-makefile-targets">prepare2</span>: prepare3 prepare-compiler-check outputmakefile asm-generic

<span class="org-makefile-targets">prepare1</span>: prepare2 $(<span class="org-variable-name">version_h</span>) $(<span class="org-variable-name">autoksyms_h</span>) include/generated/utsrelease.h \
                        include/config/auto.conf
        $(<span class="org-variable-name">cmd_crmodverdir</span>)
<span class="org-makefile-targets">archprepare</span>: archheaders archscripts prepare1 scripts_basic

<span class="org-makefile-targets">prepare0</span>: archprepare gcc-plugins
        $(<span class="org-variable-name">Q</span>)$(<span class="org-variable-name">MAKE</span>) $(<span class="org-variable-name">build</span>)=.

<span class="org-makefile-targets">prepare</span>: prepare0 prepare-objtool

<span class="org-makefile-targets">prepare-objtool</span>: $(<span class="org-variable-name">objtool_target</span>)
...
<span class="org-comment-delimiter"># </span><span class="org-comment">&#20026;&#27169;&#22359;&#25903;&#25345;&#25991;&#20214;&#21019;&#24314;&#32531;&#23384;&#30446;&#24405;</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#21482;&#26377;&#22312;&#26500;&#24314;&#25152;&#26377;&#27169;&#22359;&#26102;&#25165;&#36827;&#34892;&#28165;&#29702;</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">clean it up only when building all modules</span>
<span class="org-variable-name">cmd_crmodverdir</span> = $(<span class="org-variable-name">Q</span>)mkdir -p $(<span class="org-variable-name">MODVERDIR</span>) \
                $(<span class="org-variable-name">if</span> $(<span class="org-variable-name">KBUILD_MODULES</span>),; rm -f $(<span class="org-variable-name">MODVERDIR</span>)/*)
</pre>
</div></li>
</ul>
</div>
</li>
</ol>
</li>
</ol>
</div>
</div>
<div id="outline-container-orga2ad718" class="outline-3">
<h3 id="orga2ad718"><span class="section-number-3">11.2</span> linux kernel rootfs</h3>
<div class="outline-text-3" id="text-11-2">
<ol class="org-ol">
<li><p>
创建硬盘镜像 img，bs(柱面) = 16(磁头数) x 63(扇区数) x 512B
</p>
<div class="org-src-container">
<pre class="src src-shell">dd <span class="org-variable-name">if</span>=/dev/zero <span class="org-variable-name">of</span>=hd.img <span class="org-variable-name">bs</span>=<span class="org-highlight-numbers-number">516096c</span> <span class="org-variable-name">count</span>=<span class="org-highlight-numbers-number">100</span>
</pre>
</div></li>
<li><p>
初始化磁盘并分区
</p>
<div class="org-src-container">
<pre class="src src-shell">fdisk hd.img
</pre>
</div></li>
<li><p>
挂载硬盘镜像
</p>
<ul class="org-ul">
<li>udisksctl 方式： <code>udisksctl loop-setup -f hd.img</code></li>
<li>losetup 方式： <code>losetup -o 32256 /dev/loop0 hd.img</code></li>
</ul>
<blockquote>
<p>
卸载方式
</p>
<ul class="org-ul">
<li>udisksctl： <code>udisksctl loop-delete -b /dev/loop0 /dev/loop0</code></li>
<li>losetup： <code>losetup -d /dev/loop0</code></li>
</ul>
</blockquote></li>
<li><p>
格式化文件系统
</p>
<div class="org-src-container">
<pre class="src src-shell">mkfs.ext4 /dev/loop0p1
</pre>
</div></li>
<li><p>
挂载文件系统
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo mount /dev/loop0p1 rootfs
</pre>
</div></li>
</ol>
</div>

<div id="outline-container-org64c102e" class="outline-4">
<h4 id="org64c102e"><span class="section-number-4">11.2.1</span> grub</h4>
<div class="outline-text-4" id="text-11-2-1">
<ol class="org-ol">
<li>创建 boot 和 grub 目录： <code>mkdir -p rootfs/boot/grub</code></li>
<li>bzImage 到 rootfs/boot</li>
<li><p>
grub-install
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo grub-install --target=i386-pc /dev/loop0 --boot-directory=rootfs/boot
</pre>
</div></li>
<li><p>
配置 grub.cfg
</p>
<pre class="example">
set timeout=5
# set pager=1
set debug=all # 打印调试信息
menuentry 'linux' {
	 set root='(hd0, 1)'
	 linux /boot/bzImage root=/dev/sda1 ro rootdelay=5 panic=10 debug ignore_loglevel
         }
</pre></li>
<li>配置 bochs</li>
</ol>
</div>
</div>

<div id="outline-container-orga23027c" class="outline-4">
<h4 id="orga23027c"><span class="section-number-4">11.2.2</span> busybox + qemu</h4>
<div class="outline-text-4" id="text-11-2-2">
<ol class="org-ol">
<li><p>
build busybox
Note: busybox config <code>Setting -&gt; Build static binary(no shared libs)</code>
</p>
<div class="org-src-container">
<pre class="src src-makefile">make
make install
</pre>
</div></li>
<li>copy install file to <code>rootfs</code></li>
<li><p>
execute qemu
</p>
<div class="org-src-container">
<pre class="src src-makefile">qemu-system-x86_64 \
-kernel ../linux-kernel/linux-stable/arch/x86/boot/bzImage \
-append <span class="org-string">"root=/dev/sda1 init=/linuxrc"</span> \
-drive file=kernel-dev.img,format=raw \
-gdb -tcp::<span class="org-highlight-numbers-number">1234</span> -S <span class="org-comment-delimiter"># </span><span class="org-comment">debug</span>
</pre>
</div></li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: yydcnjjw</p>
<p class="date">Created: 2019-04-07 日 22:31</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
