<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-04-08 一 21:25 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="yydcnjjw" />
<link rel="stylesheet" href="https://yydcnjjw.github.io/style/style.css" type="text/css">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3898d2a">1. libev</a></li>
<li><a href="#orgbbb7b49">2. leveldb</a>
<ul>
<li><a href="#org4bea774">2.1. leveldb file type</a></li>
<li><a href="#orgccd721d">2.2. Table format</a></li>
<li><a href="#orgc520bae">2.3. Log</a>
<ul>
<li><a href="#org92a6d0d">2.3.1. WriteBatch</a></li>
</ul>
</li>
<li><a href="#org269780b">2.4. Version Control</a>
<ul>
<li><a href="#orgb8df5ce">2.4.1. <code>VersionSet</code></a></li>
<li><a href="#org580c7a9">2.4.2. <code>Version</code></a></li>
</ul>
</li>
<li><a href="#orgd9013e9">2.5. MemTable</a></li>
<li><a href="#orgd69047c">2.6. Recover</a></li>
</ul>
</li>
<li><a href="#org816ba39">3. nginx</a>
<ul>
<li><a href="#org56db5ae">3.1. modules</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org3898d2a" class="outline-2">
<h2 id="org3898d2a"><span class="section-number-2">1</span> libev</h2>
</div>
<div id="outline-container-orgbbb7b49" class="outline-2">
<h2 id="orgbbb7b49"><span class="section-number-2">2</span> leveldb</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org4bea774" class="outline-3">
<h3 id="org4bea774"><span class="section-number-3">2.1</span> leveldb file type</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li><code>kLogFile(0)</code>: <code>".log"</code></li>
<li><code>kDBLockFile(1)</code>: <code>"LOCK"</code></li>
<li><code>kTableFile(2)</code>: <code>".sst" || ".ldb"</code></li>
<li><code>kDescriptorFile(3)</code>: <code>"MANIFEST-[0-9]+"</code></li>
<li><code>kCurrentFile(4)</code>: <code>"CURRENT"</code></li>
<li><code>kTempFile(5)</code>: <code>".dbtmp"</code></li>
<li><code>kInfoLogFile(6)</code>: <code>"LOG" || "LOG.old"</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgccd721d" class="outline-3">
<h3 id="orgccd721d"><span class="section-number-3">2.2</span> Table format</h3>
<div class="outline-text-3" id="text-2-2">
<pre class="example">
&lt;beginning_of_file&gt;
[data block 1]
[data block 2]
...
[data block N]
[meta block 1]
...
[meta block K]
[metaindex block]
[index block]
[Footer]        (fixed size; starts at file_size - sizeof(Footer))
&lt;end_of_file&gt;
</pre>

<!-- This HTML table template is generated by emacs 26.1 -->
<table border="1">
  <tr>
    <th colspan="3" align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;block&nbsp;header&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </th>
    <th align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;body&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </th>
    <th colspan="2" align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;block&nbsp;footer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </th>
    <th colspan="2" align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </th>
  </tr>
  <tr>
    <th align="left" valign="top">
      &nbsp;shared&nbsp;:&nbsp;varint32&nbsp;
    </th>
    <td align="left" valign="top">
      &nbsp;non_shared&nbsp;:&nbsp;varint32&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;value_size&nbsp;:&nbsp;varint32&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;key&nbsp;|&nbsp;&nbsp;value&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;restart&nbsp;pointer&nbsp;:&nbsp;uint32&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;restart&nbsp;size&nbsp;:&nbsp;uint32&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;type&nbsp;:&nbsp;uint8&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;crc&nbsp;:&nbsp;uint32&nbsp;
    </td>
  </tr>
</table>
<p>
block format:
</p>
<ul class="org-ul">
<li>block header:
<ul class="org-ul">
<li><code>shared</code>: The offset of the previous key and the current key equal part</li>
<li><code>non_shared</code>: key length - shared</li>
<li><code>value_size</code>: data size</li>
</ul></li>
<li>block footer:
<ul class="org-ul">
<li><code>restart_pointer</code>: multiple restart pointer(data block offset), when key-value counter more than <code>block_restart_interval(16)</code>, push pointer to <code>restarts_</code> that is a <code>vector&lt;uint32_t&gt;</code>.</li>
<li><code>restart_size</code>: vector length</li>
</ul></li>
<li>each flush:
<ul class="org-ul">
<li><code>type</code>: compression type</li>
<li><code>crc</code>:</li>
</ul></li>
</ul>

<p>
block type:
</p>
<ul class="org-ul">
<li>"data" block: The sequence of key/value pairs in the file are stored in sorted order and partitioned into a sequence of data blocks. And optionally compressed.
<ul class="org-ul">
<li><code>key</code>: According to <code>shared</code> and <code>non_shared</code> for storing. Only storing part of <code>non_shared</code>.</li>
<li><code>value</code> data value</li>
</ul></li>
<li>"filter" block</li>
<li>"meta" block: It contains one entry for every other meta block.
<ul class="org-ul">
<li><code>key</code> is the name of the meta block.</li>
<li><code>value</code> is a BlockHandle pointing to that meta block.</li>
</ul></li>
<li>"index" block: This block contains one entry per data block.
<ul class="org-ul">
<li><code>key</code> is a string &gt;= last key in that data block and before the first key in the successive data block.</li>
<li><code>value</code> is the BlockHandle for the data block.</li>
</ul></li>
<li><p>
footer
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">metaindex_offset : varint64</td>
<td class="org-left">metaindex_size : varint64</td>
<td class="org-left">index_offset : varint64</td>
<td class="org-left">index_size : varint64</td>
<td class="org-left">pad : max 40B</td>
<td class="org-left">table magic(<code>0xdb4775248b80fb57</code>)</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>

<div id="outline-container-orgc520bae" class="outline-3">
<h3 id="orgc520bae"><span class="section-number-3">2.3</span> Log</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Log is an recorded of header that leveldb writes data to <code>kLogFile</code> or <code>kDescriptorFile</code>
Log format: 
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> log header</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">checksum(4B)</td>
<td class="org-left">length(2B)</td>
<td class="org-left">type(1B)</td>
<td class="org-left">data</td>
</tr>
</tbody>
</table>

<p>
type: according to 
</p>
<ul class="org-ul">
<li><code>kZeroType</code> (0): for preallocated files</li>
<li><code>kFullType</code> (1)</li>
</ul>
<p>
For fragments:
</p>
<ul class="org-ul">
<li><code>kFirstType</code> (2)</li>
<li><code>kMiddleType</code> (3)</li>
<li><code>kLastType</code> (4)</li>
</ul>
</div>

<div id="outline-container-org92a6d0d" class="outline-4">
<h4 id="org92a6d0d"><span class="section-number-4">2.3.1</span> WriteBatch</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
<code>WriteBatch</code> header has an 8-byte sequence number followed by a 4-byte count.
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">log header</td>
<td class="org-left">sequence(8B)</td>
<td class="org-left">count(4B)</td>
<td class="org-left">value type(1B)</td>
<td class="org-left">key length</td>
<td class="org-left">key</td>
<td class="org-left">value length</td>
<td class="org-left">value</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><code>DBImpl::BuildBatchGroup</code>: build <code>WriteBatch</code> by merging multiple <code>writers</code>
<code>max_size = if first_batch_size &gt; 128KB ? 1MB : 128KB + first_batch_size</code></li>
<li><code>Db::Put()</code>
<ol class="org-ol">
<li>write log</li>
<li>cache to <code>MemTable</code></li>
</ol></li>
<li><code>DB::Get()</code>:
<ol class="org-ol">
<li>check mem table</li>
<li>check level file</li>
</ol></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org269780b" class="outline-3">
<h3 id="org269780b"><span class="section-number-3">2.4</span> Version Control</h3>
<div class="outline-text-3" id="text-2-4">
</div>
<div id="outline-container-orgb8df5ce" class="outline-4">
<h4 id="orgb8df5ce"><span class="section-number-4">2.4.1</span> <code>VersionSet</code></h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
<code>VersionSet</code> is a circular Doubly linked list
VersionSet include below information
</p>
<ul class="org-ul">
<li><code>kComparator(1)</code>: comparator name</li>
<li><code>kLognumber(2)</code>: log number</li>
<li><code>kNextfilenumber(3)</code>: next file number(file with number is unique)</li>
<li><code>kLastSequence(4)</code>: last sequence</li>
<li><code>kCompactpointer(5)</code>: compact pointer
Per-level key at which the next compaction at that level should start. Either an empty string, or a valid InternalKey.</li>
<li><code>kDeletedFile(6)</code>: deleted file</li>
<li><code>kNewFile(7)</code>: new file</li>
<li><code>kPrevLogNumber(9)</code>: previous log number</li>
</ul>
</div>

<ol class="org-ol">
<li><a id="orgb515518"></a><code>VersionSet::Recover</code><br />
<div class="outline-text-5" id="text-2-4-1-1">
<p>
Leveldb read <code>CURRENT</code> file for recovering VersionSet.
</p>
<ol class="org-ol">
<li>Read <code>CURRENT</code> file, which contains a pointer to the current manifest file.</li>
<li>Collect all <code>kLogFile</code> which file number more than current <code>kLognumber</code> or equal current <code>kPrevLogNumber</code>. Convert log chunk to a new level-0 <code>sstable</code>.
<ol class="org-ol">
<li>Read all the records and add to a mentable</li>
<li>call <code>WriteLevel0Table</code> if MemTable usage more than <code>write_buffer_size</code></li>
<li>add file to new file of <code>CURRENT VersionSet</code></li>
</ol></li>
</ol>

<p>
First VersionSet of db: <code>MANIFEST-000001</code> (no custom option)
</p>
<ul class="org-ul">
<li><code>kComparator</code>: <code>"leveldb.BytewiseComparator"</code></li>
<li><code>kLognumber</code>: 0</li>
<li><code>kNextFileNumber</code>: 2</li>
<li><code>kLastSequence</code>: 0</li>
</ul>

<p>
Second VersionSet of db: <code>MANIFEST-000002</code> (no custom option)
</p>
<ul class="org-ul">
<li><code>kComparator</code>: <code>"leveldb.BytewiseComparator"</code></li>
<li><code>kLognumber</code>: 3</li>
<li><code>kNextFileNumber</code>: 4</li>
<li><code>kLastSequence</code>: 0</li>
<li><code>kPrevLogNumber</code>: 0</li>
</ul>
</div>
</li>
</ol>
</div>

<div id="outline-container-org580c7a9" class="outline-4">
<h4 id="org580c7a9"><span class="section-number-4">2.4.2</span> <code>Version</code></h4>
<div class="outline-text-4" id="text-2-4-2">
<p>
Version control different type of file.
</p>
</div>
<ol class="org-ol">
<li><a id="orgb2a342c"></a><code>FileMetaData</code><br />
<div class="outline-text-5" id="text-2-4-2-1">
<div class="org-src-container">
<pre class="src src-C++"><span class="org-keyword">struct</span> <span class="org-type">FileMetaData</span> {
  <span class="org-type">int</span> <span class="org-variable-name">refs</span>;
  <span class="org-type">int</span> <span class="org-variable-name">allowed_seeks</span>;          <span class="org-comment-delimiter">// </span><span class="org-comment">Seeks allowed until compaction</span>
  <span class="org-type">uint64_t</span> <span class="org-variable-name">number</span>;
  <span class="org-type">uint64_t</span> <span class="org-variable-name">file_size</span>;         <span class="org-comment-delimiter">// </span><span class="org-comment">File size in bytes</span>
  <span class="org-type">InternalKey</span> <span class="org-variable-name">smallest</span>;       <span class="org-comment-delimiter">// </span><span class="org-comment">Smallest internal key served by table</span>
  <span class="org-type">InternalKey</span> <span class="org-variable-name">largest</span>;        <span class="org-comment-delimiter">// </span><span class="org-comment">Largest internal key served by table</span>

  <span class="org-function-name">FileMetaData</span>() : refs(<span class="org-highlight-numbers-number">0</span>), allowed_seeks(<span class="org-highlight-numbers-number">1</span> &lt;&lt; <span class="org-highlight-numbers-number">30</span>), file_size(<span class="org-highlight-numbers-number">0</span>) { }
};
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-orgd9013e9" class="outline-3">
<h3 id="orgd9013e9"><span class="section-number-3">2.5</span> MemTable</h3>
<div class="outline-text-3" id="text-2-5">
<p>
MemTable add format:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">key_size + 8 : varint32</td>
<td class="org-left">key bytes</td>
<td class="org-left">valueType(1B)</td>
<td class="org-left">sequenceNumber(7B)</td>
<td class="org-left">value_size : varint32</td>
<td class="org-left">value byte</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orgd69047c" class="outline-3">
<h3 id="orgd69047c"><span class="section-number-3">2.6</span> Recover</h3>
<div class="outline-text-3" id="text-2-6">
<ol class="org-ol">
<li>check option and sanitize options
<ul class="org-ul">
<li>rename <code>LOG</code> file to <code>LOG.OLD</code> and create a new "LOG" file</li>
</ul></li>
<li>create <code>LOCK</code> file for preventing concurrent access to the same db by multiple processes.</li>
<li><code>NewDB()</code>:
<ol class="org-ol">
<li>create <code>MANIFEST-000001</code> file</li>
<li>make <code>CURRENT</code> file that points to the new manifest file</li>
</ol></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org816ba39" class="outline-2">
<h2 id="org816ba39"><span class="section-number-2">3</span> nginx</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="http://aosabook.org/images/nginx/architecture.png">nginx architecture</a>
<a href="http://aosabook.org/en/nginx.html">http://aosabook.org/en/nginx.html</a>
</p>
</div>
<div id="outline-container-org56db5ae" class="outline-3">
<h3 id="org56db5ae"><span class="section-number-3">3.1</span> modules</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">// </span><span class="org-comment">src/core/ngx_module.h</span>
<span class="org-keyword">struct</span> <span class="org-type">ngx_module_s</span> {
    <span class="org-type">ngx_uint_t</span>            <span class="org-variable-name">ctx_index</span>;
    <span class="org-type">ngx_uint_t</span>            <span class="org-variable-name">index</span>;
    <span class="org-type">char</span>                 *<span class="org-variable-name">name</span>;
    <span class="org-type">ngx_uint_t</span>            <span class="org-variable-name">spare0</span>;
    <span class="org-type">ngx_uint_t</span>            <span class="org-variable-name">spare1</span>;
    <span class="org-type">ngx_uint_t</span>            <span class="org-variable-name">version</span>;
    <span class="org-keyword">const</span> <span class="org-type">char</span>           *<span class="org-variable-name">signature</span>;
    <span class="org-type">void</span>                 *<span class="org-variable-name">ctx</span>;
    <span class="org-type">ngx_command_t</span>        *<span class="org-variable-name">commands</span>;
    <span class="org-type">ngx_uint_t</span>            <span class="org-variable-name">type</span>;
    ngx_int_t           (*init_master)(<span class="org-type">ngx_log_t</span> *<span class="org-variable-name">log</span>);
    ngx_int_t           (*init_module)(<span class="org-type">ngx_cycle_t</span> *<span class="org-variable-name">cycle</span>);
    ngx_int_t           (*init_process)(<span class="org-type">ngx_cycle_t</span> *<span class="org-variable-name">cycle</span>);
    ngx_int_t           (*init_thread)(<span class="org-type">ngx_cycle_t</span> *<span class="org-variable-name">cycle</span>);
    <span class="org-type">void</span>                (*exit_thread)(<span class="org-type">ngx_cycle_t</span> *<span class="org-variable-name">cycle</span>);
    <span class="org-type">void</span>                (*exit_process)(<span class="org-type">ngx_cycle_t</span> *<span class="org-variable-name">cycle</span>);
    <span class="org-type">void</span>                (*exit_master)(<span class="org-type">ngx_cycle_t</span> *<span class="org-variable-name">cycle</span>);
    <span class="org-type">uintptr_t</span>             <span class="org-variable-name">spare_hook0</span>;
    <span class="org-type">uintptr_t</span>             <span class="org-variable-name">spare_hook1</span>;
    <span class="org-type">uintptr_t</span>             <span class="org-variable-name">spare_hook2</span>;
    <span class="org-type">uintptr_t</span>             <span class="org-variable-name">spare_hook3</span>;
    <span class="org-type">uintptr_t</span>             <span class="org-variable-name">spare_hook4</span>;
    <span class="org-type">uintptr_t</span>             <span class="org-variable-name">spare_hook5</span>;
    <span class="org-type">uintptr_t</span>             <span class="org-variable-name">spare_hook6</span>;
    <span class="org-type">uintptr_t</span>             <span class="org-variable-name">spare_hook7</span>;
};
<span class="org-comment-delimiter">// </span><span class="org-comment">src/core/ngx_core.h</span>
<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-type">ngx_module_s</span>          <span class="org-type">ngx_module_t</span>;
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: yydcnjjw</p>
<p class="date">Created: 2019-04-08 一 21:25</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
